<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Nimble Shred v37.0 (Master)</title>
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiTmltYmxlIFNocmVkIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxMjEyMTIiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzFlMWUxZSIsImljb25zIjpbeyJzcmMiOiJodHRwczovL2ltZy5pY29uczguY29tL2ZsdWVuY3kvOTYvbnVsbC9kdW1iYmVsbC5wbmciLCJzaXplcyI6Ijk2eDk2IiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/null/dumbbell.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --primary: #BB86FC; --sec: #03DAC6; --text: #fff; --gold: #FFD700; --danger: #CF6679; --success: #00C853; --warn: #FF9800; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 120px; -webkit-tap-highlight-color: transparent; }
        
        /* Layout */
        .container { max-width: 600px; margin: 0 auto; display: none; padding-bottom: 80px; } 
        .container.active { display: block; }
        h1, h2 { text-align: center; margin: 10px 0; }
        
        /* Nav */
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; display: flex; justify-content: space-around; padding: 15px 10px; border-top: 1px solid #333; z-index: 9000; padding-bottom: max(15px, env(safe-area-inset-bottom)); box-shadow: 0 -5px 10px rgba(0,0,0,0.5); }
        .nav-btn { background: none; color: #777; border: none; font-size: 0.75em; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .nav-btn.active { color: var(--sec); }
        .nav-icon { font-size: 1.5em; }
        
        /* UI Elements */
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); position: relative; }
        .btn { display: block; width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-main { background: var(--sec); color: #000; }
        .btn-action { background: var(--primary); color: #000; }
        .btn-danger { background: var(--danger); color: #fff; }
        input, select, textarea { width: 100%; padding: 10px; background: #2c2c2c; border: 1px solid #444; border-radius: 6px; color: #fff; font-size: 16px; box-sizing: border-box; }
        .row { display: flex; gap: 10px; align-items: center; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .unit-toggle { background: #333; padding: 5px 12px; border-radius: 20px; font-size: 0.8em; border: 1px solid #555; color: #aaa; cursor: pointer; }
        
        /* Filter Chips */
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .chip { padding: 6px 12px; background: #333; border: 1px solid #555; border-radius: 20px; font-size: 0.8em; cursor: pointer; color: #aaa; transition: 0.2s; }
        .chip.active { background: var(--primary); color: #000; border-color: var(--primary); font-weight: bold; }
        
        /* Exercise Cards */
        .exercise-card { border-left: 4px solid var(--primary); margin-bottom: 15px; }
        .exercise-card.Mobility { border-left-color: var(--sec); }
        .exercise-card.Strength { border-left-color: var(--danger); }
        .exercise-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .suggestion-text { color: var(--success); font-size: 0.85em; margin: 5px 0; font-style: italic; display: flex; align-items: center; gap: 5px; }
        
        /* Guide Modal Styles */
        .guide-section { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .guide-label { color: var(--gold); font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: block; }
        .guide-val { font-size: 1.1em; color: #fff; }
        .step-list { padding-left: 20px; color: #ddd; line-height: 1.5; }
        .step-list li { margin-bottom: 8px; }
        
        /* Overlays */
        .fs-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 10000; padding: 20px; overflow-y: auto; box-sizing: border-box; display: none; }
        .fs-overlay.flex-center { display: none; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.95); }
        .hidden { display: none !important; }
        #sync-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; z-index: 20000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        
        /* Macros & Misc */
        .macro-bar-container { background: #333; height: 12px; border-radius: 6px; margin-top: 5px; overflow: hidden; position: relative; }
        .macro-fill { height: 100%; transition: width 0.5s; }
        .macro-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; text-align: center; font-size: 0.85em; }
        .gif-input { width: 100%; padding: 5px; background: #111; border: 1px solid #444; color: #fff; border-radius: 4px; margin-top: 5px; margin-bottom: 5px; font-size: 0.8em; }
        .btn-guide { background: #333; color: #aaa; border: 1px solid #444; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; cursor: pointer; }
        .btn-sm { padding: 5px 10px; font-size: 0.8em; width: auto; display: inline-block; margin-top: 5px; }
        .mic-btn { background: #333; border: 1px solid #555; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2em; cursor: pointer; }
        .meal-section { border-top: 1px solid #333; margin-top: 15px; padding-top: 10px; }
        .meal-header { font-weight: bold; color: var(--gold); display: flex; justify-content: space-between; margin-bottom: 5px; }
        .food-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #2a2a2a; font-size: 0.9em; cursor: pointer; }
        .source-switch { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; font-size: 0.9em; }
        .source-opt { cursor: pointer; padding: 5px 10px; border-radius: 5px; border: 1px solid #333; color: #777; }
        .source-opt.active { background: var(--primary); color: #000; border-color: var(--primary); font-weight: bold; }
        
        /* Floating Timer */
        .timer-badge { position: fixed; bottom: 80px; right: 20px; background: var(--danger); color: #fff; padding: 15px; border-radius: 50%; width: 60px; height: 60px; display: none; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; box-shadow: 0 4px 8px rgba(0,0,0,0.5); z-index: 8000; cursor: pointer; }
        .timer-badge.active { display: flex; animation: timerPulse 1s infinite; }
        @keyframes timerPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    </style>
</head>
<body>

<div id="sync-loader">
    <div style="font-size:3em; margin-bottom:20px;">‚òÅÔ∏è</div>
    <h3>Syncing with Cloud...</h3>
    <small style="color:#777; margin-top:10px;">Checking History, Foods & GIFs</small>
</div>

<div id="timer-badge" class="timer-badge" onclick="openTimerOverlay()"></div>

<div class="container active" id="view-readiness">
    <div class="top-bar"><h2>Daily Check-In</h2><button class="unit-toggle" onclick="toggleUnit()"><span id="unit-disp-1">LBS</span></button></div>
    <div class="card" style="display:flex; justify-content:space-between; align-items:center; background: linear-gradient(45deg, #1e1e1e, #252525);">
        <div><div style="font-size:0.8em; color:#aaa;">Current Streak</div><div style="font-size:1.5em; font-weight:bold;">üî• <span id="streak-count">0</span> Days</div></div>
        <div id="readiness-badge" style="font-size:2em;">üõ°Ô∏è</div>
    </div>
    <div class="card">
        <h3>How are you feeling?</h3>
        <div class="row" style="margin-top:10px;"><span>üò¥ Sleep</span> <input type="range" id="val-sleep" min="1" max="10" value="5" oninput="calcReadiness()"></div>
        <div class="row" style="margin-top:15px;"><span>ü§ï Pain</span> <input type="range" id="val-sore" min="1" max="10" value="5" oninput="calcReadiness()"></div>
        <div class="row" style="margin-top:15px;"><span>‚ö° Energy</span> <input type="range" id="val-mood" min="1" max="10" value="5" oninput="calcReadiness()"></div>
        <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
        <div class="row"><input type="number" id="garmin-score" placeholder="Garmin Body Battery (Optional)" oninput="calcReadiness()"></div>
        <div style="text-align:center; margin-top:15px;"><div style="font-size:2.5em; font-weight:bold; color:var(--sec);" id="score-display">--</div><div style="color:#aaa; font-style:italic;" id="score-text">Move sliders to calculate</div></div>
        <button type="button" class="btn btn-main" onclick="handleReadinessLog()" style="margin-top:15px;">üíæ Log & Get Advice</button>
    </div>
</div>

<div class="container" id="view-coach">
    <div id="setup-panel">
        <div class="top-bar"><h2>Workout Strategy</h2><button class="unit-toggle" onclick="toggleUnit()"><span id="unit-disp-2">LBS</span></button></div>
        <div class="card">
            <h3>Quick Start</h3>
            <div class="chip-container">
                <div class="chip" onclick="loadTemplate('push')">Push</div>
                <div class="chip" onclick="loadTemplate('pull')">Pull</div>
                <div class="chip" onclick="loadTemplate('legs')">Legs</div>
                <div class="chip" onclick="loadTemplate('full')">Full Body</div>
                <div class="chip" onclick="loadTemplate('f9')">Torque F9 Only</div>
            </div>
            <button type="button" class="btn btn-main" onclick="generateRandomWorkout()">üé≤ Random F9 Workout</button>
            <button type="button" class="btn btn-action" onclick="openBuilder()">üõ†Ô∏è Build Custom</button>
        </div>
    </div>
    <div id="active-workout" class="hidden">
        <div class="top-bar"><h3>Active Session</h3><button type="button" class="btn-danger" style="width:auto; padding:5px 10px;" onclick="cancelWorkout()">End</button></div>
        <div id="workout-list"></div>
        <button type="button" class="btn btn-action" onclick="openBuilder(true)">‚ûï Add Exercise</button>
        <button type="button" class="btn btn-main" onclick="finishSession()">üíæ Finish & Save</button>
    </div>
</div>

<div class="container" id="view-food">
    <div class="top-bar"><h2>Fuel Log</h2></div>
    <div class="card">
        <div class="macro-grid">
            <div>üî• <span id="disp-cals">0</span><div class="macro-bar-container"><div id="bar-cals" class="macro-fill" style="width:0%; background:var(--sec);"></div></div></div>
            <div>ü•© <span id="disp-pro">0</span>g<div class="macro-bar-container"><div id="bar-pro" class="macro-fill" style="width:0%; background:var(--primary);"></div></div></div>
            <div>üçö <span id="disp-carb">0</span>g<div class="macro-bar-container"><div id="bar-carb" class="macro-fill" style="width:0%; background:var(--warn);"></div></div></div>
            <div>ü•ë <span id="disp-fat">0</span>g<div class="macro-bar-container"><div id="bar-fat" class="macro-fill" style="width:0%; background:var(--danger);"></div></div></div>
        </div>
    </div>
    <div class="card">
        <div class="source-switch">
            <div id="src-usda" class="source-opt active" onclick="setSearchSource('usda')">USDA</div>
            <div id="src-off" class="source-opt" onclick="setSearchSource('off')">OpenFoodFacts</div>
        </div>
        <div class="row"><input type="text" id="food-search" placeholder="Search Food..."><button class="btn-action" style="width:auto;" onclick="searchFood()">üîé</button></div>
        <div id="search-results" style="margin-top:10px; max-height:200px; overflow-y:auto;"></div>
    </div>
    <div class="card" id="meal-container"></div>
</div>

<div class="container" id="view-wellness">
    <h2>Wellness</h2>
    <div class="card"><h3>‚öñÔ∏è Body Weight</h3><div class="row"><input type="number" id="body-weight" placeholder="Lbs"><button class="btn-action" onclick="saveBodyStat()">Log</button></div></div>
</div>

<div class="container" id="view-progress">
    <h2>Stats</h2>
    <div class="card"><select id="chart-select" onchange="renderChart()"><option>Select Exercise...</option></select><canvas id="progressChart"></canvas></div>
    <button class="btn btn-action" onclick="exportData()">‚¨áÔ∏è Export</button>
</div>

<div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('readiness')" id="nav-readiness"><span class="nav-icon">üîã</span>Daily</button>
    <button class="nav-btn" onclick="switchTab('coach')" id="nav-coach"><span class="nav-icon">üèãÔ∏è</span>Coach</button>
    <button class="nav-btn" onclick="switchTab('food')" id="nav-food"><span class="nav-icon">üçó</span>Fuel</button>
    <button class="nav-btn" onclick="switchTab('wellness')" id="nav-wellness"><span class="nav-icon">üßò</span>Wellness</button>
    <button class="nav-btn" onclick="switchTab('progress')" id="nav-progress"><span class="nav-icon">üìà</span>Stats</button>
</div>

<div id="readiness-modal" class="fs-overlay flex-center hidden">
    <div class="card" style="width:85%; max-width:350px; text-align:center;">
        <div id="readiness-icon" style="font-size:3em;">‚ö†Ô∏è</div>
        <h2 id="readiness-title">Recovery Mode</h2>
        <p id="readiness-desc" style="color:#aaa; margin-bottom:20px;">Low score detected.</p>
        <button class="btn btn-main" onclick="applyReadinessStrategy('modify')">üìâ Modify (Reduce Volume)</button>
        <button class="btn btn-action" onclick="applyReadinessStrategy('ignore')">üî• Ignore (Full Send)</button>
        <button class="btn btn-danger" style="margin-top:10px;" onclick="closeReadinessModal()">Cancel</button>
    </div>
</div>

<div id="guide-modal" class="fs-overlay hidden">
    <div class="top-bar"><h2 id="guide-title">Exercise Name</h2><button class="btn-danger" style="width:auto;" onclick="closeGuideModal()">Close</button></div>
    <div class="card">
        <div id="f9-setup-section" class="guide-section">
            <span class="guide-label">‚öôÔ∏è Torque F9 Setup</span>
            <div class="row">
                <div style="flex:1"><span style="color:#777;">Arms:</span> <span class="guide-val" id="guide-arms">--</span></div>
                <div style="flex:1"><span style="color:#777;">Pulleys:</span> <span class="guide-val" id="guide-pulleys">--</span></div>
            </div>
        </div>
        
        <div class="guide-section">
            <span class="guide-label">üìù Instructions</span>
            <ul class="step-list" id="guide-steps"></ul>
        </div>
        <div class="guide-section">
            <span class="guide-label">üí° Pro Tip</span>
            <div id="guide-cue" style="color:#fff; font-style:italic;">--</div>
        </div>
        
        <span class="guide-label">üé• Visual</span>
        <img id="guide-gif" src="" style="width:100%; border-radius:8px; display:none; margin-bottom:10px;">
        
        <div style="background:#252525; padding:10px; border-radius:8px; margin-top:10px;">
            <a id="gif-search-btn" href="#" target="_blank" class="btn-guide" style="display:block; text-align:center; text-decoration:none; margin-bottom:10px;">üîé Find on Google</a>
            <input type="text" id="guide-gif-input" class="gif-input" placeholder="Paste GIF URL here...">
            <button class="btn btn-action" style="margin-top:5px;" onclick="saveGuideGif()">üíæ Save to Cloud</button>
        </div>
    </div>
</div>

<div id="food-modal" class="fs-overlay flex-center hidden">
    <div class="card" style="width:85%; max-width:350px;">
        <h3>Adjust Portion</h3>
        <h4 id="food-modal-name" style="color:var(--primary);">Food Name</h4>
        
        <div class="row" style="margin:15px 0;">
            <div style="flex:1">
                <label style="font-size:0.8em; color:#aaa;">Qty</label>
                <input type="number" id="food-qty" value="1" step="0.25" oninput="updateFoodCalc()">
            </div>
            <div style="flex:2; text-align:right;">
                <div style="font-size:1.5em; font-weight:bold; color:var(--sec);"><span id="food-calc-cals">0</span> kcal</div>
                <div style="font-size:0.9em; color:#aaa;"><span id="food-calc-pro">0</span>g Pro</div>
            </div>
        </div>
        
        <label style="font-size:0.8em; color:#aaa; margin-bottom:5px; display:block;">Select Meal</label>
        <div class="row">
            <button class="btn-guide" onclick="selectMeal('Breakfast', this)">Breakfast</button>
            <button class="btn-guide" onclick="selectMeal('Lunch', this)">Lunch</button>
            <button class="btn-guide" onclick="selectMeal('Dinner', this)">Dinner</button>
            <button class="btn-guide" onclick="selectMeal('Snacks', this)">Snack</button>
        </div>
        
        <button class="btn btn-main" style="margin-top:15px;" onclick="confirmAddFood()">‚úÖ Add to Log</button>
        <button class="btn btn-danger" style="margin-top:10px;" onclick="closeFoodModal()">Cancel</button>
    </div>
</div>

<div id="builder-overlay" class="fs-overlay hidden">
    <div class="top-bar"><h2>Exercise Builder</h2><button class="btn-danger" style="width:auto;" onclick="closeBuilder()">Close</button></div>
    <div class="card">
        <label style="font-size:0.8em; color:#777;">Filters</label>
        <div class="chip-container" id="filter-muscle">
            <div class="chip" onclick="toggleFilter('muscle', 'Chest', this)">Chest</div>
            <div class="chip" onclick="toggleFilter('muscle', 'Back', this)">Back</div>
            <div class="chip" onclick="toggleFilter('muscle', 'Legs', this)">Legs</div>
            <div class="chip" onclick="toggleFilter('muscle', 'Shoulders', this)">Shoulders</div>
            <div class="chip" onclick="toggleFilter('muscle', 'Arms', this)">Arms</div>
            <div class="chip" onclick="toggleFilter('muscle', 'Core', this)">Core</div>
        </div>
        <div class="chip-container" id="filter-equip">
            <div class="chip active" onclick="toggleFilter('equip', 'Cable', this)">F9 Cable</div>
            <div class="chip" onclick="toggleFilter('equip', 'Dumbbell', this)">Dumbbell</div>
            <div class="chip" onclick="toggleFilter('equip', 'Bodyweight', this)">Bodyweight</div>
        </div>
        <input type="text" id="builder-search-inp" placeholder="Search..." onkeyup="filterBuilderList()">
        <div id="builder-list-content" style="margin-top:10px;"></div>
    </div>
</div>

<div id="timer-overlay" class="fs-overlay flex-center hidden">
    <div id="timer-display" style="font-size:4em; font-weight:bold; color:var(--primary);">00:00</div>
    <div style="margin-top:20px;">
        <button class="btn-danger" onclick="closeTimer()">Stop</button>
        <button class="btn-action" onclick="addTime(10)">+10s</button>
        <button class="btn-action" onclick="addTime(30)">+30s</button>
    </div>
</div>

<script>
    // --- GLOBAL ---
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrJx09CB_N0PO8FDTNbugokJK7CEHqJ4Zk3197Agcew_QNkMBZZ2C61vb53ctcna80dQ/exec";
    let state = { unit: 'lbs', history: [], food: [], wellness: [], readiness: [], routine: [] };
    let apiKey = "p61IM61sZf897clBskMhwLftfBccew4ZcgsatflX"; 
    let searchSource = "usda";
    let activeRoutine = [];
    let activeFilters = { muscle: [], equip: ['Cable'] }; 
    let pendingFood = null; 
    let selectedMeal = 'Snacks';
    let gifOverrides = {};
    let timerInterval = null;
    let timerSeconds = 0;
    let myChart = null;
    let currentGuideExercise = null;
    let modifyVolume = false;

    // --- FULL 162 EXERCISE DB ---
    const allExercises = [
      // CABLE CHEST
      {name: "Cable Chest Press", cat: ["Chest"], equip: "Cable", type: "Strength", setup: {arms: "Wide (Pos 8-9)", pulleys: "Chest Height"}, steps: ["Step forward", "Press"], cue: "Squeeze pecs"},
      {name: "Cable Chest Fly (High)", cat: ["Chest"], equip: "Cable", type: "Muscle Build", setup: {arms: "Wide", pulleys: "Top"}, steps: ["Lean forward", "Fly down"], cue: "Hug a tree"},
      {name: "Cable Chest Fly (Low)", cat: ["Chest"], equip: "Cable", type: "Muscle Build", setup: {arms: "Wide", pulleys: "Bottom"}, steps: ["Palms up", "Fly high"], cue: "Scoop up"},
      {name: "Cable Chest Fly (Mid)", cat: ["Chest"], equip: "Cable", type: "Muscle Build", setup: {arms: "Wide", pulleys: "Mid"}, steps: ["Fly center"], cue: "Squeeze middle"},
      {name: "Single Arm Cable Chest Press", cat: ["Chest"], equip: "Cable", type: "Strength", setup: {arms: "Standard", pulleys: "Chest"}, steps: ["One arm press"], cue: "Anti-rotation"},
      {name: "Cable Crossover", cat: ["Chest"], equip: "Cable", type: "Muscle Build", setup: {arms: "Wide", pulleys: "Top"}, steps: ["Cross hands at bottom"], cue: "Maximum squeeze"},
      {name: "Cable Pullover (Bench)", cat: ["Chest", "Lats"], equip: "Cable", type: "Muscle Build", setup: {arms: "Narrow", pulleys: "Mid"}, steps: ["Lie on bench", "Pull over head"], cue: "Stretch lats"},
      // CABLE BACK
      {name: "Lat Pulldown (Standing)", cat: ["Back"], equip: "Cable", type: "Strength", setup: {arms: "Top", pulleys: "Top"}, steps: ["Kneel down", "Pull to chest"], cue: "Elbows to pockets"},
      {name: "Seated Cable Row", cat: ["Back"], equip: "Cable", type: "Strength", setup: {arms: "Narrow", pulleys: "Low"}, steps: ["Sit on floor", "Row to waist"], cue: "Chest up"},
      {name: "Face Pulls", cat: ["Back", "Shoulders"], equip: "Cable", type: "Mobility", setup: {arms: "Narrow", pulleys: "Face"}, steps: ["Pull to forehead", "Rotate up"], cue: "Thumbs back"},
      {name: "Straight Arm Pulldown", cat: ["Back"], equip: "Cable", type: "Muscle Build", setup: {arms: "Top", pulleys: "Top"}, steps: ["Arms straight", "Push down"], cue: "Lats only"},
      {name: "Single Arm Cable Row", cat: ["Back"], equip: "Cable", type: "Strength", setup: {arms: "Mid", pulleys: "Mid"}, steps: ["Row one arm", "Rotate torso"], cue: "Reach and pull"},
      {name: "Cable Shrugs", cat: ["Back", "Traps"], equip: "Cable", type: "Muscle Build", setup: {arms: "Low", pulleys: "Low"}, steps: ["Shrug up"], cue: "Touch ears"},
      {name: "Cable Rear Delt Fly", cat: ["Back", "Shoulders"], equip: "Cable", type: "Muscle Build", setup: {arms: "Wide", pulleys: "Eye"}, steps: ["Cross cables", "Pull apart"], cue: "Touch walls"},
      {name: "Cable Y-Raise", cat: ["Back", "Shoulders"], equip: "Cable", type: "Mobility", setup: {arms: "Low", pulleys: "Low"}, steps: ["Raise into Y shape"], cue: "Lower traps"},
      {name: "High Row (Rope)", cat: ["Back"], equip: "Cable", type: "Strength", setup: {arms: "Top", pulleys: "Top"}, steps: ["Pull to chin"], cue: "High elbows"},
      // CABLE SHOULDERS
      {name: "Cable Overhead Press", cat: ["Shoulders"], equip: "Cable", type: "Strength", setup: {arms: "Wide", pulleys: "Low"}, steps: ["Press up"], cue: "Biceps by ears"},
      {name: "Cable Lateral Raise", cat: ["Shoulders"], equip: "Cable", type: "Muscle Build", setup: {arms: "Low", pulleys: "Low"}, steps: ["Cross cables", "Raise to side"], cue: "Pour pitcher"},
      {name: "Cable Front Raise", cat: ["Shoulders"], equip: "Cable", type: "Muscle Build", setup: {arms: "Low", pulleys: "Low"}, steps: ["Raise front"], cue: "Control down"},
      {name: "Cable Upright Row", cat: ["Shoulders", "Traps"], equip: "Cable", type: "Muscle Build", setup: {arms: "Low", pulleys: "Low"}, steps: ["Pull to chin"], cue: "Elbows high"},
      {name: "Cable External Rotation", cat: ["Shoulders"], equip: "Cable", type: "Mobility", setup: {arms: "Mid", pulleys: "Mid"}, steps: ["Rotate out"], cue: "Pinned elbow"},
      {name: "Cable Internal Rotation", cat: ["Shoulders"], equip: "Cable", type: "Mobility", setup: {arms: "Mid", pulleys: "Mid"}, steps: ["Rotate in"], cue: "Pinned elbow"},
      // CABLE ARMS
      {name: "Tricep Pushdown (Rope)", cat: ["Arms", "Triceps"], equip: "Cable", type: "Muscle Build", setup: {arms: "Top", pulleys: "Top"}, steps: ["Push down", "Spread rope"], cue: "Lock elbows"},
      {name: "Tricep Pushdown (Bar)", cat: ["Arms", "Triceps"], equip: "Cable", type: "Muscle Build", setup: {arms: "Top", pulleys: "Top"}, steps: ["Push down"], cue: "Lock elbows"},
      {name: "Overhead Cable Extension", cat: ["Arms", "Triceps"], equip: "Cable", type: "Muscle Build", setup: {arms: "Mid", pulleys: "Mid"}, steps: ["Lean forward", "Extend over head"], cue: "Stretch tricep"},
      {name: "Cable Kickback", cat: ["Arms", "Triceps"], equip: "Cable", type: "Muscle Build", setup: {arms: "Low", pulleys: "Low"}, steps: ["Extend back"], cue: "Squeeze"},
      {name: "Cable Bicep Curl", cat: ["Arms", "Biceps"], equip: "Cable", type: "Muscle Build", setup: {arms: "Low", pulleys: "Low"}, steps: ["Curl up"], cue: "Squeeze pinkies"},
      {name: "Cable Hammer Curl", cat: ["Arms", "Biceps"], equip: "Cable", type: "Muscle Build", setup: {arms: "Low", pulleys: "Low"}, steps: ["Neutral grip curl"], cue: "Forearms"},
      {name: "Bayesian Curl", cat: ["Arms", "Biceps"], equip: "Cable", type: "Muscle Build", setup: {arms: "Low", pulleys: "Low"}, steps: ["Face away", "Curl"], cue: "Long head"},
      {name: "Reverse Grip Pushdown", cat: ["Arms", "Triceps"], equip: "Cable", type: "Muscle Build", setup: {arms: "Top", pulleys: "Top"}, steps: ["Palms up push"], cue: "Control"},
      // CABLE LEGS
      {name: "Cable Squat", cat: ["Legs"], equip: "Cable", type: "Strength", setup: {arms: "Low", pulleys: "Low"}, steps: ["Hold at shoulders", "Squat"], cue: "Chest up"},
      {name: "Cable Pull-Through", cat: ["Legs", "Glutes"], equip: "Cable", type: "Strength", setup: {arms: "Low", pulleys: "Low"}, steps: ["Face away", "Hinge hips"], cue: "Push butt back"},
      {name: "Cable RDL", cat: ["Legs", "Hamstrings"], equip: "Cable", type: "Strength", setup: {arms: "Low", pulleys: "Low"}, steps: ["Hinge hips"], cue: "Stretch hams"},
      {name: "Cable Lunge", cat: ["Legs"], equip: "Cable", type: "Strength", setup: {arms: "Low", pulleys: "Low"}, steps: ["Hold handles", "Lunge"], cue: "Knee stability"},
      {name: "Cable Kickback (Glute)", cat: ["Legs", "Glutes"], equip: "Cable", type: "Muscle Build", setup: {arms: "Low", pulleys: "Low"}, steps: ["Kick back"], cue: "Squeeze glute"},
      {name: "Cable Abductor", cat: ["Legs", "Glutes"], equip: "Cable", type: "Mobility", setup: {arms: "Low", pulleys: "Low"}, steps: ["Leg out side"], cue: "Outer glute"},
      {name: "Cable Adductor", cat: ["Legs"], equip: "Cable", type: "Mobility", setup: {arms: "Low", pulleys: "Low"}, steps: ["Leg across"], cue: "Inner thigh"},
      {name: "Cable Calf Raise", cat: ["Legs", "Calves"], equip: "Cable", type: "Muscle Build", setup: {arms: "Low", pulleys: "Low"}, steps: ["Raise toes"], cue: "High squeeze"},
      // CABLE CORE
      {name: "Cable Crunch", cat: ["Core"], equip: "Cable", type: "Muscle Build", setup: {arms: "Top", pulleys: "Top"}, steps: ["Kneel", "Curl down"], cue: "Ribs to hips"},
      {name: "Woodchopper (High to Low)", cat: ["Core"], equip: "Cable", type: "Mobility", setup: {arms: "Top", pulleys: "Top"}, steps: ["Rotate down"], cue: "Core twist"},
      {name: "Woodchopper (Low to High)", cat: ["Core"], equip: "Cable", type: "Mobility", setup: {arms: "Low", pulleys: "Low"}, steps: ["Rotate up"], cue: "Core twist"},
      {name: "Pallof Press", cat: ["Core"], equip: "Cable", type: "Strength", setup: {arms: "Mid", pulleys: "Mid"}, steps: ["Press out", "Hold"], cue: "Anti-rotation"},
      {name: "Cable Side Bend", cat: ["Core"], equip: "Cable", type: "Mobility", setup: {arms: "Low", pulleys: "Low"}, steps: ["Lean side"], cue: "Obliques"},
      // DUMBBELL
      {name: "Dumbbell Bench Press", cat: ["Chest"], equip: "Dumbbell", type: "Strength", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Press up"], cue: "Drive feet"},
      {name: "Dumbbell Incline Press", cat: ["Chest"], equip: "Dumbbell", type: "Strength", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Incline press"], cue: "Upper chest"},
      {name: "Dumbbell Fly", cat: ["Chest"], equip: "Dumbbell", type: "Muscle Build", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Fly open"], cue: "Stretch"},
      {name: "Dumbbell Shoulder Press", cat: ["Shoulders"], equip: "Dumbbell", type: "Strength", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Press up"], cue: "Core tight"},
      {name: "Arnold Press", cat: ["Shoulders"], equip: "Dumbbell", type: "Strength", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Rotate and press"], cue: "Smooth rotation"},
      {name: "Lateral Raise", cat: ["Shoulders"], equip: "Dumbbell", type: "Muscle Build", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Raise side"], cue: "Lead with elbows"},
      {name: "Front Raise", cat: ["Shoulders"], equip: "Dumbbell", type: "Muscle Build", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Raise front"], cue: "Control"},
      {name: "Dumbbell Row", cat: ["Back"], equip: "Dumbbell", type: "Strength", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Row back"], cue: "Elbow back"},
      {name: "Dumbbell Pullover", cat: ["Back"], equip: "Dumbbell", type: "Muscle Build", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Pull over"], cue: "Lats stretch"},
      {name: "Goblet Squat", cat: ["Legs"], equip: "Dumbbell", type: "Strength", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Hold chest", "Squat"], cue: "Deep"},
      {name: "Dumbbell Lunge", cat: ["Legs"], equip: "Dumbbell", type: "Strength", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Step lunge"], cue: "Knee tracking"},
      {name: "Bulgarian Split Squat", cat: ["Legs"], equip: "Dumbbell", type: "Strength", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Foot up", "Squat"], cue: "Painful but good"},
      {name: "Romanian Deadlift (DB)", cat: ["Legs"], equip: "Dumbbell", type: "Strength", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Hinge"], cue: "Back flat"},
      {name: "Dumbbell Curl", cat: ["Arms", "Biceps"], equip: "Dumbbell", type: "Muscle Build", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Curl"], cue: "Squeeze"},
      {name: "Hammer Curl", cat: ["Arms"], equip: "Dumbbell", type: "Muscle Build", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Neutral curl"], cue: "Forearms"},
      {name: "Tricep Kickback", cat: ["Arms", "Triceps"], equip: "Dumbbell", type: "Muscle Build", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Kick back"], cue: "Lockout"},
      {name: "Skull Crusher (DB)", cat: ["Arms", "Triceps"], equip: "Dumbbell", type: "Muscle Build", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Lower to head"], cue: "Elbows in"},
      {name: "Farmers Walk", cat: ["Core", "Traps"], equip: "Dumbbell", type: "Strength", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Walk"], cue: "Tall posture"},
      // BODYWEIGHT
      {name: "Push-ups", cat: ["Chest"], equip: "Bodyweight", type: "Calisthenics", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Push floor"], cue: "Plank position"},
      {name: "Pull-ups", cat: ["Back"], equip: "Bodyweight", type: "Calisthenics", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Pull up"], cue: "Chest to bar"},
      {name: "Chin-ups", cat: ["Back"], equip: "Bodyweight", type: "Calisthenics", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Underhand pull"], cue: "Biceps"},
      {name: "Dips", cat: ["Chest"], equip: "Bodyweight", type: "Calisthenics", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Dip down"], cue: "90 degrees"},
      {name: "Bodyweight Squat", cat: ["Legs"], equip: "Bodyweight", type: "Calisthenics", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Squat"], cue: "Depth"},
      {name: "Lunge (BW)", cat: ["Legs"], equip: "Bodyweight", type: "Calisthenics", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Lunge"], cue: "Balance"},
      {name: "Glute Bridge", cat: ["Legs", "Glutes"], equip: "Bodyweight", type: "Calisthenics", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Hips up"], cue: "Squeeze"},
      {name: "Plank", cat: ["Core"], equip: "Bodyweight", type: "Calisthenics", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Hold"], cue: "Tight core"},
      {name: "Side Plank", cat: ["Core"], equip: "Bodyweight", type: "Calisthenics", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Hold side"], cue: "Hips high"},
      {name: "Mountain Climbers", cat: ["Core"], equip: "Bodyweight", type: "Calisthenics", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Run"], cue: "Fast"},
      {name: "Burpees", cat: ["Full Body"], equip: "Bodyweight", type: "Calisthenics", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Drop jump"], cue: "Explode"},
      {name: "Hanging Leg Raise", cat: ["Core"], equip: "Bodyweight", type: "Calisthenics", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Legs up"], cue: "Control"},
      {name: "Pike Push-up", cat: ["Shoulders"], equip: "Bodyweight", type: "Calisthenics", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Hips high push"], cue: "Shoulders"},
      {name: "Cat-Cow", cat: ["Core"], equip: "Bodyweight", type: "Mobility", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Flex spine"], cue: "Breathe"},
      {name: "Dead Bug", cat: ["Core"], equip: "Bodyweight", type: "Mobility", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Opposite limbs"], cue: "Flat back"},
      {name: "Thoracic Extension", cat: ["Back"], equip: "Bodyweight", type: "Mobility", setup: {arms: "N/A", pulleys: "N/A"}, steps: ["Roll back"], cue: "Relax"}
    ];

    const internalFoodDB = [
        {name:"Chicken Breast", c:165, p:31, f:3.6, ch:0}, 
        {name:"Rice (Cup)", c:200, p:4, f:0.4, ch:44},
        {name:"Egg", c:70, p:6, f:5, ch:0}, 
        {name:"Whey Scoop", c:120, p:24, f:1, ch:3},
        {name:"Banana", c:105, p:1, f:0, ch:27}, 
        {name:"Salmon", c:208, p:20, f:13, ch:0}
    ];

    // --- INIT ---
    window.onload = async () => {
        try {
            await syncFromCloud();
            state.unit = localStorage.getItem('nimbleUnit') || 'lbs';
            document.getElementById('unit-disp-1').innerText = state.unit.toUpperCase();
            document.getElementById('unit-disp-2').innerText = state.unit.toUpperCase();
            switchTab('readiness');
        } catch (e) { 
            console.log("Cloud sync failed/offline, loading local.");
            loadLocal();
            document.getElementById('sync-loader').style.display = 'none';
        }
    };

    async function syncFromCloud() {
        const res = await fetch(GOOGLE_SCRIPT_URL);
        const data = await res.json();
        if(data.history) localStorage.setItem('nimbleHistory', JSON.stringify(data.history));
        if(data.nutrition) localStorage.setItem('nimbleNutrition', JSON.stringify(data.nutrition));
        if(data.gifs) {
            let g = {};
            data.gifs.forEach(row => { if(row.key && row.value) g[row.key] = row.value; });
            localStorage.setItem('nimbleGifOverrides', JSON.stringify(g));
        }
        loadLocal();
        document.getElementById('sync-loader').style.opacity = 0;
        setTimeout(() => document.getElementById('sync-loader').style.display = 'none', 500);
    }

    function loadLocal() {
        state.history = JSON.parse(localStorage.getItem('nimbleHistory')) || [];
        state.food = JSON.parse(localStorage.getItem('nimbleNutrition')) || [];
        state.wellness = JSON.parse(localStorage.getItem('nimbleWellness')) || [];
        state.readiness = JSON.parse(localStorage.getItem('nimbleReadiness')) || [];
        gifOverrides = JSON.parse(localStorage.getItem('nimbleGifOverrides')) || {};
    }

    // --- FOOD ENGINE (RELAXED) ---
    function setSearchSource(src) {
        searchSource = src;
        document.getElementById('src-usda').classList.toggle('active', src === 'usda');
        document.getElementById('src-off').classList.toggle('active', src === 'off');
    }

    async function searchFood() {
        const query = document.getElementById('food-search').value;
        const resDiv = document.getElementById('search-results');
        resDiv.innerHTML = 'Searching...';
        
        let results = [];
        
        try {
            if (searchSource === 'usda') {
                const req = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?query=${query}&pageSize=10&api_key=${apiKey}`);
                const data = await req.json();
                if(data.foods) {
                    data.foods.forEach(f => {
                        const getNut = (id) => (f.foodNutrients.find(x => x.nutrientId === id) || {}).value || 0;
                        results.push({ name: f.description, c: getNut(208), p: getNut(203), f: getNut(204), ch: getNut(205) });
                    });
                }
            } else {
                const req = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${query}&search_simple=1&action=process&json=1&page_size=10`);
                const data = await req.json();
                if(data.products) {
                    data.products.forEach(p => {
                        results.push({
                            name: p.product_name,
                            c: p.nutriments['energy-kcal_100g'] || 0,
                            p: p.nutriments.proteins_100g || 0,
                            f: p.nutriments.fat_100g || 0,
                            ch: p.nutriments.carbohydrates_100g || 0
                        });
                    });
                }
            }
        } catch(e) { console.log(e); }
        
        // Always show fallback
        if (results.length === 0) results = [...internalFoodDB.filter(f => f.name.toLowerCase().includes(query.toLowerCase()))];
        
        resDiv.innerHTML = '';
        if (results.length === 0) resDiv.innerHTML = "No results found from API.";
        
        results.forEach(f => {
            const div = document.createElement('div');
            div.className = 'food-item';
            div.innerHTML = `<span>${f.name}</span> <small>${Math.round(f.c)} cal</small>`;
            div.onclick = () => openFoodModal(f);
            resDiv.appendChild(div);
        });
    }

    function openFoodModal(item) {
        pendingFood = item;
        document.getElementById('food-modal-name').innerText = item.name;
        document.getElementById('food-qty').value = 1;
        updateFoodCalc();
        document.getElementById('food-modal').classList.remove('hidden');
        document.getElementById('food-modal').style.display = 'flex';
    }

    function updateFoodCalc() {
        if (!pendingFood) return;
        const qty = parseFloat(document.getElementById('food-qty').value) || 0;
        document.getElementById('food-calc-cals').innerText = Math.round(pendingFood.c * qty);
        document.getElementById('food-calc-pro').innerText = Math.round(pendingFood.p * qty);
    }

    function selectMeal(meal, btn) {
        selectedMeal = meal;
        document.querySelectorAll('.btn-guide').forEach(b => b.style.borderColor = '#444');
        btn.style.borderColor = 'var(--primary)';
    }

    function confirmAddFood() {
        if (!pendingFood) return;
        const qty = parseFloat(document.getElementById('food-qty').value) || 1;
        
        const log = { 
            date: new Date().toLocaleDateString(), 
            meal: selectedMeal, 
            name: pendingFood.name,
            c: pendingFood.c * qty,
            p: pendingFood.p * qty,
            f: pendingFood.f * qty,
            ch: pendingFood.ch * qty
        };
        
        let cl = JSON.parse(localStorage.getItem('nimbleNutrition')) || [];
        cl.push(log);
        localStorage.setItem('nimbleNutrition', JSON.stringify(cl));
        sendToCloud('nutrition', log);
        
        closeFoodModal();
        renderMealLog();
        updateMacrosUI();
    }
    
    function closeFoodModal() {
        document.getElementById('food-modal').classList.add('hidden');
        document.getElementById('food-modal').style.display = 'none';
        pendingFood = null;
    }

    function renderMealLog() {
        const container = document.getElementById('meal-container');
        container.innerHTML = '';
        const today = new Date().toLocaleDateString();
        const logs = JSON.parse(localStorage.getItem('nimbleNutrition')) || [];
        const todaysLogs = logs.filter(l => l.date === today);
        
        let grandTotal = 0;
        let grandPro = 0;

        ['Breakfast', 'Lunch', 'Dinner', 'Snacks'].forEach(meal => {
            const items = todaysLogs.filter(l => l.meal === meal);
            const subtotal = items.reduce((sum, i) => sum + (i.c || 0), 0);
            grandTotal += subtotal;
            items.forEach(i => grandPro += (i.p || 0));
            
            let html = `<div class="meal-section">
                <div class="meal-header"><span>${meal}</span> <span>${Math.round(subtotal)} cal</span></div>`;
            items.forEach(i => {
                html += `<div class="food-item"><span>${i.name}</span> <small>${Math.round(i.c)}</small></div>`;
            });
            html += `</div>`;
            container.innerHTML += html;
        });
        
        document.getElementById('disp-cals').innerText = Math.round(grandTotal);
        document.getElementById('disp-pro').innerText = Math.round(grandPro);
        document.getElementById('bar-cals').style.width = Math.min(100, grandTotal/25) + '%';
        document.getElementById('bar-pro').style.width = Math.min(100, grandPro/2) + '%';
    }

    // --- READINESS & WORKOUT LOGIC ---
    function handleReadinessLog() {
        const g = document.getElementById('garmin-score').value;
        let score = g ? parseInt(g) : Math.round((parseInt(document.getElementById('val-sleep').value)*10 + parseInt(document.getElementById('val-mood').value)*10 + (10-parseInt(document.getElementById('val-sore').value))*10)/3);
        saveReadinessData(score);
        if (score < 40) {
            showReadinessModal("Recovery Mode", "‚ö†Ô∏è Low Readiness", "Your body needs rest. Modify intensity?");
        } else if (score < 70) {
            showReadinessModal("Maintenance", "‚ö° Moderate Readiness", "Good to go, but maybe not a PR day.");
        } else {
            alert("üöÄ Prime Condition! Go crush it.");
            switchTab('coach');
        }
    }

    function showReadinessModal(title, icon, desc) {
        document.getElementById('readiness-title').innerText = title;
        document.getElementById('readiness-desc').innerText = desc;
        document.getElementById('readiness-modal').classList.remove('hidden');
        document.getElementById('readiness-modal').style.display = 'flex';
    }

    function applyReadinessStrategy(strategy) {
        if (strategy === 'modify') {
            modifyVolume = true; 
            alert("üìâ Weights will be reduced by 20% today.");
        } else {
            modifyVolume = false;
        }
        closeReadinessModal();
        switchTab('coach');
    }

    function closeReadinessModal() {
        document.getElementById('readiness-modal').classList.add('hidden');
        document.getElementById('readiness-modal').style.display = 'none';
    }

    function loadTemplate(type) {
        let filter = [];
        if(type==='push') filter = ['Chest','Shoulders','Triceps'];
        if(type==='pull') filter = ['Back','Biceps'];
        if(type==='legs') filter = ['Legs'];
        if(type==='full') filter = ['Chest','Back','Legs'];
        if(type==='f9') return generateWorkoutByFilter(e => e.equip === 'Cable');
        if(type==='core') filter = ['Core','Mobility'];
        generateWorkoutByFilter(e => e.cat.some(c => filter.includes(c)));
    }

    function generateRandomWorkout() {
        const shuffled = [...allExercises].sort(() => 0.5 - Math.random());
        activeRoutine = shuffled.slice(0, 6);
        renderWorkout(activeRoutine);
        showWorkoutScreen();
    }

    function generateWorkoutByFilter(filterFn) {
        const pool = allExercises.filter(filterFn);
        if(pool.length === 0) return alert("No exercises found for criteria.");
        activeRoutine = pool.sort(() => 0.5 - Math.random()).slice(0, 6);
        renderWorkout(activeRoutine);
        showWorkoutScreen();
    }

    function showWorkoutScreen() {
        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('setup-panel').style.display = 'none';
        document.getElementById('active-workout').classList.remove('hidden');
        document.getElementById('active-workout').style.display = 'block';
    }

    function renderWorkout(exercises) {
        const list = document.getElementById('workout-list');
        list.innerHTML = '';
        const history = JSON.parse(localStorage.getItem('nimbleHistory')) || [];

        exercises.forEach((ex, i) => {
            const lastLog = history.filter(h => h.name === ex.name).sort((a,b) => new Date(b.date) - new Date(a.date))[0];
            let suggestion = "New Exercise";
            let val = "";
            if (lastLog) {
                let targetWeight = lastLog.weight;
                if (modifyVolume) targetWeight = Math.round(targetWeight * 0.8);
                suggestion = `Beat: ${targetWeight}${state.unit} x ${lastLog.reps}`;
                val = targetWeight;
            }

            const div = document.createElement('div');
            div.className = `card exercise-card ${ex.type}`;
            div.innerHTML = `
                <div class="exercise-header">
                    <strong>${ex.name}</strong> 
                    <div style="display:flex; gap:5px;">
                        <span class="btn-guide" onclick="openGuideModal('${ex.name}')">üìò Guide</span>
                        <div class="mic-btn" onclick="startVoiceLog(this, ${i})">üé§</div>
                    </div>
                </div>
                <div class="suggestion-text">üí° ${suggestion}</div>
                <div class="row" style="margin-top:10px;">
                    <div style="flex:1"><input type="number" id="w-${i}" value="${val}" placeholder="Wt"></div>
                    <div style="flex:1"><input type="number" id="r-${i}" placeholder="Reps"></div>
                </div>
                <button type="button" class="btn btn-action" style="margin-top:10px; padding:5px;" onclick="logSet('${ex.name}', ${i})">‚úÖ Log Set</button>
            `;
            list.appendChild(div);
        });
    }

    function openGuideModal(exName) {
        const ex = allExercises.find(e => e.name === exName);
        if(!ex) return;
        currentGuideExercise = exName;
        document.getElementById('guide-title').innerText = ex.name;
        document.getElementById('guide-cue').innerText = ex.cue || "Focus on form.";
        
        // Setup Logic
        if (ex.equip === 'Cable') {
            document.getElementById('f9-setup-section').style.display = 'block';
            document.getElementById('guide-arms').innerText = ex.setup ? ex.setup.arms : "N/A";
            document.getElementById('guide-pulleys').innerText = ex.setup ? ex.setup.pulleys : "N/A";
        } else {
            document.getElementById('f9-setup-section').style.display = 'none';
        }

        const ul = document.getElementById('guide-steps');
        ul.innerHTML = "";
        if(ex.steps) ex.steps.forEach(s => ul.innerHTML += `<li>${s}</li>`);
        
        const gifUrl = gifOverrides[exName];
        const img = document.getElementById('guide-gif');
        if (gifUrl) { img.src = gifUrl; img.style.display = 'block'; } else { img.style.display = 'none'; }
        
        // Update Search Button Link
        const searchUrl = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(ex.name + ' exercise form gif')}`;
        document.getElementById('gif-search-btn').href = searchUrl;

        document.getElementById('guide-modal').classList.remove('hidden');
        document.getElementById('guide-modal').style.display = 'block';
    }

    function saveGuideGif() {
        const url = document.getElementById('guide-gif-input').value;
        if(!url) return;
        gifOverrides[currentGuideExercise] = url;
        localStorage.setItem('nimbleGifOverrides', JSON.stringify(gifOverrides));
        sendToCloud('gif', {name: currentGuideExercise, url: url});
        alert("GIF Saved!");
        openGuideModal(currentGuideExercise);
    }

    function closeGuideModal() {
        document.getElementById('guide-modal').classList.add('hidden');
        document.getElementById('guide-modal').style.display = 'none';
    }

    function logSet(name, idx) {
        const w = document.getElementById(`w-${idx}`).value;
        const r = document.getElementById(`r-${idx}`).value;
        if(w && r) {
            const entry = { date: new Date().toISOString(), name: name, weight: w, reps: r, unit: state.unit };
            let h = JSON.parse(localStorage.getItem('nimbleHistory')) || [];
            h.push(entry);
            localStorage.setItem('nimbleHistory', JSON.stringify(h));
            sendToCloud("workout", entry);
            startTimer(90);
            const btn = document.activeElement;
            btn.innerText = "Saved!";
            btn.style.backgroundColor = "var(--success)";
        }
    }

    // --- STANDARD UTILS ---
    function switchTab(id) {
        document.querySelectorAll('.container').forEach(d => d.classList.remove('active'));
        document.getElementById('view-' + id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('nav-' + id).classList.add('active');
        if(id === 'food') { renderMealLog(); updateMacrosUI(); }
        if(id === 'progress') renderChart();
    }
    
    function cancelWorkout() { if(confirm("Discard?")) { document.getElementById('active-workout').classList.add('hidden'); document.getElementById('active-workout').style.display='none'; document.getElementById('setup-panel').classList.remove('hidden'); document.getElementById('setup-panel').style.display='block'; } }
    function finishSession() { if(confirm("Save?")) { cancelWorkout(); alert("Saved!"); } }
    function factoryReset() { if(confirm("Reset?")) { localStorage.clear(); location.reload(); } }
    
    function startTimer(s) {
        document.getElementById('timer-overlay').classList.remove('hidden');
        document.getElementById('timer-overlay').style.display = 'flex';
        document.getElementById('timer-display').innerText = s;
        let t = s; clearInterval(timerInterval);
        timerInterval = setInterval(()=>{ t--; document.getElementById('timer-display').innerText = t; if(t<=0) closeTimer(); }, 1000);
    }
    function closeTimer() { document.getElementById('timer-overlay').classList.add('hidden'); document.getElementById('timer-overlay').style.display = 'none'; clearInterval(timerInterval); }
    function addTime(s) { startTimer(parseInt(document.getElementById('timer-display').innerText)+s); }
    function openTimerOverlay() { document.getElementById('timer-overlay').classList.remove('hidden'); document.getElementById('timer-overlay').style.display = 'flex'; }

    function openBuilder() { document.getElementById('builder-overlay').classList.remove('hidden'); document.getElementById('builder-overlay').style.display = 'block'; filterBuilderList(); }
    function closeBuilder() { document.getElementById('builder-overlay').classList.add('hidden'); document.getElementById('builder-overlay').style.display = 'none'; }
    function toggleFilter(type, val, el) {
        const index = activeFilters[type].indexOf(val);
        if (index > -1) activeFilters[type].splice(index, 1); else activeFilters[type].push(val);
        el.classList.toggle('active');
        filterBuilderList();
    }
    function filterBuilderList() {
        const q = document.getElementById('builder-search-inp').value.toLowerCase();
        const list = document.getElementById('builder-list-content');
        list.innerHTML = "";
        const filtered = allExercises.filter(ex => {
            const matchesSearch = ex.name.toLowerCase().includes(q);
            const matchesMuscle = activeFilters.muscle.length === 0 || ex.cat.some(c => activeFilters.muscle.includes(c));
            const matchesEquip = activeFilters.equip.length === 0 || activeFilters.equip.includes(ex.equip);
            return matchesSearch && matchesMuscle && matchesEquip;
        });
        filtered.forEach(ex => {
            const d = document.createElement('div');
            d.className = 'food-item';
            d.innerHTML = `<div><b>${ex.name}</b> <small style="color:#777">(${ex.equip})</small></div> <button type="button" class="btn-action" style="width:auto; padding:2px 8px;">+</button>`;
            d.onclick = () => { activeRoutine.push(ex); renderWorkout(activeRoutine); closeBuilder(); showWorkoutScreen(); };
            list.appendChild(d);
        });
    }

    function saveReadinessData(score) {
        const entry = { date: new Date().toISOString(), score: score };
        localStorage.setItem('nimbleReadiness', JSON.stringify([entry]));
        sendToCloud('readiness', entry);
    }
    function calcReadiness() {
        const g = document.getElementById('garmin-score').value;
        let score = g ? parseInt(g) : Math.round((parseInt(document.getElementById('val-sleep').value)*10 + parseInt(document.getElementById('val-mood').value)*10 + (10-parseInt(document.getElementById('val-sore').value))*10)/3);
        document.getElementById('score-display').innerText = score + '%';
        document.getElementById('score-display').style.color = score > 70 ? 'var(--success)' : 'var(--warn)';
    }
    
    function sendToCloud(type, data) { fetch(GOOGLE_SCRIPT_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ type: type, data: data }) }).catch(e=>console.log(e)); }
    function saveBodyStat() { const val = document.getElementById('body-weight').value; if(val) sendToCloud("wellness", {type:"weight", val: val}); alert("Logged"); }
    function toggleUnit() { state.unit = state.unit === 'lbs' ? 'kg' : 'lbs'; localStorage.setItem('nimbleUnit', state.unit); location.reload(); }
    
    function renderChart() {
        const ctx = document.getElementById('progressChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, { type:'line', data:{labels:['Jan','Feb','Mar'], datasets:[{label:'Demo Data', data:[100,110,115], borderColor:'#BB86FC'}]} });
    }
    function exportData() {
        const data = localStorage.getItem('nimbleHistory');
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'nimble_backup.json'; a.click();
    }
    function startVoiceLog() { alert("Use Chrome for Voice"); }
    function updateMacrosUI() {
        const today = new Date().toLocaleDateString();
        const logs = JSON.parse(localStorage.getItem('nimbleNutrition')) || [];
        const t = logs.filter(l => l.date === today).reduce((acc, l) => ({ c: acc.c+(l.c||0), p: acc.p+(l.p||0), f: acc.f+(l.f||0), ch: acc.ch+(l.ch||0) }), {c:0, p:0, f:0, ch:0});
        ['cals','pro','fat','carb'].forEach(k => {
            const val = Math.round(t[k==='cals'?'c':(k==='pro'?'p':(k==='fat'?'f':'ch'))]);
            document.getElementById('disp-'+k).innerText = val;
            document.getElementById('bar-'+k).style.width = Math.min(100, val/20) + '%'; 
        });
    }
</script>
</body>
</html>
