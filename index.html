<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Nimble Shred v62 - AI Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Load Supabase from backend proxy to bypass CDN blocks -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    // ==========================================
    // SUPABASE CLOUD SYNC CONFIGURATION
    // ==========================================
    // ‚úÖ Supabase library loaded via backend proxy (bypasses CDN blocks)
    // ‚úÖ Database tables created (workouts, training_plans, garmin_files, user_settings)
    // ‚úÖ gemini API Key stored securely in backend
    var SUPABASE_CONFIG = {
        url: 'https://wytyvtvmupsmtgjbcybc.supabase.co',
        anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5dHl2dHZtdXBzbXRnamJjeWJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MzA1MDAsImV4cCI6MjA4NTUwNjUwMH0.Qr1YFdN0QyZ-bLlKB5-LORpFBA2EhlHb-JcRKTYqnP0'
    };
    
    // Backend proxy URL - Vercel deployment
    var BACKEND_URL = 'https://nimble-shred-backend.vercel.app';
    
    // Supabase client and sync state
    var supabaseClient = null;
    var CLOUD_SYNC_ENABLED = false;
    var USER_ID = null;
    var LAST_SYNC_TIME = null;
    </script>
    <style>
        :root { 
            --bg: #121212; --card: #1e1e1e; --primary: #BB86FC; --sec: #03DAC6; 
            --text: #fff; --gold: #FFD700; --danger: #CF6679; --warn: #FF9800; 
            --success: #00C853; --push-color: #FF6B6B; --pull-color: #4ECDC4; 
            --legs-color: #95E1D3; --cardio-color: #3498db; --nimble-color: #9b59b6; 
            --rest-color: #555;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); color: var(--text); padding: 20px; 
            padding-bottom: 100px; -webkit-tap-highlight-color: transparent;
        }
        
        /* CONTAINERS */
        .container { max-width: 800px; margin: 0 auto; display: none; }
        .container.active { display: block; }
        .card { 
            background: var(--card); padding: 15px; border-radius: 12px; 
            margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); 
        }
        
        /* BUTTONS */
        .btn { 
            display: block; width: 100%; padding: 14px; border: none; 
            border-radius: 8px; font-weight: bold; cursor: pointer; 
            margin-top: 10px; font-size: 16px; transition: 0.2s; 
        }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-main { background: var(--sec); color: #000; }
        .btn-action { background: var(--primary); color: #000; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-small { 
            padding: 8px 12px; font-size: 0.85em; width: auto; 
            display: inline-block; margin: 5px; 
        }
        
        /* INPUTS */
        input, select, textarea { 
            width: 100%; padding: 10px; background: #2c2c2c; 
            border: 1px solid #444; border-radius: 6px; color: #fff; 
            font-size: 16px; margin: 5px 0;
        }
        #wizard-chat-input {
            width: 100%; margin: 0; min-height: 80px; resize: vertical;
            line-height: 1.4; font-size: 0.95em;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--sec); outline: none; 
        }
        
        /* LAYOUT */
        .row { display: flex; gap: 10px; align-items: center; }
        .row-wrap { display: flex; gap: 10px; flex-wrap: wrap; }
        
        /* NAVIGATION */
        .nav-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #1a1a1a; display: flex; justify-content: space-around; 
            padding: 12px 8px; border-top: 1px solid #333; z-index: 9000; 
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
        .nav-btn { 
            background: none; color: #777; border: none; font-size: 0.7em; 
            display: flex; flex-direction: column; align-items: center; 
            gap: 3px; cursor: pointer; padding: 5px; transition: 0.2s; flex: 1;
        }
        .nav-btn.active { color: var(--sec); }
        .nav-icon { font-size: 1.4em; }
        
        /* CHIPS */
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .chip { 
            padding: 8px 16px; background: #333; border: 2px solid #555; 
            border-radius: 20px; font-size: 0.85em; cursor: pointer; 
            color: #aaa; transition: all 0.2s; user-select: none;
        }
        .chip:hover { background: #444; border-color: var(--sec); }
        .chip.active { 
            background: var(--primary); color: #000; 
            border-color: var(--primary); font-weight: bold; 
        }
        
        /* PROGRESSIVE SETS */
        .exercise-card { 
            border-left: 4px solid var(--primary); 
            margin-bottom: 15px; position: relative; 
        }
        .set-completed { 
            background: linear-gradient(90deg, #1a4d2e 0%, #2d5f3d 100%); 
            padding: 10px; border-radius: 6px; margin: 5px 0; 
            border-left: 3px solid var(--success); 
            display: flex; justify-content: space-between;
        }
        .set-active { 
            background: #2c2c2c; padding: 12px; border-radius: 6px; 
            border: 2px solid var(--sec); margin: 8px 0; 
            box-shadow: 0 0 10px rgba(3,218,198,0.2);
        }
        .progression-badge { 
            background: var(--gold); color: #000; padding: 4px 8px; 
            border-radius: 12px; font-size: 0.75em; font-weight: bold; 
        }
        
        /* CALENDAR */
        .calendar-grid { 
            display: grid; grid-template-columns: repeat(7, 1fr); 
            gap: 8px; margin: 15px 0; 
        }
        .day-bubble { 
            background: #333; aspect-ratio: 1; border-radius: 12px; 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; cursor: pointer; border: 2px solid #444; 
            padding: 8px; position: relative; transition: all 0.3s;
        }
        .day-bubble:hover { transform: translateY(-2px); }
        .day-bubble .day-icon { font-size: 1.8em; margin-bottom: 4px; }
        .day-bubble .day-letter { font-weight: bold; font-size: 0.75em; }
        .day-bubble .day-type { font-size: 0.65em; color: #aaa; }
        .day-bubble .day-check { 
            position: absolute; top: 4px; right: 4px; font-size: 1em; 
        }
        
        /* Workout type colors */
        .day-bubble.workout-type-push { 
            border-color: var(--push-color); 
            background: rgba(255,107,107,0.1); 
        }
        .day-bubble.workout-type-pull { 
            border-color: var(--pull-color); 
            background: rgba(78,205,196,0.1); 
        }
        .day-bubble.workout-type-legs { 
            border-color: var(--legs-color); 
            background: rgba(149,225,211,0.1); 
        }
        .day-bubble.workout-type-cardio { 
            border-color: var(--cardio-color); 
            background: rgba(52,152,219,0.1); 
        }
        .day-bubble.workout-type-nimble { 
            border-color: var(--nimble-color); 
            background: rgba(155,89,182,0.1); 
        }
        .day-bubble.workout-type-rest { 
            border-color: var(--rest-color); 
            background: rgba(85,85,85,0.1); 
        }
        
        /* EXERCISE BUILDER */
        .exercise-list-item { 
            padding: 12px; margin: 5px 0; background: #2c2c2c; 
            border-radius: 6px; cursor: pointer; 
            border-left: 3px solid #555; transition: all 0.2s;
        }
        .exercise-list-item:hover { 
            background: #333; border-left-color: var(--primary); 
            transform: translateX(5px);
        }
        .exercise-list-item.selected { 
            background: rgba(187,134,252,0.2); 
            border-left-color: var(--primary); 
        }
        
        /* ENCYCLOPEDIA */
        .encyclopedia-section { 
            margin: 15px 0; padding: 15px; 
            background: #1a1a1a; border-radius: 8px; 
        }
        .encyclopedia-section h4 { 
            color: var(--sec); margin-bottom: 8px; 
            font-size: 0.9em; text-transform: uppercase; 
        }
        .encyclopedia-section ul { list-style: none; padding: 0; }
        .encyclopedia-section li { 
            padding: 5px 0 5px 20px; position: relative; 
        }
        .encyclopedia-section li:before { 
            content: '‚ñ∏'; position: absolute; left: 0; color: var(--sec); 
        }
        .muscle-badge { 
            display: inline-block; background: var(--primary); 
            color: #000; padding: 3px 8px; border-radius: 12px; 
            font-size: 0.75em; margin: 3px; font-weight: bold;
        }
        .gif-container { 
            background: #000; border-radius: 8px; padding: 15px; 
            margin: 15px 0; text-align: center; min-height: 200px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #333;
        }
        .gif-container img { 
            max-width: 100%; max-height: 300px; 
            border-radius: 6px; 
        }
        
        /* MODALS */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.95); z-index: 10000; 
            display: none; align-items: center; justify-content: center; 
            padding: 20px; overflow-y: auto;
        }
        .modal-overlay.active { display: flex; }
        .modal-content { 
            background: var(--card); border-radius: 12px; 
            padding: 20px; max-width: 600px; width: 100%; 
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .modal-header { 
            display: flex; justify-content: space-between; 
            align-items: center; margin-bottom: 20px; 
            padding-bottom: 15px; border-bottom: 2px solid #333;
        }
        .modal-close { 
            background: var(--danger); color: white; border: none; 
            padding: 8px 16px; border-radius: 6px; cursor: pointer; 
        }
        
        /* SLIDER */
        input[type="range"] { 
            width: 100%; height: 8px; border-radius: 5px; 
            background: #333; outline: none; -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb { 
            -webkit-appearance: none; width: 20px; height: 20px; 
            border-radius: 50%; background: var(--sec); cursor: pointer; 
        }
        
        /* GIF SEARCH */
        .gif-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 10px; 
            margin-top: 15px; 
        }
        .gif-item { 
            cursor: pointer; 
            border-radius: 8px; 
            overflow: hidden; 
            border: 2px solid transparent; 
            transition: all 0.2s; 
            aspect-ratio: 1;
        }
        .gif-item:hover { 
            border-color: var(--sec); 
            transform: scale(1.05); 
        }
        .gif-item img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        .gif-actions { 
            display: flex; 
            gap: 10px; 
            margin-top: 10px; 
        }
        
        /* GARMIN RECOVERY STYLES */
        .drop-zone {
            border: 3px dashed #007CC3;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            background: rgba(0,124,195,0.05);
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }
        .drop-zone:hover {
            border-color: #00ff9d;
            background: rgba(0,255,157,0.05);
            transform: scale(1.02);
        }
        .drop-zone.dragover {
            border-color: #00C853;
            background: rgba(0,255,157,0.1);
            transform: scale(1.05);
        }
        .recovery-score {
            font-size: 72px;
            font-weight: 700;
            font-family: monospace;
            text-align: center;
            margin: 30px 0;
            background: linear-gradient(135deg, #00ff9d, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .recovery-meter {
            height: 20px;
            background: #222;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .recovery-meter-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease-out;
            background: linear-gradient(90deg, #CF6679, #FF9800, #00C853);
        }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            background: rgba(255,255,255,0.03);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .metric-label {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            font-family: monospace;
            color: #00ff9d;
        }
        .ai-recommendation {
            background: linear-gradient(135deg, rgba(0,255,157,0.1), rgba(0,212,255,0.1));
            padding: 25px;
            border-radius: 16px;
            border-left: 4px solid #00ff9d;
            margin: 20px 0;
        }
        .ai-recommendation h3 {
            color: #00ff9d;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .workout-adjustment {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid #00d4ff;
        }
        .file-list { margin: 15px 0; }
        .file-item {
            background: rgba(255,255,255,0.05);
            padding: 10px 15px;
            border-radius: 8px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: monospace;
            font-size: 0.9em;
        }
        .file-item .file-name { color: #00ff9d; }
        .file-item .file-size { color: #888; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,255,157,0.3);
            border-radius: 50%;
            border-top-color: #00ff9d;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* NOTIFICATION SYSTEM */
        .daily-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            max-width: 400px;
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            border-left: 4px solid var(--primary);
            z-index: 9999;
            animation: slideInRight 0.3s ease-out;
            transition: opacity 0.3s, transform 0.3s;
        }
        .notification-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notification-body {
            padding: 15px;
            line-height: 1.6;
        }
        .notification-body ul {
            margin: 10px 0 0 20px;
            padding: 0;
        }
        .notification-actions {
            padding: 10px 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* GPS MAP */
        .gps-map { 
            width: 100%; 
            height: 300px; 
            background: #2c2c2c; 
            border-radius: 8px; 
            margin: 10px 0; 
            position: relative; 
            overflow: hidden; 
        }
        .gps-stats { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin: 10px 0; 
        }
        .gps-stat { 
            background: #2c2c2c; 
            padding: 12px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .gps-stat-value { 
            font-size: 1.5em; 
            font-weight: bold; 
            color: var(--sec); 
        }
        .gps-stat-label { 
            font-size: 0.8em; 
            color: #aaa; 
            margin-top: 5px; 
        }
        
        /* WARMUP SEQUENCE */
        .warmup-exercise { 
            background: #2c2c2c; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 10px 0; 
            border-left: 3px solid var(--warn); 
        }
        .warmup-timer { 
            font-size: 2em; 
            font-weight: bold; 
            color: var(--sec); 
            text-align: center; 
            margin: 10px 0; 
        }
        
        /* AI COACH */
        .ai-coach-card { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            padding: 15px; 
            border-radius: 12px; 
            margin: 15px 0; 
        }
        .ai-coach-card.warning { 
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
        }
        .ai-coach-card.success { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
        }
        
        /* UTILITIES */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-muted { color: #aaa; font-size: 0.85em; }
        .mb-10 { margin-bottom: 10px; }
        .mt-10 { margin-top: 10px; }
        
        /* ==========================================
           AI CHAT SYSTEM
           ========================================== */
        
        /* Chat Button - Floating bottom-right */
        #ai-chat-button {
            position: fixed;
            bottom: 90px; /* Above nav bar */
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 8999;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #ai-chat-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }
        #ai-chat-button:active {
            transform: scale(0.95);
        }
        #ai-chat-button.has-unread {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 4px 20px rgba(102, 126, 234, 0.8); }
        }
        
        /* Chat Panel */
        #ai-chat-panel {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 400px;
            height: 500px;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            display: none;
            flex-direction: column;
            z-index: 9000;
            overflow: hidden;
            animation: slideInUp 0.3s ease-out;
        }
        #ai-chat-panel.open {
            display: flex;
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Chat Header */
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 16px 16px 0 0;
        }
        .chat-header h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-minimize {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background 0.2s;
        }
        .chat-minimize:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Quick Actions */
        .chat-quick-actions {
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .quick-action-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .quick-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        /* Messages Container */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        /* Message Bubbles */
        .chat-message {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            animation: messageIn 0.3s ease-out;
        }
        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message.user {
            align-self: flex-end;
        }
        .chat-message.assistant {
            align-self: flex-start;
        }
        .message-bubble {
            padding: 10px 14px;
            border-radius: 16px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .chat-message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-message.assistant .message-bubble {
            background: #2c2c2c;
            color: #fff;
            border-bottom-left-radius: 4px;
        }
        .message-timestamp {
            font-size: 10px;
            color: #888;
            margin-top: 4px;
            padding: 0 4px;
        }
        .chat-message.user .message-timestamp {
            text-align: right;
        }
        .message-context {
            font-size: 10px;
            color: var(--primary);
            margin-bottom: 4px;
            padding: 0 4px;
        }
        
        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px 14px;
            background: #2c2c2c;
            border-radius: 16px;
            width: fit-content;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #888;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        
        /* Input Area */
        .chat-input-area {
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 8px;
        }
        .chat-input {
            flex: 1;
            background: #2c2c2c;
            border: 1px solid #444;
            border-radius: 20px;
            padding: 10px 15px;
            color: white;
            font-size: 14px;
            resize: none;
            max-height: 100px;
            min-height: 40px;
        }
        .chat-input:focus {
            border-color: var(--primary);
            outline: none;
        }
        .chat-send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: transform 0.2s;
        }
        .chat-send-btn:hover {
            transform: scale(1.1);
        }
        .chat-send-btn:active {
            transform: scale(0.95);
        }
        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            #ai-chat-button {
                bottom: 80px;
                right: 15px;
                width: 55px;
                height: 55px;
                font-size: 22px;
            }
            
            #ai-chat-panel.mobile-fullscreen {
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
                border-radius: 0;
                margin: 0;
            }
            
            #ai-chat-panel:not(.mobile-fullscreen) {
                width: calc(100vw - 30px);
                right: 15px;
                max-height: 70vh;
            }
            
            .chat-quick-actions {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            .chat-quick-actions::-webkit-scrollbar {
                display: none;
            }
        }
        
        /* Empty State */
        .chat-empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: #888;
        }
        .chat-empty-state .emoji {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .chat-empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #aaa;
        }
        .chat-empty-state p {
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>

<!-- TODAY'S BANNER -->
<div id="todays-banner" class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: none;">
    <h3 style="margin-bottom: 10px;">üìÖ <span id="today-date"></span></h3>
    <div style="font-size: 1.1em; margin-bottom: 15px;">
        Planned: <span id="today-workout"></span>
    </div>
    <button class="btn btn-main" onclick="startTodaysWorkout()">‚ñ∂Ô∏è Start Workout</button>
</div>

<!-- COACH PAGE -->
<div class="container active" id="view-coach">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2>üí™ Workout Coach</h2>
        <span style="font-size: 0.75em; color: #666; font-family: monospace;">v62</span>
    </div>
    
    <div class="card">
        <h3>Quick Start</h3>
        
        <div style="margin-bottom: 20px;">
            <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span>Exercises per workout:</span>
                <span style="color: var(--sec); font-weight: bold; font-size: 1.2em;" id="exercise-count-display">6</span>
            </label>
            <input 
                type="range" 
                id="exercise-count-slider" 
                min="4" 
                max="10" 
                value="6" 
                oninput="updateExerciseCount(this.value)"
                style="width: 100%;"
            >
            <div style="display: flex; justify-content: space-between; font-size: 0.75em; color: #888; margin-top: 4px;">
                <span>4 (Quick)</span>
                <span>10 (Full)</span>
            </div>
        </div>
        
        <div class="chip-container">
            <div class="chip" onclick="quickStartWorkout('push')">üí™ Push</div>
            <div class="chip" onclick="quickStartWorkout('pull')">üèãÔ∏è Pull</div>
            <div class="chip" onclick="quickStartWorkout('legs')">ü¶µ Legs</div>
            <div class="chip" onclick="quickStartWorkout('full')">üî• Full</div>
            <div class="chip" onclick="quickStartWorkout('nimble')">üßò Nimble</div>
        </div>
        <button class="btn btn-main" onclick="openCustomBuilder()">üõ†Ô∏è Custom Workout Builder</button>
        <button class="btn btn-action" onclick="generateRandomWorkout()">üé≤ Random Workout</button>
    </div>
    
    <div id="workout-interface" style="display:none;">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3>Active Session</h3>
            <button class="btn btn-danger btn-small" onclick="endWorkout()">End</button>
        </div>
        <div id="workout-list"></div>
    </div>
</div>

<!-- PLAN PAGE -->
<div class="container" id="view-plan">
    <h2>üìÖ Training Plan</h2>
    
    <div class="card" style="background: linear-gradient(135deg, rgba(187,134,252,0.1), rgba(3,218,198,0.1)); border: 2px solid var(--primary);">
        <h3>ü§ñ AI-Powered Planning</h3>
        <p style="margin-bottom: 15px; color: #888;">Let AI create a personalized training plan based on your goals, schedule, and recovery data.</p>
        <button class="btn btn-main" onclick="startAIPlanWizard()">
            ‚ú® Generate AI Plan
        </button>
    </div>
    
    <div class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom: 15px;">
            <div>
                <h3 id="phase-display">Week 1 - Foundation</h3>
                <div class="text-muted">
                    Adherence: <span id="adherence-display">0/6</span>
                </div>
            </div>
            <button class="btn-small btn-action" onclick="openPlanGenerator()">üîÑ New Plan</button>
        </div>
        <div class="calendar-grid" id="week-grid"></div>
        <button class="btn btn-action" onclick="toggleFullPlanView()" style="width:100%; margin-top:12px;">
            üìã View Full Plan Details
        </button>
    </div>
    
    <div id="full-plan-view" style="display:none;"></div>
    
    <div id="ai-coach-suggestions"></div>
</div>

<!-- CARDIO PAGE -->
<div class="container" id="view-cardio">
    <h2>üö¥ Cardio Tracking</h2>
    
    <div class="card">
        <h3>üìç Live GPS Tracking</h3>
        <p class="text-muted" style="margin-bottom:10px;">Track your run or bike ride with live GPS</p>
        <select id="gps-activity-type" style="margin-bottom:10px;">
            <option value="run">üèÉ Running</option>
            <option value="bike">üö¥ Cycling</option>
            <option value="walk">üö∂ Walking</option>
        </select>
        <button class="btn btn-success" onclick="startGpsTracking()">üìç Start GPS Tracking</button>
    </div>
    
    <div class="card">
        <h3>Quick Log Cardio</h3>
        <label>Type:</label>
        <select id="cardio-type">
            <option value="run">üèÉ Run</option>
            <option value="bike">üö¥ Bike</option>
            <option value="swim">üèä Swim</option>
            <option value="walk">üö∂ Walk</option>
            <option value="row">üö£ Row</option>
        </select>
        <label>Duration (minutes):</label>
        <input type="number" id="cardio-duration" value="30" min="5">
        <label>Distance (km) - optional:</label>
        <input type="number" id="cardio-distance" placeholder="e.g. 5.5" step="0.1">
        <button class="btn btn-main" onclick="logCardioSession()">üíæ Log Cardio</button>
    </div>
    
    <div class="card">
        <h3>Recent Cardio</h3>
        <div id="cardio-history"></div>
    </div>
</div>

<!-- SETTINGS PAGE -->
<div class="container" id="view-settings">
    <h2>‚öôÔ∏è Settings</h2>
    
    <div class="card" style="background: linear-gradient(135deg, rgba(0,124,195,0.1), rgba(0,212,255,0.1)); border: 2px solid #007CC3;">
        <h3>‚òÅÔ∏è Cloud Sync</h3>
        <p style="font-size: 0.9em; color: #888; margin-bottom: 15px;">
            Automatic cloud backup for workouts, plans, and Garmin data across all your devices.
        </p>
        <div style="margin-bottom: 10px;">
            <strong>Status:</strong> <span id="cloud-status-text">Initializing...</span>
        </div>
        <div style="margin-bottom: 10px;">
            <strong>Device ID:</strong> <span id="device-id-text" style="font-family: monospace; font-size: 0.85em;"></span>
        </div>
      <div id="cloud-sync-info" style="margin-top: 15px;">
            <p><strong>Last sync:</strong> <span id="last-sync-time">Never</span></p>
            <div style="margin-top: 10px;">
                <button class="btn btn-action" onclick="syncNow()">üîÑ Sync Now</button>
                <button class="btn btn-small" onclick="showSyncLog()">üìã View Log</button>
            </div>
            
            <div style="margin-top: 30px; padding-top: 30px; border-top: 1px solid #333;">
                <h3 style="color: var(--sec); margin-bottom: 15px;">
                    üèÉ Garmin Auto-Sync
                </h3>
                <p style="color: #888; font-size: 14px; margin-bottom: 20px;">
                    Automatically sync your Garmin activities, heart rate, and training data
                </p>
                
                <div style="background: rgba(187, 134, 252, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: bold;">Status:</span>
                        <span id="garmin-connection-status" style="font-weight: bold;">‚ùå Not Connected</span>
                    </div>
                    <div id="garmin-last-sync" style="font-size: 12px; color: #888; display: none;"></div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button 
                        id="garmin-connect-btn" 
                        class="btn btn-action" 
                        onclick="connectGarmin()"
                        style="flex: 1; min-width: 150px;">
                        üîó Connect Garmin
                    </button>
                    
                    <button 
                        id="garmin-sync-btn" 
                        class="btn btn-action" 
                        onclick="syncNow()"
                        style="flex: 1; min-width: 150px; display: none;">
                        üîÑ Sync Now
                    </button>
                    
                    <button 
                        id="garmin-disconnect-btn" 
                        class="btn" 
                        onclick="disconnectGarmin()"
                        style="flex: 1; min-width: 150px; display: none; background: var(--danger);">
                        ‚ùå Disconnect
                    </button>
                </div>
                
                <div style="margin-top: 15px; padding: 12px; background: rgba(3, 218, 198, 0.1); border-radius: 6px; font-size: 13px; color: #888;">
                    <strong style="color: var(--sec);">üí° How it works:</strong>
                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                        <li>Click "Connect Garmin" to authorize access</li>
                        <li>Activities sync automatically every hour</li>
                        <li>Click "Sync Now" for immediate sync</li>
                        <li>Your data stays private in your cloud database</li>
                    </ul>
                </div>
            </div>
        </div>
        <div style="margin-top: 15px; padding: 10px; background: rgba(3, 218, 198, 0.1); border-radius: 6px; font-size: 0.85em; border-left: 3px solid var(--sec);">
            <strong>‚úÖ Auto-Sync Enabled:</strong> All data automatically backed up to cloud after each workout.
        </div>
    </div>
    
    <div class="card">
        <h3>ü§ñ AI Coach</h3>
        <button class="btn btn-main" onclick="startAIPlanWizard()">‚ú® Generate New AI Plan</button>
        
        <div style="margin-top: 15px;">
            <label>Chat History Duration:</label>
            <select id="chat-history-days" onchange="saveChatSettings()">
                <option value="1">24 hours</option>
                <option value="7" selected>7 days</option>
                <option value="30">30 days</option>
            </select>
            <p class="text-muted" style="margin-top: 5px; font-size: 0.85em;">
                Messages older than this will be automatically deleted
            </p>
        </div>
        
        <div style="margin-top: 15px;">
            <label>
                <input type="checkbox" id="context-aware" checked onchange="saveChatSettings()">
                Context-aware responses (AI knows what page you're on)
            </label>
        </div>
        
        <div style="margin-top: 10px;">
            <label>
                <input type="checkbox" id="quick-actions-enabled" checked onchange="saveChatSettings()">
                Show quick action buttons in chat
            </label>
        </div>
        
        <div style="margin-top: 10px;">
            <label>
                <input type="checkbox" id="mobile-fullscreen" onchange="saveChatSettings()">
                Full-screen chat on mobile (default: floating panel)
            </label>
        </div>
        
        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button class="btn btn-action btn-small" onclick="toggleChatPanel()">üí¨ Open Chat</button>
            <button class="btn btn-danger btn-small" onclick="clearChatHistory()">üóëÔ∏è Clear History</button>
        </div>
    </div>
    
    <div class="card">
        <h3>üíæ Export & Backup</h3>
        <p style="font-size: 0.9em; color: #888; margin-bottom: 10px;">
            Download backups of your data (works even if Drive isn't connected)
        </p>
        <button class="btn btn-action" onclick="exportAllData()">üì¶ Export All Data</button>
        <button class="btn btn-action" onclick="exportWorkoutHistory()">üìä Export Workout History</button>
    </div>
    
    <div class="card">
        <h3>üèãÔ∏è Equipment Available</h3>
        <div id="equipment-presets"></div>
    </div>
    
    <div class="card">
        <h3>üîä Voice Coach</h3>
        <label>
            <input type="checkbox" id="voice-enabled" checked onchange="saveVoiceSettings()"> 
            Enable Voice
        </label>
        <label style="margin-top: 10px; display: block;">Level:</label>
        <select id="voice-level" onchange="saveVoiceSettings()">
            <option value="silent">Silent</option>
            <option value="countdown">Countdown Only</option>
            <option value="standard" selected>Standard</option>
            <option value="motivational">Motivational</option>
        </select>
        <button class="btn btn-action" onclick="testVoice()">üéµ Test Voice</button>
    </div>
    
    <div class="card">
        <h3>üíæ Backup Exercise Images</h3>
        <p class="text-muted" style="margin-bottom:10px;">
            Export your saved images to a file, so you can restore them if you clear browser data.
        </p>
        <button class="btn btn-success" onclick="exportImages()">üì• Export Images</button>
        <button class="btn btn-action" onclick="document.getElementById('import-file').click()">üì§ Import Images</button>
        <input type="file" id="import-file" accept=".json" onchange="importImages(event)" style="display:none;">
        <p class="text-muted" style="margin-top:10px; font-size:0.75em;">
            <strong>Tip:</strong> Store the exported file in your GitHub repo so you never lose your images!
        </p>
    </div>

</div>

<!-- ENCYCLOPEDIA PAGE -->
<div class="container" id="view-encyclopedia">
    <h2>üìö Exercise Encyclopedia</h2>
    
    <div class="card">
        <input type="text" id="encyclopedia-search" placeholder="Search exercises..." 
               onkeyup="searchEncyclopedia()" style="margin-bottom: 10px;">
        
        <label>Filter by:</label>
        <div class="chip-container">
            <div class="chip active" onclick="filterEncyclopedia('all')">All</div>
            <div class="chip" onclick="filterEncyclopedia('Chest')">Chest</div>
            <div class="chip" onclick="filterEncyclopedia('Back')">Back</div>
            <div class="chip" onclick="filterEncyclopedia('Legs')">Legs</div>
            <div class="chip" onclick="filterEncyclopedia('Shoulders')">Shoulders</div>
            <div class="chip" onclick="filterEncyclopedia('Arms')">Arms</div>
        </div>
        
        <label style="margin-top: 10px; display: block;">Equipment & Style:</label>
        <div class="chip-container">
            <div class="chip" onclick="filterEncyclopedia('Cable')">Cables</div>
            <div class="chip" onclick="filterEncyclopedia('Dumbbell')">Dumbbells</div>
            <div class="chip" onclick="filterEncyclopedia('Barbell')">Barbells</div>
            <div class="chip" onclick="filterEncyclopedia('Bodyweight')">Bodyweight</div>
        </div>
        
        <label style="margin-top: 10px; display: block; color: #9b59b6; font-weight: bold;">üíú 40+ Friendly:</label>
        <div class="chip-container">
            <div class="chip" onclick="filterEncyclopedia('Mobility')" style="border-color: #9b59b6;">üßò Mobility (36)</div>
            <div class="chip" onclick="filterEncyclopedia('Nimble')" style="border-color: #9b59b6;">ü§∏ Nimble (25)</div>
            <div class="chip" onclick="filterEncyclopedia('Calisthenics')" style="border-color: #9b59b6;">üí™ Calisthenics (41)</div>
            <div class="chip" onclick="filterEncyclopedia('Plyo')" style="border-color: #FF9800;">‚ö° Plyometric</div>
        </div>
    </div>
    
    <div id="encyclopedia-list"></div>
</div>

<!-- GARMIN RECOVERY CONTAINER -->
<div class="container" id="view-garmin">
    <div class="card" style="background: linear-gradient(135deg, rgba(0,124,195,0.1), rgba(0,212,255,0.1)); border: 2px solid #007CC3;">
        <h2 style="font-size: 2em; margin-bottom: 10px; background: linear-gradient(135deg, #00ff9d, #00d4ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            üèÉ Garmin AI Recovery Coach
        </h2>
        <p style="color: #888; margin-bottom: 30px;">Upload your Garmin data for AI-powered recovery analysis</p>
        
        <!-- UPLOAD ZONE -->
        <div class="drop-zone" id="dropZone">
            <div style="font-size: 3em; margin-bottom: 10px;">üìä</div>
            <h3>Drop Garmin CSV Files Here</h3>
            <p style="color: #888; margin-top: 10px;">or click to browse</p>
            <input type="file" id="fileInput" multiple accept=".csv" style="display: none;">
        </div>
        
        <div id="fileList" class="file-list"></div>
        
        <button class="btn btn-main" id="analyzeBtn" style="display: none;">
            ü§ñ Analyze with AI Coach
        </button>
        
        <!-- HOW TO GET DATA -->
        <div style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 12px;">
            <h3 style="color: #00d4ff; margin-bottom: 15px;">üì• How to Export from Garmin Connect</h3>
            <ol style="line-height: 2; padding-left: 20px;">
                <li>Go to <a href="https://connect.garmin.com" target="_blank" style="color: #00ff9d;">connect.garmin.com</a></li>
                <li>Sign in to your account</li>
                <li>Click your profile icon ‚Üí Settings</li>
                <li>Look for "Data Management" or "Export Data"</li>
                <li>Select last 7-30 days</li>
                <li>Download CSVs for: Activities, Sleep, Daily Summary</li>
                <li>Upload them here!</li>
            </ol>
        </div>
    </div>
    
    <!-- RECOVERY ANALYSIS RESULTS -->
    <div id="recoveryResults" style="display: none;">
        <div class="card">
            <h2 style="text-align: center; margin-bottom: 20px; color: #00ff9d;">Recovery Status</h2>
            
            <div class="recovery-score" id="recoveryScore">--</div>
            
            <div class="recovery-meter">
                <div class="recovery-meter-fill" id="recoveryMeterFill" style="width: 0%"></div>
            </div>
            
            <p style="text-align: center; color: #888; margin-top: 10px;" id="recoveryStatus">Analyzing...</p>
        </div>
        
        <!-- METRICS -->
        <div class="card">
            <h3 style="margin-bottom: 20px;">üìä Key Metrics</h3>
            <div class="metric-grid" id="metricsGrid"></div>
        </div>
        
        <!-- AI RECOMMENDATIONS -->
        <div class="card">
            <h3 style="margin-bottom: 20px;">ü§ñ AI Coach Recommendations</h3>
            <div id="aiRecommendations"></div>
        </div>
        
        <!-- RAW DATA -->
        <div class="card">
            <details>
                <summary style="cursor: pointer; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    üîç View Raw Garmin Data
                </summary>
                <div id="rawData" style="margin-top: 15px; font-family: monospace; font-size: 0.85em; background: #000; padding: 15px; border-radius: 8px; overflow-x: auto; max-height: 400px; overflow-y: auto;"></div>
            </details>
        </div>
        
        <button class="btn btn-action" onclick="resetGarminUpload()">
            üîÑ Upload New Data
        </button>
    </div>
</div>

<!-- AI PLAN WIZARD MODAL -->
<div class="modal-overlay" id="ai-wizard-modal">
    <div class="modal-content" style="max-height:90vh; display:flex; flex-direction:column; overflow:visible;">
        <div class="modal-header">
            <h2>ü§ñ AI Plan Generator</h2>
            <button class="modal-close" onclick="closeAIWizard()">‚úï</button>
        </div>
        <div id="wizard-chat-messages" style="flex:1; overflow-y:auto; padding:10px; min-height:300px; max-height:55vh;"></div>
        <div id="wizard-chips" style="padding:8px 10px;"></div>
        <div style="padding:10px; border-top:1px solid #333;">
            <textarea id="wizard-chat-input" rows="4" placeholder="Or type your own answer..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendWizardMessage();}"></textarea>
            <button class="btn btn-main" onclick="sendWizardMessage()" style="padding:8px 20px; margin-top:6px; float:right; font-size:0.85em;">Send ‚û§</button>
            <div style="clear:both;"></div>
        </div>
        <div id="wizard-actions" style="padding:8px 10px; display:none;">
            <button class="btn btn-success" onclick="generateFromChat()" style="width:100%;">‚ú® Generate My Plan</button>
        </div>
    </div>
</div>

<!-- NAVIGATION -->
<div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('coach')">
        <div class="nav-icon">üí™</div>Coach
    </button>
    <button class="nav-btn" onclick="switchTab('garmin')">
        <div class="nav-icon">üèÉ</div>Recovery
    </button>
    <button class="nav-btn" onclick="switchTab('plan')">
        <div class="nav-icon">üìÖ</div>Plan
    </button>
    <button class="nav-btn" onclick="switchTab('encyclopedia')">
        <div class="nav-icon">üìö</div>Library
    </button>
    <button class="nav-btn" onclick="switchTab('settings')">
        <div class="nav-icon">‚öôÔ∏è</div>Settings
    </button>
</div>

<!-- CUSTOM BUILDER MODAL -->
<div class="modal-overlay" id="custom-builder-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üõ†Ô∏è Custom Workout Builder</h2>
            <button class="modal-close" onclick="closeCustomBuilder()">‚úï</button>
        </div>
        
        <div style="margin-bottom: 15px;">
            <label>Number of Exercises: <span id="exercise-count-display">6</span></label>
            <input type="range" id="exercise-count-slider" min="3" max="10" value="6" 
                   oninput="updateExerciseCount(this.value)">
        </div>
        
        <div style="margin-bottom: 15px;">
            <input type="text" id="builder-search" placeholder="Search exercises..." 
                   onkeyup="searchBuilderExercises()">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label>Filter by Muscle Group:</label>
            <div class="chip-container">
                <div class="chip active" onclick="filterBuilder('all')">All</div>
                <div class="chip" onclick="filterBuilder('Chest')">Chest</div>
                <div class="chip" onclick="filterBuilder('Back')">Back</div>
                <div class="chip" onclick="filterBuilder('Legs')">Legs</div>
                <div class="chip" onclick="filterBuilder('Shoulders')">Shoulders</div>
                <div class="chip" onclick="filterBuilder('Arms')">Arms</div>
            </div>
            
            <label style="margin-top: 10px; display: block;">Equipment:</label>
            <div class="chip-container">
                <div class="chip" onclick="filterBuilder('Cable')">Cables</div>
                <div class="chip" onclick="filterBuilder('Dumbbell')">Dumbbells</div>
                <div class="chip" onclick="filterBuilder('Barbell')">Barbells</div>
                <div class="chip" onclick="filterBuilder('Bodyweight')">Bodyweight</div>
            </div>
            
            <label style="margin-top: 10px; display: block; color: #9b59b6; font-weight: bold;">üíú 40+ Friendly:</label>
            <div class="chip-container">
                <div class="chip" onclick="filterBuilder('Mobility')" style="border-color: #9b59b6;">üßò Mobility (36)</div>
                <div class="chip" onclick="filterBuilder('Nimble')" style="border-color: #9b59b6;">ü§∏ Nimble (25)</div>
                <div class="chip" onclick="filterBuilder('Calisthenics')" style="border-color: #9b59b6;">üí™ Calisthenics (41)</div>
                <div class="chip" onclick="filterBuilder('Plyo')" style="border-color: #FF9800;">‚ö° Plyometric</div>
            </div>
        </div>
        
        <div id="builder-exercise-list" style="max-height: 300px; overflow-y: auto;"></div>
        
        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #333;">
            <p class="text-muted">Selected: <span id="selected-count">0</span> exercises</p>
            <button class="btn btn-main" onclick="startCustomWorkout()">
                ‚ñ∂Ô∏è Start Custom Workout
            </button>
        </div>
    </div>
</div>

<!-- EXERCISE DETAIL MODAL -->
<div class="modal-overlay" id="exercise-detail-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="exercise-detail-name">Exercise Name</h2>
            <button class="modal-close" onclick="closeExerciseDetail()">‚úï</button>
        </div>
        <div id="exercise-detail-content"></div>
    </div>
</div>

<!-- GPS TRACKING MODAL -->
<div class="modal-overlay" id="gps-tracking-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìç GPS Tracking</h2>
            <button class="modal-close" onclick="stopGpsTracking()">‚úï Stop</button>
        </div>
        <div id="gps-tracking-content">
            <div class="gps-stats">
                <div class="gps-stat">
                    <div class="gps-stat-value" id="gps-distance">0.00</div>
                    <div class="gps-stat-label">km</div>
                </div>
                <div class="gps-stat">
                    <div class="gps-stat-value" id="gps-pace">0:00</div>
                    <div class="gps-stat-label">min/km</div>
                </div>
                <div class="gps-stat">
                    <div class="gps-stat-value" id="gps-duration">00:00</div>
                    <div class="gps-stat-label">duration</div>
                </div>
            </div>
            <div class="gps-map" id="gps-map-container">
                <canvas id="gps-map-canvas" width="600" height="300"></canvas>
            </div>
            <div style="text-align:center; margin-top:15px;">
                <button class="btn btn-success" onclick="saveGpsRoute()">üíæ Save Route</button>
            </div>
        </div>
    </div>
</div>

<!-- WARMUP MODAL -->
<div class="modal-overlay" id="warmup-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üî• Warm-up Sequence</h2>
            <button class="modal-close" onclick="skipWarmup()">Skip</button>
        </div>
        <div id="warmup-content">
            <div class="warmup-timer" id="warmup-timer">60</div>
            <div class="warmup-exercise" id="warmup-current-exercise">
                <h3 id="warmup-exercise-name">Exercise Name</h3>
                <p class="text-muted" id="warmup-exercise-desc">Instructions</p>
            </div>
            <div style="text-align:center; margin-top:20px;">
                <button class="btn btn-action" id="warmup-next-btn" onclick="nextWarmupExercise()">Next Exercise</button>
            </div>
            <div class="text-muted" style="text-align:center; margin-top:10px;">
                Exercise <span id="warmup-progress">1/6</span>
            </div>
        </div>
    </div>
</div>

<!-- PLAN GENERATOR MODAL -->
<div class="modal-overlay" id="plan-generator-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Generate Training Plan</h2>
            <button class="modal-close" onclick="closePlanGenerator()">‚úï</button>
        </div>
        
        <div id="generator-step-1">
            <h3>Training Frequency</h3>
            <p class="text-muted">How many days per week?</p>
            <div class="chip-container">
                <div class="chip" onclick="selectFrequency(3)">3 Days</div>
                <div class="chip" onclick="selectFrequency(4)">4 Days</div>
                <div class="chip" onclick="selectFrequency(5)">5 Days</div>
                <div class="chip" onclick="selectFrequency(6)">6 Days</div>
            </div>
        </div>
        
        <div id="generator-step-2" style="display:none;">
            <h3>Training Focus</h3>
            <p class="text-muted">Balanced approach for sustainable fitness</p>
            <div class="chip-container">
                <div class="chip" onclick="selectGoal('balanced')">‚öñÔ∏è Balanced Performance</div>
                <div class="chip" onclick="selectGoal('vitality')">üßò Health & Vitality</div>
                <div class="chip" onclick="selectGoal('functional')">üéØ Functional Fitness</div>
            </div>
        </div>
        
        <div id="generator-step-3" style="display:none;">
            <h3>‚úÖ Plan Generated!</h3>
            <div id="plan-preview"></div>
            <button class="btn btn-main" onclick="acceptPlan()">Accept & Start</button>
            <button class="btn btn-action" onclick="regeneratePlan()">üîÑ Regenerate</button>
        </div>
    </div>
</div>

<script>
// ========================================
// EXERCISE DATABASE
// ========================================
function createEx(name, cat, equip, type, prep, exec, tips, benefits, muscles, setupF9) {
    return {
        name: name,
        cat: cat,
        equip: equip,
        type: type,
        guide: {
            prep: prep,
            exec: exec,
            tips: tips,
            benefits: benefits,
            muscles: muscles
        },
        setup: setupF9 || { arms: "N/A", pulleys: "N/A" }
    };
}

window.allExercises = [
  // ==================== CABLE CHEST (TORQUE F9) ====================
        createEx("Cable Chest Press", ["Chest"], "Cable", "Strength", 
            ["Set Arms to Wide (Pos 8-9). Pulleys at Chest Height.", "Grab handles and step forward into a split stance (one foot forward) for stability.", "Brace core and lean slightly forward, keeping spine neutral."],
            ["Press handles straight forward until arms are fully extended.", "Bring hands together at the center line.", "Slowly return elbows to a 45-degree angle (don't let them fly back behind shoulders)."],
            ["Don't flare elbows wide; keep them tucked.", "Keep shoulders down (depressed); don't shrug.", "Drive through the back leg."],
            ["Constant tension on pectorals throughout the rep.", "Reduced shoulder strain compared to bench press.", "High core activation for stability."],
            ["Pectoralis Major", "Triceps", "Front Delts"], {arms: "Wide (Pos 8-9)", pulleys: "Chest Height"}),

        createEx("Cable Chest Fly (High)", ["Chest"], "Cable", "Muscle Build",
            ["Set Pulleys to Top Position. Arms Wide.", "Step forward, lean torso 30¬∞ forward.", "Start with arms open wide, elbows slightly bent."],
            ["Fly hands down and together towards your waist.", "Imagine hugging a large tree trunk.", "Squeeze inner chest hard at the bottom.", "Control the return to the stretch position."],
            ["Don't turn it into a press; keep the elbow angle fixed.", "Keep chest proud, don't round shoulders forward."],
            ["Targets the lower (sternal) head of the chest.", "Excellent for creating the lower pec outline."],
            ["Lower Pectorals", "Anterior Delts"], {arms: "Wide", pulleys: "Top"}),

        createEx("Cable Chest Fly (Low)", ["Chest"], "Cable", "Muscle Build",
            ["Set Pulleys to Bottom Position. Arms Wide.", "Stand centrally with feet shoulder-width apart.", "Palms facing forward and up."],
            ["Scoop hands up and together to eye level.", "Focus on driving the elbows in and up.", "Squeeze the upper chest at the peak.", "Lower slowly to the starting position."],
            ["Don't swing your body to hoist the weight.", "Keep elbows soft (slightly bent) but rigid.", "Focus on the 'scoop' motion."],
            ["Targets the upper (clavicular) chest.", "Helps fill out the shelf of the chest."],
            ["Upper Pectorals", "Front Delts"], {arms: "Wide", pulleys: "Bottom"}),

        createEx("Cable Chest Fly (Mid)", ["Chest"], "Cable", "Muscle Build",
            ["Set Pulleys to Chest Height. Arms Wide.", "Step forward into a split stance.", "Palms facing each other."],
            ["Bring hands together directly in front of your chest.", "Squeeze hard for 1 second at the touch point.", "Open arms wide until you feel a deep stretch across the pecs."],
            ["Retract shoulder blades on the negative.", "Don't lock out elbows at the end range."],
            ["Builds overall chest mass.", "Focuses on peak contraction."],
            ["Pectoralis Major"], {arms: "Wide", pulleys: "Chest Height"}),

        createEx("Single Arm Cable Chest Press", ["Chest"], "Cable", "Strength",
            ["Set Pulley to Chest Height.", "Adopt a split stance.", "Hold one handle at your chest."],
            ["Press straight out while keeping hips and shoulders perfectly square.", "Resist the rotation of your torso.", "Return slowly to the start."],
            ["Fight the urge to twist your body.", "Engage obliques heavily to stabilize."],
            ["Corrects strength imbalances.", "Massive anti-rotation core workout."],
            ["Pecs", "Obliques", "Triceps"], {arms: "Standard", pulleys: "Chest Height"}),

        createEx("Cable Crossover", ["Chest"], "Cable", "Muscle Build",
            ["Set Pulleys Top. Arms Wide.", "Step forward aggressively.", "Lean torso forward 45 degrees."],
            ["Bring hands down and across each other.", "Cross wrists at the bottom to maximize range of motion.", "Alternate which hand is on top each rep."],
            ["Focus on the inner chest squeeze.", "Keep the movement distinct from a press."],
            ["Creates inner chest definition.", "Maximum contraction at the bottom."],
            ["Inner Pectorals"], {arms: "Wide", pulleys: "Top"}),

        createEx("Cable Pullover (Bench)", ["Chest", "Lats"], "Cable", "Muscle Build",
            ["Set Pulley Mid/Low. Arms Narrow.", "Place bench perpendicular to machine.", "Lie on back, head near machine.", "Hold rope or bar."],
            ["Keeping arms straight, pull the weight from behind your head over to your hips.", "Squeeze chest and lats at the bottom.", "Slowly return weight behind head for a stretch."],
            ["Keep arms straight but not locked.", "Feel the deep stretch in your armpits."],
            ["Expands the ribcage.", "Hits both chest and lats effectively."],
            ["Serratus Anterior", "Lats", "Pecs"], {arms: "Narrow", pulleys: "Mid"}),

        // ==================== CABLE BACK (TORQUE F9) ====================
        createEx("Lat Pulldown (Standing)", ["Back"], "Cable", "Strength",
            ["Set Pulleys Top. Arms Narrow or Top.", "Kneel or squat down on the floor.", "Hold handles with palms facing forward."],
            ["Drive elbows down towards your back pockets.", "Squeeze lats hard at the bottom.", "Allow arms to stretch fully up at the top."],
            ["Think 'Elbows to pockets', not 'Hands to shoulders'.", "Keep chest proud.", "Don't round your back."],
            ["Builds back width (V-Taper).", "Safe vertical pull pattern."],
            ["Latissimus Dorsi", "Biceps"], {arms: "Narrow", pulleys: "Top"}),

        createEx("Seated Cable Row", ["Back"], "Cable", "Strength",
            ["Set Pulleys Low. Arms Narrow.", "Sit on floor or bench.", "Brace feet against machine frame if possible."],
            ["Pull handles into your stomach.", "Drive elbows back past your torso.", "Squeeze shoulder blades together."],
            ["Keep spine neutral and upright.", "Don't rock back and forth excessively."],
            ["Builds back thickness.", "Corrects posture."],
            ["Rhomboids", "Traps", "Lats"], {arms: "Narrow", pulleys: "Low"}),

        createEx("Face Pulls", ["Back", "Shoulders"], "Cable", "Mobility",
            ["Set Pulley to Face Height. Use Rope.", "Grip rope with thumbs facing back.", "Staggered stance."],
            ["Pull the center of the rope to your forehead.", "Externally rotate hands back (like a double bicep pose).", "Squeeze rear delts."],
            ["Don't shrug shoulders up to ears.", "Lead with your wrists."],
            ["Essential for shoulder health.", "Strengthens rotator cuff."],
            ["Rear Delts", "Rotator Cuff"], {arms: "Narrow", pulleys: "Face Height"}),

        createEx("Straight Arm Pulldown", ["Back"], "Cable", "Muscle Build",
            ["Set Pulleys Top. Arms Top.", "Hinge hips slightly back.", "Keep arms straight out in front."],
            ["Push the bar/handles down to your thighs using your lats.", "Keep arms straight throughout.", "Squeeze armpits tight at the bottom."],
            ["Don't use triceps to push.", "Initiate movement with your lats."],
            ["Pure lat isolation.", "Great as a pre-exhaust."],
            ["Latissimus Dorsi"], {arms: "Top", pulleys: "Top"}),

        createEx("Single Arm Cable Row", ["Back"], "Cable", "Strength",
            ["Set Pulley Waist Height. Arms Standard.", "Adopt a split stance.", "Reach forward with the working arm."],
            ["Row elbow back tight to the body.", "Allow torso to rotate slightly forward on the stretch.", "Rotate back to neutral on the pull."],
            ["Get a deep stretch at the start.", "Hard contraction at the end."],
            ["Unilateral back growth.", "Core integration."],
            ["Lats", "Obliques"], {arms: "Standard", pulleys: "Waist Height"}),

        createEx("Cable Shrugs", ["Back", "Traps"], "Cable", "Muscle Build",
            ["Set Pulleys Low. Arms Low.", "Stand centrally.", "Hold handles at sides."],
            ["Shrug shoulders straight up towards your ears.", "Hold for 1 second at the top.", "Lower fully to stretch traps."],
            ["Don't roll shoulders forward or back.", "Keep arms straight."],
            ["Builds trap size.", "Neck strength."],
            ["Trapezius"], {arms: "Low", pulleys: "Low"}),

        createEx("Cable Rear Delt Fly", ["Back", "Shoulders"], "Cable", "Muscle Build",
            ["Set Pulleys Eye Level. Arms Wide.", "Grab opposite cables (Left hand holds Right cable).", "Stand tall."],
            ["Pull arms apart horizontally until in line with body.", "Squeeze the back of your shoulders.", "Control the return."],
            ["Keep arms straight.", "Don't engage traps (keep shoulders down)."],
            ["Builds 3D Delts.", "Improves posture."],
            ["Posterior Delts"], {arms: "Wide", pulleys: "Eye Level"}),

        createEx("High Row (Rope)", ["Back"], "Cable", "Strength",
            ["Set Pulleys Top. Arms Narrow.", "Use Rope attachment.", "Step back and lean slightly."],
            ["Pull the rope towards your neck/chin.", "Drive elbows high and wide.", "Squeeze upper back."],
            ["Focus on the upper back, not the lats.", "Keep elbows flared."],
            ["Builds upper back thickness.", "Hits rear delts hard."],
            ["Rhomboids", "Rear Delts"], {arms: "Narrow", pulleys: "Top"}),

        // ==================== CABLE SHOULDERS ====================
        createEx("Cable Overhead Press", ["Shoulders"], "Cable", "Strength",
            ["Set Pulleys Low. Arms Wide.", "Hold handles at shoulder height.", "Stand strong with core braced."],
            ["Press straight up overhead.", "Bring biceps by ears at the top.", "Lower with control to ear level."],
            ["Keep core tight.", "Don't arch your lower back."],
            ["Builds shoulder mass.", "Constant tension compared to dumbbells."],
            ["Anterior Delts", "Triceps"], {arms: "Wide", pulleys: "Low"}),

        createEx("Cable Lateral Raise", ["Shoulders"], "Cable", "Muscle Build",
            ["Set Pulleys Low. Arms Low.", "Cross cables (Left hand -> Right cable).", "Stand center."],
            ["Raise arms out to the sides.", "Stop at shoulder height.", "Lower slowly."],
            ["Lead with your elbows, not your hands.", "Imagine pouring a pitcher of water."],
            ["Builds side delt width.", "Creates caped shoulder look."],
            ["Lateral Delts"], {arms: "Low", pulleys: "Low"}),

        createEx("Cable Front Raise", ["Shoulders"], "Cable", "Muscle Build",
            ["Set Pulleys Low. Arms Low.", "Face away from machine.", "Cable runs between legs."],
            ["Raise straight arms to the front.", "Stop at eye level.", "Lower with control."],
            ["No swinging.", "Keep chest up."],
            ["Isolates the front delt."],
            ["Anterior Delts"], {arms: "Low", pulleys: "Low"}),

        createEx("Cable External Rotation", ["Shoulders", "Mobility"], "Cable", "Mobility",
            ["Set Pulley Elbow Height.", "Stand sideways.", "Elbow pinned to side (use a towel if needed)."],
            ["Rotate hand away from your body.", "Keep elbow glued to ribs.", "Return slowly."],
            ["Use very light weight.", "Focus on the small cuff muscles."],
            ["Rotator cuff health.", "Injury prevention."],
            ["Infraspinatus"], {arms: "Mid", pulleys: "Mid"}),

        createEx("Cable Internal Rotation", ["Shoulders", "Mobility"], "Cable", "Mobility",
            ["Set Pulley Elbow Height.", "Stand sideways.", "Elbow pinned to side."],
            ["Rotate hand inward towards your stomach.", "Keep elbow glued.", "Return."],
            ["Control the motion.", "Don't use chest to pull."],
            ["Subscapularis strength."],
            ["Subscapularis"], {arms: "Mid", pulleys: "Mid"}),

        createEx("Cable Upright Row", ["Shoulders", "Traps"], "Cable", "Muscle Build",
            ["Set Pulleys Low. Arms Low.", "Bar or Handles.", "Stand close."],
            ["Pull hands up body to chest.", "Elbows lead movement high.", "Lower."],
            ["Don't go too heavy.", "Watch wrists."],
            ["Side delts and Traps."],
            ["Lateral Delts", "Traps"], {arms: "Low", pulleys: "Low"}),

        createEx("Cable Y-Raise", ["Back", "Shoulders"], "Cable", "Mobility",
            ["Set Pulleys Low. Arms Low.", "Cross cables.", "Stand tall."],
            ["Raise arms up and out into 'Y' shape.", "Squeeze lower traps.", "Lower slowly."],
            ["Thumbs up.", "Don't arch back."],
            ["Lower trap activation.", "Scapular health."],
            ["Lower Traps", "Side Delts"], {arms: "Low", pulleys: "Low"}),

        // ==================== CABLE ARMS ====================
        createEx("Tricep Pushdown (Rope)", ["Arms", "Triceps"], "Cable", "Muscle Build",
            ["Set Pulley Top.", "Pin elbows to your ribs.", "Hinge only at the elbow."],
            ["Push down forcefully.", "Spread the rope apart at the bottom.", "Return to 90 degrees."],
            ["Keep elbows locked in place.", "Squeeze triceps hard."],
            ["Targets the lateral head.", "Great for definition."],
            ["Triceps"], {arms: "Narrow", pulleys: "Top"}),

        createEx("Tricep Pushdown (Bar)", ["Arms", "Triceps"], "Cable", "Muscle Build",
            ["Set Pulley Top.", "Use Straight Bar.", "Elbows pinned to sides."],
            ["Push straight down.", "Lockout arms fully.", "Return to chest height."],
            ["Go heavier than with rope.", "Keep wrists straight."],
            ["Overall tricep mass builder."],
            ["Triceps"], {arms: "Narrow", pulleys: "Top"}),

        createEx("Overhead Cable Extension", ["Arms", "Triceps"], "Cable", "Muscle Build",
            ["Set Pulley Mid/Top.", "Lean forward facing away from machine.", "Hold rope behind head."],
            ["Extend arms forward and overhead.", "Keep elbows by ears.", "Stretch back deeply."],
            ["The deep stretch is key here.", "Don't flare elbows too wide."],
            ["Targets the Long Head of the tricep.", "Adds arm size."],
            ["Triceps (Long Head)"], {arms: "Mid", pulleys: "Mid"}),

        createEx("Cable Bicep Curl", ["Arms", "Biceps"], "Cable", "Muscle Build",
            ["Set Pulley Low.", "Hold bar or handles.", "Stand tall."],
            ["Curl weight up to chin.", "Squeeze biceps.", "Lower fully."],
            ["Keep elbows slightly forward of hips.", "Don't lean back."],
            ["Constant tension curls."],
            ["Biceps"], {arms: "Low", pulleys: "Low"}),

        createEx("Cable Hammer Curl", ["Arms", "Biceps"], "Cable", "Muscle Build",
            ["Set Pulley Low.", "Use Rope.", "Neutral grip (palms facing)."],
            ["Curl up towards shoulders.", "Thumbs lead the movement.", "Lower."],
            ["Focus on forearms and brachialis.", "No swinging."],
            ["Adds arm thickness and width."],
            ["Brachialis", "Forearms"], {arms: "Low", pulleys: "Low"}),

        createEx("Bayesian Curl", ["Arms", "Biceps"], "Cable", "Muscle Build",
            ["Set Pulley Low. Face away.", "Arm extended behind torso.", "Step forward."],
            ["Curl forward while keeping elbow back.", "Feel the deep stretch at start."],
            ["Unique stretch angle for hypertrophy.", "Keep shoulder stable."],
            ["Targets the long head via stretch."],
            ["Biceps"], {arms: "Low", pulleys: "Low"}),

        createEx("Cable Kickback", ["Arms", "Triceps"], "Cable", "Muscle Build",
            ["Set Pulley Low.", "Bent over.", "No attachment."],
            ["Extend arm back.", "Squeeze hard.", "Bend elbow only."],
            ["Don't swing shoulder."],
            ["Peak contraction."],
            ["Triceps"], {arms: "Low", pulleys: "Low"}),

        createEx("Reverse Grip Pushdown", ["Arms", "Triceps"], "Cable", "Muscle Build",
            ["Set Pulley Top.", "Palms up (Supinated).", "Elbows pinned."],
            ["Push down.", "Squeeze."],
            ["Don't loose grip."],
            ["Medial head focus."],
            ["Triceps"], {arms: "Top", pulleys: "Top"}),

        // ==================== CABLE LEGS ====================
        createEx("Cable Squat", ["Legs"], "Cable", "Strength",
            ["Set Pulleys Low. Arms Narrow.", "Hold handles at shoulders (rack position).", "Stance shoulder width."],
            ["Squat down deep.", "Keep chest upright.", "Drive up through heels."],
            ["Safer on the back than barbell squats.", "Easy to bail if needed."],
            ["Quad focus with less spinal load."],
            ["Quads", "Glutes"], {arms: "Narrow", pulleys: "Low"}),

        createEx("Cable Pull-Through", ["Legs", "Glutes"], "Cable", "Strength",
            ["Set Pulley Low. Rope.", "Face away from machine.", "Hold rope between legs."],
            ["Hinge hips back towards machine.", "Feel hamstring stretch.", "Snap hips forward to stand."],
            ["It is a hinge, not a squat.", "Squeeze glutes hard at top.", "Don't pull with arms."],
            ["Best glute builder on cable.", "Teaches hip hinge."],
            ["Glutes", "Hamstrings"], {arms: "Narrow", pulleys: "Low"}),

        createEx("Cable RDL", ["Legs", "Hamstrings"], "Cable", "Strength",
            ["Set Pulleys Low.", "Face machine.", "Hold handles at thighs."],
            ["Hinge hips back.", "Keep knees soft but fixed.", "Lower until back is parallel to floor."],
            ["Feel deep hamstring stretch.", "Drive hips forward to stand."],
            ["Posterior chain builder."],
            ["Hamstrings"], {arms: "Narrow", pulleys: "Low"}),

        createEx("Cable Lunge", ["Legs"], "Cable", "Strength",
            ["Set Pulleys Low.", "Hold handles.", "Step back into a lunge."],
            ["Drop back knee to floor.", "Drive up through front heel.", "Keep chest up."],
            ["Stability challenge.", "Keep knee in line with toe."],
            ["Unilateral leg strength."],
            ["Quads", "Glutes"], {arms: "Low", pulleys: "Low"}),

        createEx("Cable Kickback (Glute)", ["Legs", "Glutes"], "Cable", "Muscle Build",
            ["Set Pulley Low. Ankle strap.", "Face machine.", "Lean forward slightly."],
            ["Kick leg straight back and up.", "Squeeze glute at top.", "Return slowly."],
            ["Don't rotate hips open.", "Movement comes from hip, not back."],
            ["Glute isolation."],
            ["Glute Maximus"], {arms: "Narrow", pulleys: "Low"}),

        createEx("Cable Calf Raise", ["Legs", "Calves"], "Cable", "Muscle Build",
            ["Set Pulleys Low.", "Stand on a block or plate.", "Hold handles."],
            ["Lower heels to floor.", "Drive up onto toes.", "Squeeze hard."],
            ["Full range of motion is critical.", "Don't bounce."],
            ["Calf size and strength."],
            ["Calves"], {arms: "Low", pulleys: "Low"}),

        createEx("Cable Abductor", ["Legs", "Glutes"], "Cable", "Mobility",
            ["Set Pulley Low. Ankle strap.", "Stand sideways.", "Leg furthest from machine."],
            ["Kick leg out to side.", "Control return."],
            ["Stabilize with other leg."],
            ["Side glute.", "Hip health."],
            ["Glute Medius"], {arms: "Low", pulleys: "Low"}),

        createEx("Cable Adductor", ["Legs"], "Cable", "Mobility",
            ["Set Pulley Low. Ankle strap.", "Stand sideways.", "Leg closest to machine."],
            ["Pull leg across body.", "Control return."],
            ["Balance key."],
            ["Inner thigh."],
            ["Adductors"], {arms: "Low", pulleys: "Low"}),

        // ==================== CABLE CORE ====================
        createEx("Cable Crunch", ["Core"], "Cable", "Muscle Build",
            ["Set Pulley Top. Rope.", "Kneel down facing machine.", "Hold rope at ears."],
            ["Curl spine down towards floor.", "Bring elbows to knees.", "Squeeze abs."],
            ["Don't hinge at the hips.", "Round the back like a shrimp."],
            ["Weighted abdominal hypertrophy."],
            ["Rectus Abdominis"], {arms: "Narrow", pulleys: "Top"}),

        createEx("Woodchopper (High to Low)", ["Core"], "Cable", "Mobility",
            ["Set Pulley Top.", "Stand sideways.", "Grab handle with both hands."],
            ["Chop down and across body to opposite knee.", "Pivot back foot.", "Return slowly."],
            ["Explosive down, controlled up.", "Keep arms straight."],
            ["Oblique power.", "Rotational strength."],
            ["Obliques"], {arms: "Narrow", pulleys: "Top"}),

        createEx("Pallof Press", ["Core"], "Cable", "Strength",
            ["Set Pulley Chest Height.", "Stand sideways.", "Hold handle at chest."],
            ["Press handle straight out.", "Hold for 2-3 seconds.", "Return to chest."],
            ["Resist the rotation pulling you in.", "Keep shoulders square."],
            ["The ultimate anti-rotation exercise.", "Spine health."],
            ["Core Stabilizers"], {arms: "Narrow", pulleys: "Chest Height"}),

        createEx("Cable Side Bend", ["Core"], "Cable", "Mobility",
            ["Set Pulley Low. Stand sideways to the machine.", "Hold the handle in one hand, arm hanging straight down.", "Feet shoulder-width apart."],
            ["Lean your torso away from the machine, crunching the oblique.", "Return to neutral, resisting the pull.", "Do not lean forward or back."],
            ["Focus on the ribcage moving towards the hip.", "Keep the arm straight; don't pull with the bicep."],
            ["Isolates the obliques.", "Strengthens the lateral core."],
            ["Obliques"], {arms: "Low", pulleys: "Low"}),

        createEx("Woodchopper (Low to High)", ["Core"], "Cable", "Mobility",
            ["Set Pulley Low.", "Stand sideways.", "Hands on handle."],
            ["Rotate up across body.", "Pivot foot.", "Return."],
            ["Full rotation."],
            ["Functional core."],
            ["Obliques"], {arms: "Narrow", pulleys: "Low"}),

        // ==================== DUMBBELLS (DETAILED) ====================
        createEx("Dumbbell Bench Press", ["Chest"], "Dumbbell", "Strength",
            ["Lie on a flat bench with 5 points of contact (head, shoulders, butt, left foot, right foot).", "Hold dumbbells at chest level, palms facing forward.", "Retract shoulder blades."],
            ["Press dumbbells straight up to full lockout.", "Lower slowly (3 seconds) until hands are level with chest.", "Elbows should be at a 45-degree angle to body."],
            ["Drive feet into the floor.", "Do not bounce the weights at the bottom.", "Keep wrists straight."],
            ["Builds chest mass.", "Requires more stabilizer muscle than barbell."],
            ["Pectoralis Major", "Triceps", "Front Delts"]),

        createEx("Dumbbell Incline Press", ["Chest"], "Dumbbell", "Strength",
            ["Set bench to 30 or 45 degrees.", "Kick dumbbells up to shoulders using knees.", "Palms forward."],
            ["Press straight up towards the ceiling.", "Lower slowly to upper chest level.", "Keep elbows tucked, not flared."],
            ["Keep head on the bench.", "Squeeze pecs at the top."],
            ["Targets the 'shelf' of the upper chest.", "Less stress on rotator cuff than flat bench."],
            ["Upper Pectorals", "Front Delts"]),

        createEx("Dumbbell Fly", ["Chest"], "Dumbbell", "Muscle Build",
            ["Lie on a flat bench.", "Hold dumbbells above chest, palms facing each other (neutral grip).", "Slight bend in elbows."],
            ["Lower arms out to sides in a wide arc.", "Feel a deep stretch across the chest.", "Squeeze back to the top like hugging a barrel."],
            ["Don't go below shoulder level if it hurts.", "Keep the elbow bend constant."],
            ["Expands the chest.", "Isolates the pecs without tricep involvement."],
            ["Pectoralis Major"]),

        createEx("Dumbbell Shoulder Press", ["Shoulders"], "Dumbbell", "Strength",
            ["Sit on a bench with back support.", "Bring dumbbells to shoulder height, palms forward.", "Feet flat on floor."],
            ["Press straight up overhead until arms lock out.", "Lower slowly until thumbs touch ear level.", "Keep core tight."],
            ["Do not arch your lower back aggressively.", "Push head slightly forward at the top."],
            ["Primary mass builder for shoulders.", "Full range of motion."],
            ["Deltoids", "Triceps"]),

        createEx("Arnold Press", ["Shoulders"], "Dumbbell", "Strength",
            ["Sit upright.", "Start with dumbbells in front of face, palms facing you (supinated).", "Elbows tucked."],
            ["Press up while rotating palms outward.", "Finish at the top with palms facing forward.", "Reverse the rotation on the way down."],
            ["Smooth, controlled rotation is key.", "Don't rush the twist."],
            ["Hits all 3 heads of the deltoid.", "Increases time under tension."],
            ["Anterior Delts", "Lateral Delts", "Rear Delts"]),

        createEx("Lateral Raise", ["Shoulders"], "Dumbbell", "Muscle Build",
            ["Stand tall with dumbbells at sides.", "Slight bend in elbows.", "Lean forward 5 degrees."],
            ["Raise arms out to the sides until parallel with floor.", "Think about lifting with your elbows, not hands.", "Lower slowly."],
            ["Don't swing the body.", "Pinkies should be slightly higher than thumbs (pouring water)."],
            ["Creates shoulder width (the 'Cap').", "Isolates the side delt."],
            ["Lateral Delts"]),

        createEx("Front Raise", ["Shoulders"], "Dumbbell", "Muscle Build",
            ["Stand tall, dumbbells resting on thighs.", "Palms facing thighs (pronated)."],
            ["Raise dumbbells straight to the front until eye level.", "Lower with control.", "Keep arms straight."],
            ["Do not use hip drive to swing weight up.", "Keep chest proud."],
            ["Isolates the front of the shoulder.", "Improves pressing stability."],
            ["Anterior Delts"]),

        createEx("Dumbbell Row", ["Back"], "Dumbbell", "Strength",
            ["Place one knee and same-side hand on a bench.", "Back flat like a table.", "Hold dumbbell in free hand."],
            ["Row the dumbbell up towards your hip pocket.", "Drive elbow back past torso.", "Lower to a full stretch."],
            ["Don't rotate your spine to lift the weight.", "Pull with the elbow, not the bicep."],
            ["Builds back thickness.", "Corrects strength imbalances."],
            ["Latissimus Dorsi", "Rhomboids", "Biceps"]),

        createEx("Dumbbell Pullover", ["Back"], "Dumbbell", "Muscle Build",
            ["Lie perpendicular across a bench (upper back on bench).", "Hold one dumbbell with both hands overhead.", "Hips low."],
            ["Lower the weight behind your head with slight elbow bend.", "Feel a massive stretch in lats/ribs.", "Pull back over to chest."],
            ["Keep hips low to maximize stretch.", "Don't turn it into a tricep extension."],
            ["Expands the ribcage.", "Targets lats and serratus anterior."],
            ["Latissimus Dorsi", "Serratus Anterior"]),

        createEx("Goblet Squat", ["Legs"], "Dumbbell", "Strength",
            ["Hold one dumbbell vertically against your chest.", "Cup the top end in your palms.", "Stance shoulder-width."],
            ["Squat down deep, elbows tracking inside knees.", "Keep chest proud and upright.", "Drive up through heels."],
            ["Don't let the chest collapse forward.", "Keep heels glued to the floor."],
            ["Excellent for learning squat form.", "Builds legs and core."],
            ["Quadriceps", "Glutes", "Core"]),

        createEx("Dumbbell Lunge", ["Legs"], "Dumbbell", "Strength",
            ["Hold dumbbells at sides (suitcase carry).", "Stand tall."],
            ["Step forward with one leg.", "Drop back knee until it hovers 1 inch off floor.", "Push back to start position."],
            ["Keep torso upright.", "Ensure front knee doesn't cave inward."],
            ["Unilateral leg strength.", "Improves balance and hip stability."],
            ["Quadriceps", "Glutes", "Hamstrings"]),

        createEx("Bulgarian Split Squat", ["Legs"], "Dumbbell", "Strength",
            ["Place rear foot laces-down on a bench.", "Hop front foot out.", "Hold dumbbells at sides."],
            ["Squat down until rear knee is near floor.", "Drive up through the front heel.", "Keep torso slightly forward."],
            ["Keep the weight on the front leg.", "This exercise is painful but highly effective."],
            ["The king of single-leg builders.", "Fixes imbalances."],
            ["Glutes", "Quadriceps"]),

        createEx("Romanian Deadlift (DB)", ["Legs"], "Dumbbell", "Strength",
            ["Hold dumbbells in front of thighs.", "Feet hip-width apart.", "Knees slightly soft but fixed."],
            ["Hinge hips backward (close car door with butt).", "Slide dumbbells down legs.", "Feel hamstring stretch.", "Snap hips forward."],
            ["Keep back perfectly flat.", "Do not squat the weight down."],
            ["Builds the posterior chain.", "Hamstring mass."],
            ["Hamstrings", "Glutes", "Lower Back"]),

        createEx("Dumbbell Curl", ["Arms", "Biceps"], "Dumbbell", "Muscle Build",
            ["Stand tall, dumbbells at sides, palms forward.", "Chest up."],
            ["Curl weight up to shoulders.", "Squeeze biceps hard.", "Lower all the way down."],
            ["Keep elbows fixed in space at your sides.", "Do not swing."],
            ["Classic bicep mass builder."],
            ["Biceps"]),

        createEx("Hammer Curl", ["Arms"], "Dumbbell", "Muscle Build",
            ["Stand tall, palms facing your body (Neutral Grip)."],
            ["Curl weight up, touching thumb to shoulder.", "Lower with control."],
            ["Do not use momentum.", "Keep elbows pinned."],
            ["Targets the side of the arm (brachialis) and forearm.", "Adds arm thickness."],
            ["Brachialis", "Forearms"]),

        createEx("Tricep Kickback", ["Arms"], "Dumbbell", "Muscle Build",
            ["Bent over on a bench (row position).", "Elbow high and pinned to side."],
            ["Extend arm straight back until locked out.", "Hold for 1s.", "Bend elbow back to 90 degrees."],
            ["Do not let the elbow drop during the set.", "Use light weight and focus on the squeeze."],
            ["Isolates the tricep long head.", "Good finishing move."],
            ["Triceps"]),

        createEx("Skull Crusher (DB)", ["Arms"], "Dumbbell", "Muscle Build",
            ["Lie on a bench.", "Arms extended straight up.", "Neutral grip."],
            ["Bend elbows to lower dumbbells beside your ears.", "Extend back up to ceiling.", "Keep elbows pointing up."],
            ["Don't move shoulders, only elbows.", "Feel the deep stretch."],
            ["Mass builder for triceps."],
            ["Triceps"]),

        createEx("Farmers Walk", ["Core", "Traps"], "Dumbbell", "Strength",
            ["Hold heavy dumbbells at sides.", "Stand tall, shoulders back."],
            ["Walk for distance or time.", "Prevent body from swaying.", "Grip the handles tight."],
            ["Keep head neutral.", "Steps should be controlled."],
            ["Total body stability.", "Grip strength and trap size."],
            ["Core", "Forearms", "Traps"]),

        createEx("Zottman Curl", ["Arms", "Biceps"], "Dumbbell", "Muscle Build",
            ["Stand tall with DBs.", "Curl up with palms facing UP."],
            ["At the top, rotate wrists so palms face DOWN.", "Lower slowly with palms down."],
            ["Control the rotation.", "Keep elbows pinned."],
            ["Hits biceps on the way up, forearms on the way down."],
            ["Biceps", "Brachioradialis"]),

        createEx("Concentration Curl", ["Arms", "Biceps"], "Dumbbell", "Muscle Build",
            ["Sit on bench, legs wide.", "Hold one DB.", "Rest elbow against inner thigh."],
            ["Curl weight up towards chest.", "Squeeze at peak.", "Lower slowly."],
            ["Do not swing the body.", "Pure isolation."],
            ["Builds the 'peak' of the bicep."],
            ["Biceps"]),

        createEx("DB Floor Press", ["Chest"], "Dumbbell", "Strength",
            ["Lie on the floor with DBs.", "Knees bent, feet flat."],
            ["Press DBs up.", "Lower until triceps lightly touch the floor.", "Pause for 1s."],
            ["Don't bounce elbows off the floor.", "Explode up."],
            ["Builds lockout strength.", "Shoulder-safe pressing option."],
            ["Triceps", "Pectorals"]),

        createEx("Renegade Row", ["Back", "Core"], "Dumbbell", "Strength",
            ["Get into high plank position holding DBs on floor.", "Feet wide for balance."],
            ["Row one DB to hip while balancing on the other.", "Alternate sides.", "Keep hips level."],
            ["Fight the rotation of the hips.", "Keep core super tight."],
            ["Full body tension.", "Anti-rotation strength."],
            ["Latissimus Dorsi", "Core", "Obliques"]),

        createEx("DB Step Up", ["Legs"], "Dumbbell", "Strength",
            ["Stand in front of a box or bench.", "Hold DBs at sides."],
            ["Step one foot entirely on the box.", "Drive through the heel to stand up.", "Control the descent."],
            ["Don't push off the bottom leg.", "Keep torso upright."],
            ["Unilateral leg strength.", "Glute focus."],
            ["Glutes", "Quadriceps"]),

        createEx("DB Shrugs", ["Back", "Traps"], "Dumbbell", "Muscle Build",
            ["Hold heavy DBs at sides.", "Stand tall."],
            ["Shrug shoulders straight up to ears.", "Hold for 1s.", "Lower fully."],
            ["Do not roll shoulders.", "Movement is vertical."],
            ["Upper trap size."],
            ["Upper Traps"]),

        createEx("Seated Calf Raise", ["Legs", "Calves"], "Dumbbell", "Muscle Build",
            ["Sit on a bench.", "Place toes on a block/plate.", "Hold heavy DBs vertically on knees."],
            ["Raise heels as high as possible.", "Lower heels to floor for a stretch.", "High reps."],
            ["Targets the soleus muscle.", "Adds width to the calf."],
            ["Soleus"]),

        // ==================== BODYWEIGHT (DETAILED) ====================
        createEx("Push-ups", ["Chest"], "Bodyweight", "Calisthenics",
            ["High plank position.", "Hands directly under shoulders.", "Glutes and core tight."],
            ["Lower chest to floor.", "Elbows at 45 degree angle.", "Push back up to lockout."],
            ["No sagging hips.", "Keep neck neutral."],
            ["Chest endurance.", "Core stability."],
            ["Pectoralis Major", "Triceps", "Core"]),

        createEx("Pull-ups", ["Back"], "Bodyweight", "Calisthenics",
            ["Overhand grip (palms away).", "Hands slightly wider than shoulders.", "Dead hang."],
            ["Pull chin over the bar.", "Drive elbows down.", "Lower under control."],
            ["No kipping/swinging.", "Engage lats first."],
            ["The king of back exercises.", "Builds width."],
            ["Latissimus Dorsi", "Biceps"]),

        createEx("Chin-ups", ["Back"], "Bodyweight", "Calisthenics",
            ["Underhand grip (palms to face).", "Hands shoulder width."],
            ["Pull chest to the bar.", "Squeeze biceps at top.", "Lower fully."],
            ["Easier than pullups.", "Hits biceps harder."],
            ["Arm size.", "Back strength."],
            ["Biceps", "Latissimus Dorsi"]),

        createEx("Dips", ["Chest", "Triceps"], "Bodyweight", "Calisthenics",
            ["Support yourself on parallel bars.", "Shoulders down and back."],
            ["Lower until shoulders are below elbows (90 deg).", "Push back up.", "Lean forward for chest, upright for triceps."],
            ["Don't shrug shoulders.", "Control the descent."],
            ["The squat of the upper body.", "Mass builder."],
            ["Pectoralis Major", "Triceps"]),

        createEx("Bodyweight Squat", ["Legs"], "Bodyweight", "Calisthenics",
            ["Feet shoulder width.", "Arms out for balance."],
            ["Squat deep, hips below knees.", "Keep knees out.", "Stand up."],
            ["Keep heels down.", "Chest up."],
            ["Leg endurance.", "Mobility."],
            ["Quadriceps", "Glutes"]),

        createEx("Lunge (BW)", ["Legs"], "Bodyweight", "Calisthenics",
            ["Step forward.", "Drop back knee to floor.", "Push back to start."],
            ["Keep torso upright.", "Don't let front knee cave in."],
            ["Balance training.", "Leg endurance."],
            ["Quadriceps", "Glutes"]),

        createEx("Glute Bridge", ["Legs", "Glutes"], "Bodyweight", "Calisthenics",
            ["Lie on back.", "Knees bent, feet flat near butt."],
            ["Drive hips to ceiling.", "Squeeze glutes hard at top.", "Lower."],
            ["Don't arch lower back.", "Drive through heels."],
            ["Glute activation.", "Fixes sitting posture."],
            ["Glute Maximus"]),

        createEx("Plank", ["Core"], "Bodyweight", "Calisthenics",
            ["Forearms on floor.", "Toes on floor.", "Body in straight line."],
            ["Hold.", "Squeeze glutes and abs maximally.", "Breathe."],
            ["Don't let hips sag.", "Don't pike butt up."],
            ["Total core stability."],
            ["Transverse Abdominis"]),

        createEx("Side Plank", ["Core"], "Bodyweight", "Calisthenics",
            ["Lie on side.", "Support on one elbow."],
            ["Lift hips off floor.", "Hold straight line.", "Switch sides."],
            ["Don't let hips rotate forward."],
            ["Oblique stability.", "Spine health."],
            ["Obliques", "Quadratus Lumborum"]),

        createEx("Mountain Climbers", ["Core"], "Bodyweight", "Calisthenics",
            ["Pushup position."],
            ["Drive knees to chest alternately.", "Run in place.", "Keep hips low."],
            ["Don't bounce hips up and down.", "Keep shoulders over hands."],
            ["Cardio core.", "Calorie burn."],
            ["Core", "Cardio"]),

        createEx("Burpees", ["Full Body"], "Bodyweight", "Calisthenics",
            ["Stand.", "Drop to chest on floor.", "Jump feet in.", "Jump up clap."],
            ["Explosive movement.", "Full range of motion."],
            ["Pace yourself.", "Land softly."],
            ["Conditioning.", "Metabolic hit."],
            ["Full Body"]),

        createEx("Hanging Leg Raise", ["Core"], "Bodyweight", "Calisthenics",
            ["Hang from bar.", "Body straight."],
            ["Lift legs to L shape (straight legs) or tuck knees.", "Lower slowly.", "Avoid swinging."],
            ["Compress abs.", "Don't use momentum."],
            ["Lower abs.", "Hip flexor strength."],
            ["Rectus Abdominis", "Hip Flexors"]),

        createEx("Pike Push-up", ["Shoulders"], "Bodyweight", "Calisthenics",
            ["Start in pushup position.", "Walk feet in until hips are high (V shape)."],
            ["Lower head towards floor.", "Push back up/back."],
            ["Mimics an overhead press.", "Keep elbows tucked."],
            ["Shoulder strength without weights."],
            ["Deltoids", "Triceps"]),

        createEx("Pistol Squat", ["Legs"], "Bodyweight", "Strength",
            ["Stand on one leg.", "Extend other leg forward.", "Arms out for balance."],
            ["Squat down on standing leg.", "Go as deep as possible.", "Drive back up."],
            ["Keep heel planted.", "Use a box/bench for regression if needed."],
            ["Mastery of leg strength.", "Balance."],
            ["Quadriceps", "Glutes", "Stabilizers"]),

        createEx("Nordic Curl", ["Legs", "Hamstrings"], "Bodyweight", "Strength",
            ["Kneel on pad.", "Anchor feet under something heavy (or partner)."],
            ["Lower torso forward slowly using hamstrings.", "Control the fall as long as possible.", "Catch yourself with hands."],
            ["Push back up to start.", "Keep hips extended (no hinge)."],
            ["Bulletproofs hamstrings.", "Prevents injury."],
            ["Hamstrings"]),

        createEx("Inverted Row", ["Back"], "Bodyweight", "Calisthenics",
            ["Set a bar at waist height.", "Lie under bar.", "Grab wide."],
            ["Pull chest to bar.", "Keep body in straight plank line.", "Lower slow."],
            ["Squeeze shoulder blades together.", "Don't sag hips."],
            ["Horizontal pull.", "Back thickness."],
            ["Latissimus Dorsi", "Rhomboids"]),

        createEx("Handstand Hold", ["Shoulders"], "Bodyweight", "Calisthenics",
            ["Place hands near wall.", "Kick up so heels touch wall.", "Arms locked."],
            ["Push floor away aggressively.", "Squeeze glutes and abs.", "Hold."],
            ["Look between hands.", "Breathe."],
            ["Overhead stability.", "Shoulder strength."],
            ["Deltoids", "Triceps"]),

        createEx("Calf Raise (BW)", ["Legs", "Calves"], "Bodyweight", "Calisthenics",
            ["Stand on edge of step.", "Heels hanging off.", "Hold wall for balance."],
            ["Drive up onto toes.", "Hold squeeze.", "Lower into deep stretch."],
            ["Full range of motion is key.", "Don't bounce."],
            ["Ankle strength.", "Calf size."],
            ["Gastrocnemius"]),

        // ==================== MOBILITY & WARMUP (DETAILED) ====================
        createEx("Cat-Cow", ["Core"], "Bodyweight", "Mobility",
            ["Start on hands and knees (Tabletop).", "Neutral spine."],
            ["Arch back up towards ceiling (Cat) and exhale.", "Sag belly down towards floor (Cow) and inhale.", "Look up."],
            ["Move with your breath.", "Articulate each vertebrae."],
            ["Spine health.", "Warmup."],
            ["Spine"]),

        createEx("Dead Bug", ["Core"], "Bodyweight", "Mobility",
            ["Lie on back.", "Arms and legs in air (90 degrees).", "Back flat on floor."],
            ["Lower opposite arm and leg towards floor.", "Keep lower back glued to floor.", "Return."],
            ["If back arches, don't go as low.", "Breathe out as you extend."],
            ["Core control.", "Anti-extension."],
            ["Core", "Hip Flexors"]),

        createEx("Thoracic Extension", ["Back"], "Bodyweight", "Mobility",
            ["Place foam roller on upper back.", "Hips on floor."],
            ["Lean back over roller.", "Hands behind head for support.", "Open chest."],
            ["Relax into the stretch.", "Move roller up/down spine."],
            ["Fixes desk posture.", "Shoulder mobility."],
            ["Thoracic Spine"]),

        createEx("World's Greatest Stretch", ["Full Body"], "Bodyweight", "Mobility", 
            ["Start in a high plank position.", "Step left foot outside left hand.", "Keep back leg straight and strong."],
            ["Rotate left arm up to ceiling, looking at hand.", "Bring elbow down toward floor inside foot.", "Switch sides."],
            ["Move slowly and deliberately.", "Breathe deep into the tight spots."],
            ["Opens hips, t-spine, and ankles.", "The ultimate warmup."],
            ["Hips", "Thoracic Spine", "Hamstrings"]),

        createEx("90/90 Hip Switch", ["Legs"], "Bodyweight", "Mobility", 
            ["Sit on floor.", "Front leg bent 90¬∞ in front, back leg 90¬∞ to side.", "Torso upright."],
            ["Rotate hips to switch leg positions to the other side.", "Keep heels driven into the floor.", "Try not to use hands for support."],
            ["Stay tall through the spine.", "Move from the hips, not the lower back."],
            ["Internal and external hip rotation.", "Unlocks tight hips."],
            ["Glutes", "Hip Rotators"]),

        createEx("Shoulder Dislocates", ["Shoulders"], "Bodyweight", "Mobility", 
            ["Hold a broomstick or band with a very wide grip.", "Arms straight."],
            ["Raise arms over head and behind back.", "Touch lower back/glutes.", "Return over head to front."],
            ["Do not bend elbows.", "Shrug shoulders at the top if needed."],
            ["Shoulder girdle mobility.", "Chest opener."],
            ["Shoulders", "Pecs"]),

        createEx("Wall Slides", ["Shoulders"], "Bodyweight", "Mobility", 
            ["Stand with back against a wall.", "Feet 6 inches away.", "Press lower back, head, elbows, and wrists into wall."],
            ["Slide arms up into a 'W' then 'Y' shape.", "Maintain contact with wall at all times.", "Slide back down."],
            ["Don't let lower back arch.", "Tuck chin."],
            ["Scapular control.", "Posture correction."],
            ["Lower Traps", "External Rotators"]),

        createEx("Deep Squat Hold", ["Legs"], "Bodyweight", "Mobility", 
            ["Stand shoulder width.", "Hold a weight plate for counterbalance if needed."],
            ["Squat as deep as anatomically possible.", "Keep heels flat.", "Chest up."],
            ["Hold for 30-60 seconds.", "Use elbows to push knees out."],
            ["Ankle mobility.", "Hip opening."],
            ["Hips", "Ankles"]),

        createEx("Couch Stretch", ["Legs"], "Bodyweight", "Mobility", 
            ["Place knee against base of a wall/couch.", "Shin vertical up the wall.", "Other foot lunges forward."],
            ["Squeeze glute of the back leg.", "Raise torso upright.", "Hold."],
            ["Don't hyperextend lower back.", "Squeeze abs."],
            ["Fixes tight hip flexors from sitting.", "Quad stretch."],
            ["Hip Flexors", "Quads"]),

        createEx("Bird Dog", ["Core"], "Bodyweight", "Mobility", 
            ["Start on hands and knees (Tabletop).", "Neutral spine."],
            ["Reach opposite arm and leg straight out.", "Hold for 3s.", "Switch sides."],
            ["Imagine balancing a glass of water on your back.", "Don't rotate hips."],
            ["Core stability.", "Anti-rotation."],
            ["Core", "Glutes", "Shoulders"]),

        // ==================== CABLE VARIATIONS (TORQUE F9 DETAILED) ====================
        createEx("Cable Front Squat", ["Legs"], "Cable", "Strength", 
            ["Set Pulleys Low. Arms Narrow.", "Hold bar/handles at collarbone (rack position).", "Elbows high."],
            ["Squat deep.", "Keep torso vertical.", "Drive up."],
            ["Core works hard to stay upright.", "Fight the pull forward."],
            ["Quad dominance.", "Core strength."],
            ["Quadriceps", "Core"], {arms: "Narrow", pulleys: "Low"}),

        createEx("Cable Zercher Squat", ["Legs"], "Cable", "Strength", 
            ["Set Pulleys Low. Arms Narrow.", "Hold straight bar in crooks of elbows.", "Hands clasped."],
            ["Squat down.", "Keep bar close to body.", "Drive up."],
            ["Brutal on core and upper back.", "Bicep isometric."],
            ["Upper back strength.", "Leg drive."],
            ["Quadriceps", "Upper Back"], {arms: "Narrow", pulleys: "Low"}),

        createEx("Cable Donkey Kick", ["Legs", "Glutes"], "Cable", "Muscle Build", 
            ["Set Pulley Low. Ankle strap.", "Hands on machine for support.", "Bent over."],
            ["Keep knee bent 90¬∞.", "Drive heel up to ceiling.", "Squeeze."],
            ["Don't extend knee.", "Movement comes from hip."],
            ["Upper glute focus.", "Shelf builder."],
            ["Glute Maximus"], {arms: "Narrow", pulleys: "Low"}),

        createEx("Standing Cable Row", ["Back"], "Cable", "Strength", 
            ["Set Pulleys Mid. Arms Mid.", "Squat stance.", "Reach forward."],
            ["Row handles to ribs.", "Stand up slightly as you pull (dynamic).", "Sink back on return."],
            ["Use legs to stabilize.", "Fluid motion."],
            ["Functional pulling.", "Athleticism."],
            ["Latissimus Dorsi", "Legs", "Core"], {arms: "Mid", pulleys: "Mid"}),

        createEx("Lying Cable Curl", ["Arms", "Biceps"], "Cable", "Muscle Build", 
            ["Set Pulley Low. Short Bar.", "Lie on back.", "Feet braced on machine."],
            ["Curl bar to forehead/chin.", "Keep elbows fixed.", "Lower."],
            ["Strict isolation.", "No cheating."],
            ["Bicep peaks.", "Form strictness."],
            ["Biceps"], {arms: "Narrow", pulleys: "Low"}),

        createEx("Cable French Press", ["Arms", "Triceps"], "Cable", "Muscle Build", 
            ["Set Pulley Low. Rope/Bar.", "Bench/Kneel facing away.", "Arms overhead."],
            ["Bend elbows to lower weight behind head.", "Extend to ceiling.", "Keep elbows close."],
            ["Deep stretch.", "Long head focus."],
            ["Tricep size.", "Overhead strength."],
            ["Triceps (Long Head)"], {arms: "Narrow", pulleys: "Low"}),

        createEx("Cable Hip Abduction (Standing)", ["Legs"], "Cable", "Mobility", 
            ["Set Pulley Low. Ankle strap.", "Stand sideways.", "Outer leg attached."],
            ["Lift leg out to side.", "Keep toes forward.", "Return."],
            ["Don't lean away.", "Use glute medius."],
            ["Hip stability.", "Glute shape."],
            ["Glute Medius"], {arms: "Low", pulleys: "Low"}),

        createEx("Cable Hip Adduction (Standing)", ["Legs"], "Cable", "Mobility", 
            ["Set Pulley Low. Ankle strap.", "Stand sideways.", "Inner leg attached."],
            ["Pull leg across body.", "Squeeze inner thigh.", "Return."],
            ["Balance on outer leg."],
            ["Adductor strength.", "Injury prevention."],
            ["Adductors"], {arms: "Low", pulleys: "Low"}),

        createEx("Cable Wrist Curl", ["Arms"], "Cable", "Muscle Build", 
            ["Set Pulley Low. Short bar.", "Sit on bench/floor.", "Forearms on knees."],
            ["Curl wrists up.", "Squeeze.", "Lower."],
            ["Range of motion is small."],
            ["Forearm size.", "Grip."],
            ["Flexors"], {arms: "Narrow", pulleys: "Low"}),

        createEx("Cable Reverse Wrist Curl", ["Arms"], "Cable", "Muscle Build", 
            ["Set Pulley Low. Short bar.", "Palms facing down."],
            ["Extend wrists up.", "Hold.", "Lower."],
            ["Burn is high."],
            ["Top of forearm.", "Elbow health."],
            ["Extensors"], {arms: "Narrow", pulleys: "Low"}),

        // ==================== PART 3: CARDIO, CORE & VARIATIONS (FINAL 40) ====================
        
        // --- ABS & CORE ---
        createEx("Russian Twist", ["Core"], "Bodyweight", "Calisthenics", 
            ["Sit on floor.", "Lean back 45 deg.", "Feet off floor."],
            ["Rotate torso left.", "Touch floor.", "Rotate right."],
            ["Control the twist.", "Oblique focus."],
            ["Rotational core strength."],
            ["Obliques"]),
        createEx("Bicycle Crunch", ["Core"], "Bodyweight", "Calisthenics", 
            ["Lie flat.", "Hands behind head."],
            ["Elbow to opposite knee.", "Extend other leg."],
            ["Slow and controlled.", "Don't pull neck."],
            ["Full abdominal wall."],
            ["Rectus Abdominis", "Obliques"]),
        createEx("Flutter Kicks", ["Core"], "Bodyweight", "Calisthenics", 
            ["Lie flat.", "Hands under butt.", "Legs straight."],
            ["Kick legs up and down.", "Keep lower back pressed down."],
            ["Small range of motion."],
            ["Lower abs endurance."],
            ["Lower Abs"]),
        createEx("V-Ups", ["Core"], "Bodyweight", "Calisthenics", 
            ["Lie flat.", "Arms overhead."],
            ["Lift arms and legs to touch toes.", "Body forms V."],
            ["Explosive up.", "Control down."],
            ["Advanced core strength."],
            ["Rectus Abdominis"]),
        createEx("Reverse Crunch", ["Core"], "Bodyweight", "Calisthenics", 
            ["Lie back.", "Knees bent 90 deg."],
            ["Curl hips off floor.", "Knees to chest.", "Lower."],
            ["Don't use momentum.", "Focus on hips curling."],
            ["Lower ab isolation."],
            ["Lower Abs"]),
        createEx("Plank Jack", ["Core", "Cardio"], "Bodyweight", "Calisthenics", 
            ["Plank position."],
            ["Jump feet wide.", "Jump feet together."],
            ["Keep hips level."],
            ["Core conditioning."],
            ["Core"]),
        createEx("Toe Touch", ["Core"], "Bodyweight", "Calisthenics", 
            ["Lie back.", "Legs straight up."],
            ["Crunch up to touch toes.", "Lower."],
            ["Keep legs vertical."],
            ["Upper abs."],
            ["Upper Abs"]),

        // --- PUSHUP VARIATIONS ---
        createEx("Diamond Push-up", ["Arms", "Chest"], "Bodyweight", "Calisthenics", 
            ["Hands form diamond shape.", "Under sternum."],
            ["Lower chest to hands.", "Push up."],
            ["Keep elbows tucked."],
            ["Tricep mass."],
            ["Triceps", "Inner Chest"]),
        createEx("Wide Grip Push-up", ["Chest"], "Bodyweight", "Calisthenics", 
            ["Hands wider than shoulders."],
            ["Lower down.", "Push up."],
            ["Less tricep, more chest."],
            ["Outer chest."],
            ["Pectoralis Major"]),
        createEx("Decline Push-up", ["Chest"], "Bodyweight", "Calisthenics", 
            ["Feet on bench/chair.", "Hands on floor."],
            ["Push up motion."],
            ["Harder variation."],
            ["Upper chest focus."],
            ["Upper Pecs"]),
        createEx("Incline Push-up", ["Chest"], "Bodyweight", "Calisthenics", 
            ["Hands on bench.", "Feet on floor."],
            ["Push up motion."],
            ["Easier variation."],
            ["Lower chest."],
            ["Lower Pecs"]),
        createEx("Scapular Push-up", ["Back", "Shoulders"], "Bodyweight", "Mobility", 
            ["Plank position.", "Arms locked straight."],
            ["Squeeze shoulder blades together.", "Push them apart."],
            ["Tiny range of motion.", "Straight arms."],
            ["Shoulder health."],
            ["Serratus Anterior"]),

        // --- LEG VARIATIONS ---
        createEx("Sumo Squat (DB)", ["Legs"], "Dumbbell", "Strength", 
            ["Wide stance.", "Toes out.", "Hold DB between legs."],
            ["Squat deep.", "Knees track over toes."],
            ["Upright torso."],
            ["Inner thigh focus."],
            ["Adductors", "Quads"]),
        createEx("Curtsy Lunge", ["Legs"], "Bodyweight", "Calisthenics", 
            ["Stand tall."],
            ["Step leg behind and across.", "Lunge down."],
            ["Hip stability."],
            ["Glute medius."],
            ["Glutes"]),
        createEx("Side Lunge", ["Legs"], "Bodyweight", "Calisthenics", 
            ["Step wide to side.", "Keep other leg straight."],
            ["Sit hips back on bent leg.", "Return."],
            ["Inner thigh stretch."],
            ["Lateral movement."],
            ["Adductors", "Quads"]),
        createEx("Single Leg Glute Bridge", ["Legs", "Glutes"], "Bodyweight", "Calisthenics", 
            ["Lie back.", "One leg up.", "One foot flat."],
            ["Drive hip up.", "Squeeze glute.", "Lower."],
            ["Don't twist hips."],
            ["Glute isolation."],
            ["Glutes"]),
        createEx("Good Morning (BW)", ["Legs"], "Bodyweight", "Mobility", 
            ["Hands behind head.", "Knees soft."],
            ["Hinge hips back.", "Back flat.", "Stand up."],
            ["Feel hamstring stretch."],
            ["Hinge pattern practice."],
            ["Hamstrings", "Lower Back"]),

        // --- CARDIO & PLYO ---
        createEx("Jumping Jacks", ["Cardio"], "Bodyweight", "Calisthenics", 
            ["Stand tall."],
            ["Jump feet wide, hands up.", "Jump back."],
            ["Rhythmic."],
            ["Warmup."],
            ["Full Body"]),
        createEx("High Knees", ["Cardio"], "Bodyweight", "Calisthenics", 
            ["Run in place."],
            ["Drive knees to waist height."],
            ["Fast pace."],
            ["Heart rate."],
            ["Legs", "Cardio"]),
        createEx("Jump Squat", ["Legs", "Cardio"], "Bodyweight", "Calisthenics", 
            ["Squat down."],
            ["Explode up.", "Jump off floor.", "Land soft."],
            ["Power."],
            ["Leg power."],
            ["Quads"]),
        createEx("Skater Hops", ["Cardio", "Legs"], "Bodyweight", "Calisthenics", 
            ["Hop sideways to one foot.", "Swing other leg behind."],
            ["Explode back to other side."],
            ["Lateral power."],
            ["Athleticism."],
            ["Glutes", "Cardio"]),
        createEx("Jumping Lunge", ["Legs", "Cardio"], "Bodyweight", "Calisthenics", 
            ["Lunge position."],
            ["Jump and switch legs in air.", "Land in lunge."],
            ["Advanced."],
            ["Leg burn."],
            ["Quads", "Cardio"]),
        createEx("Box Jump", ["Legs"], "Bodyweight", "Calisthenics", 
            ["Stand before box."],
            ["Jump onto box.", "Stand tall.", "Step down."],
            ["Explosive hips."],
            ["Power."],
            ["Quads", "Glutes"]),

        // --- BACK & ARM VARIATIONS ---
        createEx("Superman", ["Back"], "Bodyweight", "Calisthenics", 
            ["Lie on stomach.", "Arms forward."],
            ["Lift arms and legs off floor.", "Hold.", "Lower."],
            ["Squeeze lower back."],
            ["Posterior chain."],
            ["Lower Back", "Glutes"]),
        createEx("Swimmers", ["Back"], "Bodyweight", "Calisthenics", 
            ["Lie on stomach."],
            ["Paddle opposite arm/leg up and down."],
            ["Keep off floor."],
            ["Endurance."],
            ["Lower Back"]),
        createEx("Bench Dip", ["Arms", "Triceps"], "Bodyweight", "Calisthenics", 
            ["Hands on bench behind you.", "Legs straight out."],
            ["Lower hips.", "Push up."],
            ["Don't go too deep."],
            ["Tricep burnout."],
            ["Triceps"]),
        createEx("Close Grip Push-up", ["Arms", "Triceps"], "Bodyweight", "Calisthenics", 
            ["Hands inside shoulder width."],
            ["Elbows rub ribs.", "Push up."],
            ["Tricep focus."],
            ["Arm size."],
            ["Triceps"]),
        createEx("Plate Pinch", ["Arms"], "Free Weight", "Strength", 
            ["Hold weight plates in fingertips."],
            ["Walk or hold for time."],
            ["Don't use thumbs if possible."],
            ["Forearm strength."],
            ["Forearms"]),
        createEx("Svend Press", ["Chest"], "Free Weight", "Strength", 
            ["Stand.", "Squeeze plate between palms at chest."],
            ["Press out.", "Keep squeezing hard.", "Return."],
            ["Inner chest activation."],
            ["Isometric squeeze."],
            ["Inner Pecs"]),
        
        // --- FINAL CABLE VARIATIONS ---
        createEx("Cable Curl (Behind Back)", ["Arms", "Biceps"], "Cable", "Muscle Build", 
            ["Set Low. Face away.", "One hand handle."],
            ["Arm behind body.", "Curl forward."],
            ["Stretch focus."],
            ["Bicep length."],
            ["Biceps"], {arms: "Low", pulleys: "Low"}),
        createEx("Cable Row (Wide Grip)", ["Back"], "Cable", "Strength", 
            ["Set Low. Wide bar.", "Sit."],
            ["Row to upper abs.", "Elbows wide."],
            ["Upper back focus."],
            ["Width."],
            ["Rear Delts", "Rhomboids"], {arms: "Narrow", pulleys: "Low"}),
        createEx("Standing Cable Crunch", ["Core"], "Cable", "Muscle Build", 
            ["Set High. Rope.", "Face away."],
            ["Crunch forward.", "Elbows to chest."],
            ["Standing abs."],
            ["Core."],
            ["Abs"], {arms: "Narrow", pulleys: "Top"}),
        // ==================== NIMBLE / LONGEVITY / FLOW (NEW 25) ====================
        
        // --- ANIMAL FLOW & GROUND ---
        createEx("Bear Crawl", ["Nimble", "Core"], "Bodyweight", "Mobility", 
            ["Hands and knees.", "Knees hover 1 inch off floor."], ["Crawl forward opposite hand/foot.", "Keep back flat."], ["Imagine a glass of water on your back."], ["Shoulder stability.", "Core."], ["Core", "Shoulders"]),
        createEx("Crab Walk", ["Nimble", "Shoulders"], "Bodyweight", "Mobility", 
            ["Sit on floor.", "Hands behind hips.", "Lift hips."], ["Walk backwards/forwards."], ["Open chest.", "Squeeze glutes."], ["Posterior chain.", "Shoulder mobility."], ["Triceps", "Glutes"]),
        createEx("Kick Through", ["Nimble", "Core"], "Bodyweight", "Mobility", 
            ["Bear crawl position."], ["Rotate hips.", "Kick leg through to side.", "Lift opposite hand."], ["Pivot on foot."], ["Rotational agility."], ["Obliques", "Hips"]),
        createEx("Beast Reach", ["Nimble", "Back"], "Bodyweight", "Mobility", 
            ["Loaded Beast (Child's pose but knees off floor)."], ["Wave forward into plank.", "Drive one knee to elbow.", "Return."], ["Flow smoothly."], ["Spine wave."], ["Spine", "Core"]),
        createEx("Duck Walk", ["Nimble", "Legs"], "Bodyweight", "Mobility", 
            ["Deep squat position."], ["Walk forward staying low."], ["Keep chest up.", "Heels can lift."], ["Ankle mobility.", "Hip strength."], ["Quads", "Ankles"]),

        // --- JOINT BULLETPROOFING ---
        createEx("Tibialis Raise", ["Nimble", "Legs"], "Bodyweight", "Strength", 
            ["Lean butt against wall.", "Legs straight out."], ["Lift toes to shins.", "Lower."], ["Feel burn in shins."], ["Bulletproof knees.", "Shin splint help."], ["Tibialis Anterior"]),
        createEx("ATG Split Squat", ["Nimble", "Legs"], "Bodyweight", "Mobility", 
            ["Long lunge stance."], ["Push front knee WAY over toe.", "Back leg straight."], ["Cover calf with hamstring."], ["Ankle/Hip mobility."], ["VMO", "Hip Flexors"]),
        createEx("Lu Raise", ["Nimble", "Shoulders"], "Dumbbell", "Mobility", 
            ["Light plates/DBs.", "Stand tall."], ["Lateral raise ALL the way overhead.", "Touch plates at top."], ["Control down."], ["Full scapular movement."], ["Side Delts", "Traps"]),
        createEx("Powell Raise", ["Nimble", "Shoulders"], "Dumbbell", "Strength", 
            ["Lie on side.", "Top arm holds DB."], ["Raise straight arm to vertical."], ["Control down across chest."], ["Scapular health."], ["Rear Delts", "Rhomboids"]),
        createEx("Wrist Rocks", ["Nimble", "Arms"], "Bodyweight", "Mobility", 
            ["Hands and knees.", "Fingers forward/back/side."], ["Rock weight gently over wrists."], ["Elbows locked."], ["Wrist prep for pushups."], ["Forearms"]),
        createEx("Dead Hang", ["Nimble", "Back"], "Bodyweight", "Strength", 
            ["Grab pullup bar."], ["Hang completely loose.", "Relax shoulders."], ["Deep breaths."], ["Spine decompression.", "Grip."], ["Lats", "Forearms"]),

        // --- DYNAMIC MOBILITY ---
        createEx("Cossack Squat", ["Nimble", "Legs"], "Bodyweight", "Mobility", 
            ["Wide stance.", "Toes out."], ["Squat to ONE side.", "Other leg straight, toe up."], ["Stay low, switch sides."], ["Hip mobility.", "Groin."], ["Adductors", "Quads"]),
        createEx("Jefferson Curl", ["Nimble", "Back"], "Bodyweight", "Mobility", 
            ["Stand tall.", "Hold light weight (optional)."], ["Tuck chin.", "Roll down one vertebrae at a time.", "Reach floor."], ["Roll up slow."], ["Spine articulation."], ["Spine", "Hamstrings"]),
        createEx("Scorpion Stretch", ["Nimble", "Back"], "Bodyweight", "Mobility", 
            ["Lie on stomach.", "Arms wide."], ["Kick one leg up and over to opposite hand."], ["Touch floor."], ["Dynamic hip/spine twist."], ["Hips", "Spine"]),
        createEx("Inchworm", ["Nimble", "Core"], "Bodyweight", "Mobility", 
            ["Stand.", "Hinge to floor."], ["Walk hands out to plank.", "Walk feet to hands."], ["Keep legs straight."], ["Hamstring stretch."], ["Hamstrings", "Shoulders"]),
        createEx("Thoracic Bridge", ["Nimble", "Back"], "Bodyweight", "Mobility", 
            ["Sit on floor.", "Hands behind."], ["Drive hips up.", "Reach one arm overhead and across."], ["Look at hand."], ["T-Spine opener."], ["Spine", "Glutes"]),

        // --- AGILITY & PROPRIOCEPTION ---
        createEx("Single Leg RDL (BW)", ["Nimble", "Legs"], "Bodyweight", "Strength", 
            ["Stand on one leg."], ["Hinge forward.", "Extend back leg straight."], ["Body creates 'T' shape.", "Return."], ["Balance.", "Hamstring."], ["Hamstrings", "Glutes"]),
        createEx("Lateral Bounds", ["Nimble", "Cardio"], "Bodyweight", "Plyo", 
            ["Stand on right leg."], ["Jump laterally to left leg.", "Stick the landing."], ["Pause.", "Jump back."], ["Lateral power.", "Stability."], ["Glutes", "Adductors"]),
        createEx("Dot Drill", ["Nimble", "Cardio"], "Bodyweight", "Plyo", 
            ["Imagine 5 dots (dice 5)."], ["Hop feet between dots fast."], ["pattern variations."], ["Fast feet."], ["Calves", "Coordination"]),
        createEx("Tuck Jumps", ["Nimble", "Cardio"], "Bodyweight", "Plyo", 
            ["Stand tall."], ["Jump high.", "Tuck knees to chest."], ["Land soft.", "Repeat fast."], ["Explosive power."], ["Quads", "Core"]),
        createEx("A-Skips", ["Nimble", "Cardio"], "Bodyweight", "Plyo", 
            ["Skip forward."], ["Drive knee high.", "Drive opposite arm."], ["Rhythm and bounce."], ["Sprinting mechanics."], ["Hip Flexors", "Calves"]),

        // --- ISOMETRIC & TENDON ---
        createEx("Horse Stance Hold", ["Nimble", "Legs"], "Bodyweight", "Strength", 
            ["Wide stance.", "Squat until thighs parallel."], ["Back vertical.", "Knees out."], ["Hold for time."], ["Mental toughness.", "Hips."], ["Quads", "Adductors"]),
        createEx("Reverse Plank", ["Nimble", "Core"], "Bodyweight", "Strength", 
            ["Sit legs straight.", "Hands behind hips."], ["Drive hips to ceiling.", "Straight line."], ["Squeeze glutes."], ["Posterior chain."], ["Lower Back", "Glutes"]),
        createEx("Copenhagen Plank", ["Nimble", "Legs"], "Bodyweight", "Strength", 
            ["Side plank.", "Top leg on bench.", "Bottom leg floating."], ["Hold."], ["Brutal inner thigh work."], ["Groin health."], ["Adductors"]),
        createEx("L-Sit (Tuck)", ["Nimble", "Core"], "Bodyweight", "Calisthenics", 
            ["Hands on floor/parallettes."], ["Press down.", "Lift butt and knees off floor."], ["Hold tuck."], ["Core compression."], ["Abs", "Hip Flexors"])
]; // END EXERCISE DATA
</script>

<script>
// 1. SAFETY CHECK
if(typeof window.allExercises === 'undefined') {
    alert("CRITICAL ERROR: Exercise list failed to load. Check for syntax errors (missing commas/quotes) in your list.");
    window.allExercises = []; // Prevent total crash
}


// ========================================
// GLOBAL STATE
// ========================================
let appState = {
    currentWorkout: null,
    currentSetIndex: {},
    activePlan: null,
    equipment: 'home',
    voiceEnabled: true,
    voiceLevel: 'standard',
    selectedExercises: [],
    exerciseCount: 6,
    builderFilter: 'all'
};

// ========================================
// INITIALIZATION
// ========================================
// ========================================
// PRE-LOADED EXERCISE IMAGES (50 exercises)
// Generated: 2026-01-29
// ========================================

const preloadedImages = {
    'gif_Arnold Press': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Arnold-Press.gif',
    'gif_Barbell Curl': 'https://cdn.shopify.com/s/files/1/0618/9462/3460/files/cable-curls.gif?v=1741771141',
    'gif_Barbell Row': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Barbell-Bent-Over-Row.gif',
    'gif_Bench Press': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Barbell-Bench-Press.gif',
    'gif_Bodyweight Squat': 'https://www.inspireusafoundation.org/file/2023/08/bodyweight-squat-example.png',
    'gif_Bulgarian Split Squat': 'https://www.inspireusafoundation.org/file/2022/03/bulgarian-split-spuat.gif',
    'gif_Cable Bicep Curl': 'https://cdn.shopify.com/s/files/1/0618/9462/3460/files/cable-curls.gif?v=1741771141',
    'gif_Cable Chest Fly (High)': 'https://www.inspireusafoundation.org/wp-content/uploads/2023/08/high-cable-fly.gif',
    'gif_Cable Chest Fly (Low)': 'https://cdn.shopify.com/s/files/1/0618/9462/3460/files/4324d0a44439cc85146e9db778f65f2a_cable_low_fly_gif___Google_Search.gif?v=1742448445',
    'gif_Cable Chest Press': 'https://fitliferegime.com/wp-content/uploads/2023/07/Standing-Cable-Chest-Press.gif',
    'gif_Cable Lateral Raise': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Cable-Lateral-Raise.gif',
    'gif_Cable Overhead Press': 'https://www.inspireusafoundation.org/file/2022/04/military-press.gif',
    'gif_Cable Pull-Through': 'https://www.inspireusafoundation.org/file/2023/07/cable-pull-through.gif',
    'gif_Cable Rows': 'https://www.inspireusafoundation.org/file/2023/07/cable-wide-grip-row.gif',
    'gif_Cable Squat': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/BARBELL-SQUAT.gif',
    'gif_Chin-ups': 'https://www.inspireusafoundation.org/file/2022/09/chin-ups.gif',
    'gif_Deadlift': 'https://www.inspireusafoundation.org/file/2022/02/barbell-deadlift-movement.gif',
    'gif_Dips': 'https://fitnessprogramer.com/wp-content/uploads/2021/04/CHAIR-DIPS.gif',
    'gif_Dumbbell Bench Press': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Dumbbell-Press.gif',
    'gif_Dumbbell Curl': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Dumbbell-Curl.gif',
    'gif_Dumbbell Fly': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Incline-dumbbell-Fly.gif',
    'gif_Dumbbell Incline Press': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Incline-Dumbbell-Press.gif',
    'gif_Dumbbell Lunge': 'https://fitnessprogramer.com/wp-content/uploads/2023/09/dumbbell-lunges.gif',
    'gif_Dumbbell Press': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Dumbbell-Press.gif',
    'gif_Dumbbell Row': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Dumbbell-Row.gif',
    'gif_Dumbbell Shoulder Press': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Dumbbell-Shoulder-Press.gif',
    'gif_Face Pulls': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Face-Pull.gif',
    'gif_Front Raise': 'https://www.inspireusafoundation.org/file/2022/01/cable-front-raise-movement.gif',
    'gif_Glute Bridge': 'https://www.inspireusafoundation.org/file/2022/12/glute-bridge.gif',
    'gif_Goblet Squat': 'https://fitnessprogramer.com/wp-content/uploads/2021/05/Cable-Squat.gif',
    'gif_Hammer Curl': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Hammer-Curl.gif',
    'gif_Incline Press': 'https://liftmanual.com/wp-content/uploads/2023/04/cable-incline-bench-press.webp',
    'gif_Lat Pulldown (Standing)': 'https://ccuuubmtdurkmbeufybi.supabase.co/storage/v1/object/public/animations/0238.gif',
    'gif_Lateral Raise': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Cable-Lateral-Raise.gif',
    'gif_Leg Curl': 'https://liftmanual.com/wp-content/uploads/2023/04/cable-standing-leg-curl.gif',
    'gif_Leg Extension': 'https://www.inspireusafoundation.org/file/2021/06/leg-extension-machine.gif',
    'gif_Leg Press': 'https://fitnessprogramer.com/wp-content/uploads/2021/05/Cable-Squat.gif',
    'gif_Lunges': 'https://fitnessprogramer.com/wp-content/uploads/2025/09/pendulum-lunge.gif',
    'gif_Mountain Climbers': 'https://homeworkouts.org/wp-content/uploads/anim-mountain-climbers.gif',
    'gif_Overhead Press': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Dumbbell-Shoulder-Press.gif',
    'gif_Planks': 'https://www.inspireusafoundation.org/file/2022/01/plank.gif',
    'gif_Pull-ups': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Pull-up.gif',
    'gif_Push-ups': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Push-Up.gif',
    'gif_Romanian Deadlift': 'https://www.inspireusafoundation.org/file/2021/11/dumbbell-romanian-deadlift.gif',
    'gif_Romanian Deadlift (DB)': 'https://www.inspireusafoundation.org/file/2021/11/dumbbell-romanian-deadlift.gif',
    'gif_Seated Cable Row': 'https://www.inspireusafoundation.org/file/2022/08/cable-seated-row.gif',
    'gif_Squat': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/BARBELL-SQUAT.gif',
    'gif_Straight Arm Pulldown': 'https://ccuuubmtdurkmbeufybi.supabase.co/storage/v1/object/public/animations/0238.gif',
    'gif_Tricep Extension': 'https://fitnessvolt.com/wp-content/uploads/2023/09/v-bar-tricep-pushdown.gif',
    'gif_Tricep Pushdown (Rope)': 'https://fitnessprogramer.com/wp-content/uploads/2021/06/Rope-Pushdown.gif'
};

function loadPreloadedImages() {
    Object.keys(preloadedImages).forEach(key => {
        if(!localStorage.getItem(key)) {
            localStorage.setItem(key, preloadedImages[key]);
            console.log('‚úÖ Loaded: ' + key);
        }
    });
    console.log('‚úÖ Pre-loaded 50 exercise images');
}

window.onload = () => {
    loadAppState();
    loadPreloadedImages(); // ‚Üê Load exercise GIFs
    renderPlanCalendar();
    renderEquipmentPresets();
    updateTodaysBanner();
    renderEncyclopedia();
    updateSettingsUI();
};

function loadAppState() {
    const saved = localStorage.getItem('nimbleState_v45');
    if(saved) {
        try {
            appState = {...appState, ...JSON.parse(saved)};
        } catch(e) {}
    }
    if(!appState.activePlan) {
        appState.activePlan = createDefaultPlan();
    }
}

function saveAppState() {
    localStorage.setItem('nimbleState_v45', JSON.stringify(appState));
}

function createDefaultPlan() {
    return {
        name: '5-Day Balanced',
        frequency: 5,
        schedule: {0:'rest',1:'push',2:'cardio',3:'pull',4:'rest',5:'legs',6:'nimble'},
        week: 1,
        phase: 'Foundation'
    };
}

// ========================================
// NAVIGATION
// ========================================
function switchTab(tab) {
    document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    
    const container = document.getElementById('view-' + tab);
    if(container) container.classList.add('active');
    
    if(event?.target) {
        const btn = event.target.closest('.nav-btn');
        if(btn) btn.classList.add('active');
    }
    
    if(tab === 'plan') renderPlanCalendar();
    if(tab === 'cardio') loadCardioHistory();
    if(tab === 'encyclopedia') renderEncyclopedia();
    if(tab === 'settings') updateSettingsUI();
}

// ========================================
// WORKOUT GENERATION
// ========================================
function quickStartWorkout(type) {
    const exercises = generateWorkoutByType(type, appState.exerciseCount);
    
    // Store workout type for warmup
    appState.currentWorkoutType = type;
    appState.currentWorkout = exercises;
    appState.currentSetIndex = {};
    saveAppState();
    
    // Start warmup for push/pull/legs workouts
    if(['push', 'pull', 'legs'].includes(type.toLowerCase())) {
        startWarmup(type);
        renderWorkout(exercises);
    } else {
        startWorkout(exercises);
    }
}

function updateExerciseCount(value) {
    appState.exerciseCount = parseInt(value);
    document.getElementById('exercise-count-display').textContent = value;
    saveAppState();
}

function generateRandomWorkout() {
    const types = ['push', 'pull', 'legs'];
    const randomType = types[Math.floor(Math.random() * types.length)];
    quickStartWorkout(randomType);
}

function generateWorkoutByType(type, count = 6) {
    let filtered = window.allExercises.filter(ex => {
        if(type === 'push') return ex.cat.some(c => ['Chest','Shoulders','Triceps'].includes(c));
        if(type === 'pull') return ex.cat.some(c => ['Back','Lats','Biceps'].includes(c));
        if(type === 'legs') return ex.cat.some(c => ['Legs','Quads','Hamstrings','Glutes'].includes(c));
        if(type === 'nimble') return ex.cat.includes('Nimble') || ex.type === 'Mobility';
        if(type === 'full') return true;
        return true;
    });
    
    // Apply equipment filter
    filtered = filterExercisesByEquipment(filtered);
    
    // Shuffle and take count
    filtered.sort(() => 0.5 - Math.random());
    return filtered.slice(0, count);
}

function filterExercisesByEquipment(exercises) {
    const presets = {
        home: ['Cable', 'Dumbbell', 'Bodyweight', 'Bench', 'Bands'],
        hotel: ['Bodyweight', 'Bands'],
        gym: ['All']
    };
    
    const available = presets[appState.equipment] || presets.gym;
    if(available.includes('All')) return exercises;
    
    return exercises.filter(ex => 
        available.includes(ex.equip) || ex.equip === 'Bodyweight'
    );
}

function startWorkout(exercises) {
    appState.currentWorkout = exercises;
    appState.currentSetIndex = {};
    saveAppState();
    
    document.getElementById('workout-interface').style.display = 'block';
    document.getElementById('workout-interface').scrollIntoView({behavior:'smooth'});
    
    renderWorkout(exercises);
    speak('Workout started! Let\'s get it done!');
}

// ========================================
// PROGRESSIVE SET DISPLAY
// ========================================
function renderWorkout(exercises) {
    const container = document.getElementById('workout-list');
    container.innerHTML = '';
    
    exercises.forEach((ex, idx) => {
        const card = document.createElement('div');
        card.className = 'card exercise-card';
        
        const progression = getProgression(ex.name);
        const setsCompleted = appState.currentSetIndex[ex.name] || 0;
        const setData = getTodaysSetData(ex.name);
        
        let html = `
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div>
                    <h3 style="margin:0;">${ex.name}</h3>
                    <div class="text-muted">${ex.cat.join(', ')} ‚Ä¢ ${ex.equip}</div>
                </div>
                <div style="text-align:right;">
                    ${progression.suggest ? `<div class="progression-badge">${progression.suggest}</div>` : ''}
                    <button class="btn-small btn-action" onclick="viewExerciseDetails('${ex.name.replace(/'/g,"\\'")}')">
                        ‚ÑπÔ∏è
                    </button>
                </div>
            </div>
        `;
        
        if(progression.lastWorkout) {
            html += `<div style="background:#1a1a1a; padding:8px; border-radius:6px; margin-bottom:10px; font-size:0.85em;">
                üìä Last: ${progression.lastWorkout.weight} lbs √ó ${progression.lastWorkout.reps.join(',')} reps
            </div>`;
        }
        
        // Completed sets
        for(let i = 0; i < setsCompleted; i++) {
            const set = setData[i];
            if(set) {
                html += `<div class="set-completed">
                    <span>‚úÖ Set ${i+1}: ${set.weight} lbs √ó ${set.reps} reps</span>
                </div>`;
            }
        }
        
        // Current set
        if(setsCompleted < 3) {
            const suggestedWeight = progression.suggestedWeight || 100;
            html += `
                <div class="set-active">
                    <strong>Set ${setsCompleted + 1} of 3</strong>
                    <div class="row" style="margin-top:10px;">
                        <div style="flex:1;">
                            <small class="text-muted">Weight (lbs)</small>
                            <input type="number" id="weight-${idx}" value="${suggestedWeight}" step="5">
                        </div>
                        <div style="flex:1;">
                            <small class="text-muted">Reps</small>
                            <input type="number" id="reps-${idx}" value="10" step="1">
                        </div>
                    </div>
                    <button class="btn btn-main" onclick="logSet('${ex.name.replace(/'/g,"\\'")}', ${idx})">
                        ‚úì Log Set
                    </button>
                </div>
            `;
        } else {
            html += `<div style="text-align:center; padding:15px; background:#1a4d2e; border-radius:6px;">
                ‚úÖ Exercise Complete!
            </div>`;
        }
        
        card.innerHTML = html;
        container.appendChild(card);
    });
    
    // Check if all complete
    const allDone = exercises.every(ex => (appState.currentSetIndex[ex.name] || 0) >= 3);
    if(allDone) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-success';
        btn.textContent = 'üéâ Workout Complete!';
        btn.onclick = finishWorkout;
        container.appendChild(btn);
    }
}

function logSet(exerciseName, idx) {
    const weight = parseFloat(document.getElementById(`weight-${idx}`).value);
    const reps = parseInt(document.getElementById(`reps-${idx}`).value);
    
    if(!weight || !reps) {
        alert('Enter weight and reps');
        return;
    }
    
    // Save to history
    saveSetToHistory(exerciseName, {weight, reps, date: new Date().toISOString()});
    
    // Increment counter
    if(!appState.currentSetIndex[exerciseName]) appState.currentSetIndex[exerciseName] = 0;
    appState.currentSetIndex[exerciseName]++;
    
    saveAppState();
    renderWorkout(appState.currentWorkout);
    speak('Set logged!');
}

function saveSetToHistory(name, setData) {
    const today = new Date().toISOString().split('T')[0];
    let history = JSON.parse(localStorage.getItem('exerciseHistory')) || {};
    if(!history[name]) history[name] = [];
    history[name].push({...setData, sessionDate: today});
    localStorage.setItem('exerciseHistory', JSON.stringify(history));
}

function getTodaysSetData(name) {
    const today = new Date().toISOString().split('T')[0];
    const history = JSON.parse(localStorage.getItem('exerciseHistory')) || {};
    return (history[name] || []).filter(s => s.sessionDate === today);
}

function getProgression(name) {
    const history = JSON.parse(localStorage.getItem('exerciseHistory')) || {};
    const exerciseHistory = history[name] || [];
    
    if(exerciseHistory.length < 3) return {lastWorkout:null, suggest:null, suggestedWeight:100};
    
    const today = new Date().toISOString().split('T')[0];
    const past = exerciseHistory.filter(s => s.sessionDate !== today);
    
    if(past.length < 3) return {lastWorkout:null, suggest:null, suggestedWeight:100};
    
    // Get last 3 sets
    const lastSession = past.slice(-3);
    const avgWeight = lastSession.reduce((sum,s) => sum + s.weight, 0) / 3;
    const avgReps = lastSession.reduce((sum,s) => sum + s.reps, 0) / 3;
    
    let suggested = avgWeight;
    let hint = null;
    
    if(avgReps >= 10) {
        suggested = avgWeight + 5;
        hint = '+5 lbs';
    }
    
    return {
        lastWorkout: {weight: avgWeight, reps: lastSession.map(s => s.reps)},
        suggest: hint,
        suggestedWeight: Math.round(suggested)
    };
}

function endWorkout() {
    if(confirm('End workout early?')) {
        document.getElementById('workout-interface').style.display = 'none';
        appState.currentWorkout = null;
        appState.currentSetIndex = {};
        saveAppState();
    }
}

function finishWorkout() {
    const today = new Date().getDay();
    markDayCompleted(today);
    
    document.getElementById('workout-interface').style.display = 'none';
    appState.currentWorkout = null;
    appState.currentSetIndex = {};
    saveAppState();
    
    alert('Workout saved! Great job! üí™');
    speak('Workout complete! Great work!');
}

function markDayCompleted(dayIndex) {
    const date = getDateForDay(dayIndex);
    let completed = JSON.parse(localStorage.getItem('completedWorkouts')) || {};
    completed[date] = true;
    localStorage.setItem('completedWorkouts', JSON.stringify(completed));
    
    // Auto-save to cloud
    const workout = {
        date: date,
        type: appState.currentWorkout?.type || 'unknown',
        exercises: appState.currentWorkout?.exercises || [],
        duration: 0, // Could be calculated
        notes: ''
    };
    saveWorkoutToCloud(workout);
    
    renderPlanCalendar();
}

function getDateForDay(dayIndex) {
    const today = new Date();
    const diff = dayIndex - today.getDay();
    const target = new Date(today);
    target.setDate(today.getDate() + diff);
    return target.toISOString().split('T')[0];
}

// ========================================
// CUSTOM WORKOUT BUILDER
// ========================================
function openCustomBuilder() {
    appState.selectedExercises = [];
    document.getElementById('custom-builder-modal').classList.add('active');
    renderBuilderExerciseList();
    updateSelectedCount();
}

function closeCustomBuilder() {
    document.getElementById('custom-builder-modal').classList.remove('active');
}

function updateExerciseCount(value) {
    appState.exerciseCount = parseInt(value);
    document.getElementById('exercise-count-display').textContent = value;
    saveAppState();
}

function searchBuilderExercises() {
    renderBuilderExerciseList();
}

// ========================================
// UPDATED: MULTI-SELECT FILTER LOGIC
// ========================================

function filterBuilder(category) {
    // 1. Initialize array if it doesn't exist (converts old single-select state)
    if (!Array.isArray(appState.builderFilters)) {
        appState.builderFilters = ['all'];
    }

    const allChip = document.querySelector("#custom-builder-modal .chip[onclick*=\"'all'\"]");
    const clickedChip = event.target; // The chip you just clicked

    if (category === 'all') {
        // If clicking "All", clear everything else
        appState.builderFilters = ['all'];
        
        // Visuals: Remove active from everything, add to All
        document.querySelectorAll('#custom-builder-modal .chip').forEach(c => c.classList.remove('active'));
        if(allChip) allChip.classList.add('active');
        
    } else {
        // If clicking a specific category...
        
        // First, remove 'all' if it's currently selected
        if (appState.builderFilters.includes('all')) {
            appState.builderFilters = [];
            if(allChip) allChip.classList.remove('active');
        }

        // Toggle the category (Add if new, Remove if exists)
        const index = appState.builderFilters.indexOf(category);
        if (index > -1) {
            // It's already there -> Remove it
            appState.builderFilters.splice(index, 1);
            clickedChip.classList.remove('active');
        } else {
            // It's not there -> Add it
            appState.builderFilters.push(category);
            clickedChip.classList.add('active');
        }

        // Safety: If you uncheck everything, default back to 'All'
        if (appState.builderFilters.length === 0) {
            appState.builderFilters = ['all'];
            if(allChip) allChip.classList.add('active');
        }
    }

    // Refresh the list with the new combined filters
    renderBuilderExerciseList();
}

function renderBuilderExerciseList() {
    const container = document.getElementById('builder-exercise-list');
    const searchTerm = document.getElementById('builder-search').value.toLowerCase();
    
    // Safety check for state
    if (!Array.isArray(appState.builderFilters)) {
        appState.builderFilters = ['all'];
    }

    // 1. Define Filter Groups
    const muscles = ['Chest', 'Back', 'Legs', 'Shoulders', 'Arms'];
    const equipment = ['Cable', 'Dumbbell', 'Barbell', 'Bodyweight'];
    const styles = ['Mobility', 'Nimble', 'Calisthenics', 'Plyo'];

    // 2. Sort active filters into buckets
    const activeMuscles = appState.builderFilters.filter(f => muscles.includes(f));
    const activeEquip = appState.builderFilters.filter(f => equipment.includes(f));
    const activeStyles = appState.builderFilters.filter(f => styles.includes(f));

    let exercises = window.allExercises;
    
    // 3. SMART FILTER LOGIC: (Muscle OR Muscle) AND (Equip OR Equip) AND (Style OR Style)
    if (!appState.builderFilters.includes('all')) {
        exercises = exercises.filter(ex => {
            // Check Muscle Group (True if no muscles selected OR matches one of them)
            const muscleMatch = activeMuscles.length === 0 || 
                activeMuscles.some(m => ex.cat.includes(m));

            // Check Equipment (True if no equipment selected OR matches)
            const equipMatch = activeEquip.length === 0 || 
                activeEquip.includes(ex.equip);

            // Check Style/Type (True if no style selected OR matches)
            const styleMatch = activeStyles.length === 0 || 
                activeStyles.some(s => ex.cat.includes(s) || ex.type === s);

            // Must match ALL active groups
            return muscleMatch && equipMatch && styleMatch;
        });
    }
    
    // 4. Apply Search Text
    if(searchTerm) {
        exercises = exercises.filter(ex => ex.name.toLowerCase().includes(searchTerm));
    }
    
    // 5. Apply Global Equipment Settings
    exercises = filterExercisesByEquipment(exercises);
    
    // Render Results
    container.innerHTML = '';
    
    // Show count
    const totalEl = document.createElement('div');
    totalEl.style.cssText = 'padding: 10px; background: rgba(3,218,198,0.1); border-radius: 8px; margin-bottom: 10px; text-align: center; color: #03DAC6;';
    totalEl.textContent = `${exercises.length} exercises found`;
    container.appendChild(totalEl);
    
    if (exercises.length === 0) {
        const emptyEl = document.createElement('div');
        emptyEl.style.cssText = 'text-align:center; padding:20px; color:#888;';
        emptyEl.innerHTML = 'No exercises match this exact combination.<br>Try removing a filter.';
        container.appendChild(emptyEl);
    }

    exercises.forEach(ex => {
        const div = document.createElement('div');
        div.className = 'exercise-list-item';
        if(appState.selectedExercises.some(e => e.name === ex.name)) {
            div.classList.add('selected');
        }
        
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <div>
                    <strong>${ex.name}</strong><br>
                    <small class="text-muted">${ex.cat.join(', ')} ‚Ä¢ ${ex.equip}</small>
                </div>
                <button class="btn-small btn-action" onclick="event.stopPropagation(); viewExerciseDetails('${ex.name.replace(/'/g,"\\'")}')">
                    ‚ÑπÔ∏è
                </button>
            </div>
        `;
        
        div.onclick = () => toggleExerciseSelection(ex);
        container.appendChild(div);
    });
}
function toggleExerciseSelection(exercise) {
    const index = appState.selectedExercises.findIndex(e => e.name === exercise.name);
    
    if(index > -1) {
        appState.selectedExercises.splice(index, 1);
    } else {
        if(appState.selectedExercises.length < appState.exerciseCount) {
            appState.selectedExercises.push(exercise);
        } else {
            alert(`Maximum ${appState.exerciseCount} exercises selected`);
            return;
        }
    }
    
    renderBuilderExerciseList();
    updateSelectedCount();
}

function updateSelectedCount() {
    const countEl = document.getElementById('selected-count');
    if(countEl) {
        countEl.textContent = appState.selectedExercises.length;
    }
}

function startCustomWorkout() {
    if(appState.selectedExercises.length === 0) {
        alert('Select at least one exercise');
        return;
    }
    
    closeCustomBuilder();
    startWorkout(appState.selectedExercises);
}
// ========================================
// EXERCISE ENCYCLOPEDIA (Multi-Select & Smart Filter)
// ========================================

function filterEncyclopedia(category) {
    // 1. Initialize state if missing
    if (!Array.isArray(appState.encyclopediaFilters)) {
        appState.encyclopediaFilters = ['all'];
    }

    // Get the "All" chip specifically inside the encyclopedia view
    const allChip = document.querySelector("#view-encyclopedia .chip[onclick*=\"'all'\"]");
    const clickedChip = event.target; 

    if (category === 'all') {
        // Reset to All
        appState.encyclopediaFilters = ['all'];
        document.querySelectorAll('#view-encyclopedia .chip').forEach(c => c.classList.remove('active'));
        if(allChip) allChip.classList.add('active');
        
    } else {
        // Toggle Filters
        if (appState.encyclopediaFilters.includes('all')) {
            appState.encyclopediaFilters = [];
            if(allChip) allChip.classList.remove('active');
        }

        const index = appState.encyclopediaFilters.indexOf(category);
        if (index > -1) {
            // Remove if already selected
            appState.encyclopediaFilters.splice(index, 1);
            clickedChip.classList.remove('active');
        } else {
            // Add if not selected
            appState.encyclopediaFilters.push(category);
            clickedChip.classList.add('active');
        }

        // Default back to All if empty
        if (appState.encyclopediaFilters.length === 0) {
            appState.encyclopediaFilters = ['all'];
            if(allChip) allChip.classList.add('active');
        }
    }

    renderEncyclopedia();
}

function renderEncyclopedia() {
    const container = document.getElementById('encyclopedia-list');
    if(!container) return;
    
    const searchTerm = document.getElementById('encyclopedia-search')?.value.toLowerCase() || '';
    
    // Safety check
    if (!Array.isArray(appState.encyclopediaFilters)) {
        appState.encyclopediaFilters = ['all'];
    }

    // 1. Define Filter Groups
    const muscles = ['Chest', 'Back', 'Legs', 'Shoulders', 'Arms'];
    const equipment = ['Cable', 'Dumbbell', 'Barbell', 'Bodyweight'];
    const styles = ['Mobility', 'Nimble', 'Calisthenics', 'Plyo'];

    // 2. Sort active filters
    const activeMuscles = appState.encyclopediaFilters.filter(f => muscles.includes(f));
    const activeEquip = appState.encyclopediaFilters.filter(f => equipment.includes(f));
    const activeStyles = appState.encyclopediaFilters.filter(f => styles.includes(f));

    let exercises = window.allExercises;
    
    // 3. SMART FILTER LOGIC: (Muscle OR Muscle) AND (Equip OR Equip) AND (Style OR Style)
    if (!appState.encyclopediaFilters.includes('all')) {
        exercises = exercises.filter(ex => {
            const muscleMatch = activeMuscles.length === 0 || activeMuscles.some(m => ex.cat.includes(m));
            const equipMatch = activeEquip.length === 0 || activeEquip.includes(ex.equip);
            const styleMatch = activeStyles.length === 0 || activeStyles.some(s => ex.cat.includes(s) || ex.type === s);
            
            return muscleMatch && equipMatch && styleMatch;
        });
    }
    
    // 4. Apply Search
    if(searchTerm) {
        exercises = exercises.filter(ex => ex.name.toLowerCase().includes(searchTerm));
    }
    
    // Render Results
    container.innerHTML = '';
    
    // Show count
    const totalEl = document.createElement('div');
    totalEl.style.cssText = 'padding: 10px; background: rgba(187,134,252,0.1); border-radius: 8px; margin-bottom: 15px; text-align: center; color: #BB86FC; font-weight: bold;';
    totalEl.textContent = `üìö ${exercises.length} exercises found`;
    container.appendChild(totalEl);
    
    if (exercises.length === 0) {
        const emptyEl = document.createElement('div');
        emptyEl.style.cssText = 'text-align:center; padding:30px; color:#888;';
        emptyEl.innerHTML = 'No exercises match this combination.<br>Try unchecking some filters.';
        container.appendChild(emptyEl);
    }
    
    exercises.forEach(ex => {
        const card = document.createElement('div');
        card.className = 'card';
        card.style.cursor = 'pointer';
        card.onclick = () => viewExerciseDetails(ex.name);
        
        card.innerHTML = `
            <h3 style="margin:0 0 5px 0;">${ex.name}</h3>
            <div class="text-muted">${ex.cat.join(', ')} ‚Ä¢ ${ex.equip} ‚Ä¢ ${ex.type}</div>
        `;
        
        container.appendChild(card);
    });
}

function searchEncyclopedia() {
    renderEncyclopedia();
}

// ========================================
// PLAN CALENDAR
// ========================================
function renderPlanCalendar() {
    const grid = document.getElementById('week-grid');
    if(!grid) return;
    
    grid.innerHTML = '';
    const plan = appState.activePlan;
    const days = ['S','M','T','W','T','F','S'];
    
    days.forEach((letter, idx) => {
        const type = plan.schedule[idx] || 'rest';
        const bubble = document.createElement('div');
        bubble.className = `day-bubble workout-type-${type}`;
        bubble.onclick = () => editDay(idx);
        
        const icon = {push:'üí™',pull:'üèãÔ∏è',legs:'ü¶µ',cardio:'üö¥',nimble:'üßò',rest:'üò¥'}[type] || 'üî•';
        const completed = isDayCompleted(idx);
        
        bubble.innerHTML = `
            <div class="day-icon">${icon}</div>
            <div class="day-letter">${letter}</div>
            <div class="day-type">${type.substring(0,4)}</div>
            ${completed ? '<div class="day-check">‚úÖ</div>' : ''}
        `;
        
        grid.appendChild(bubble);
    });
    
    updatePhaseDisplay();
    updateAiCoach(); // Update AI coach suggestions
}

function editDay(idx) {
    const plan = appState.activePlan;
    const types = ['rest','push','pull','legs','cardio','nimble'];
    const current = types.indexOf(plan.schedule[idx]);
    plan.schedule[idx] = types[(current + 1) % types.length];
    saveAppState();
    renderPlanCalendar();
}

function isDayCompleted(idx) {
    const date = getDateForDay(idx);
    const completed = JSON.parse(localStorage.getItem('completedWorkouts')) || {};
    return completed[date] === true;
}

function updatePhaseDisplay() {
    const el = document.getElementById('phase-display');
    if(el) el.textContent = `Week ${appState.activePlan.week} - ${appState.activePlan.phase}`;
    
    const plan = appState.activePlan;
    let done = 0, total = 0;
    
    for(let i = 0; i < 7; i++) {
        if(plan.schedule[i] !== 'rest') {
            total++;
            if(isDayCompleted(i)) done++;
        }
    }
    
    const adherence = document.getElementById('adherence-display');
    if(adherence) adherence.textContent = `${done}/${total}`;
}

// ========================================
// FULL PLAN VIEW
// ========================================
function toggleFullPlanView() {
    const view = document.getElementById('full-plan-view');
    if (view.style.display === 'none') {
        renderFullPlanView();
        view.style.display = 'block';
    } else {
        view.style.display = 'none';
    }
}

function renderFullPlanView() {
    const container = document.getElementById('full-plan-view');
    const plan = appState.activePlan;
    
    // Check for AI-generated plan with phases
    const aiPlan = JSON.parse(localStorage.getItem('currentPlan') || 'null');
    
    let html = '';
    
    // Plan overview
    if (aiPlan && aiPlan.name) {
        html += `<div class="card" style="border-left:3px solid var(--primary);">`;
        html += `<h3 style="margin:0 0 8px 0;">${aiPlan.name}</h3>`;
        if (aiPlan.duration) html += `<p style="color:#aaa; margin:4px 0;">Duration: <strong>${aiPlan.duration} weeks</strong></p>`;
        if (aiPlan.guidance) html += `<p style="color:#aaa; margin:4px 0;">${aiPlan.guidance}</p>`;
        html += `</div>`;
        
        // Phases
        if (aiPlan.phases && aiPlan.phases.length) {
            html += `<div class="card"><h3 style="margin:0 0 10px 0;">üìä Phases</h3>`;
            aiPlan.phases.forEach(phase => {
                html += `<div style="padding:8px 0; border-bottom:1px solid #333;">`;
                html += `<strong style="color:var(--sec);">${phase.name}</strong>`;
                if (phase.weeks) html += ` <span style="color:#888;">(Weeks ${phase.weeks})</span>`;
                if (phase.focus) html += `<p style="color:#aaa; margin:4px 0 0 0; font-size:0.9em;">${phase.focus}</p>`;
                html += `</div>`;
            });
            html += `</div>`;
        }
    }
    
    // Weekly schedule with exercises
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const typeColors = {push:'#FF6B6B', pull:'#4ECDC4', legs:'#FFE66D', cardio:'#FF8C42', nimble:'#A78BFA', rest:'#666'};
    const typeIcons = {push:'üí™', pull:'üèãÔ∏è', legs:'ü¶µ', cardio:'üö¥', nimble:'üßò', rest:'üò¥'};
    
    html += `<div class="card"><h3 style="margin:0 0 12px 0;">üìÖ Weekly Schedule</h3>`;
    
    dayNames.forEach((dayName, idx) => {
        const type = plan.schedule[idx] || 'rest';
        const completed = isDayCompleted(idx);
        const color = typeColors[type] || '#888';
        
        html += `<div style="padding:10px; margin-bottom:8px; background:#1a1a1a; border-radius:8px; border-left:3px solid ${color};">`;
        html += `<div style="display:flex; justify-content:space-between; align-items:center;">`;
        html += `<span><strong>${dayName}</strong></span>`;
        html += `<span style="color:${color}; font-size:0.9em;">${typeIcons[type] || 'üî•'} ${type.toUpperCase()}</span>`;
        if (completed) html += `<span>‚úÖ</span>`;
        html += `</div>`;
        
        if (type !== 'rest') {
            try {
                const exercises = generateWorkoutByType(type, appState.exerciseCount);
                if (exercises && exercises.length) {
                    html += `<div style="margin-top:8px; padding-left:8px; font-size:0.85em; color:#aaa;">`;
                    exercises.forEach((ex, i) => {
                        html += `<div style="padding:2px 0;">${i + 1}. ${ex.name}</div>`;
                    });
                    html += `</div>`;
                }
            } catch(e) { /* skip if generateWorkoutByType not available */ }
        }
        
        html += `</div>`;
    });
    
    html += `</div>`;
    
    // Close button
    html += `<button class="btn btn-action" onclick="document.getElementById('full-plan-view').style.display='none'" style="width:100%; margin-top:8px;">Hide Plan Details</button>`;
    
    container.innerHTML = html;
}

// ========================================
// PLAN GENERATOR
// ========================================
let planData = {};

function openPlanGenerator() {
    planData = {};
    document.getElementById('plan-generator-modal').classList.add('active');
    showGenStep(1);
}

function closePlanGenerator() {
    document.getElementById('plan-generator-modal').classList.remove('active');
}

function showGenStep(step) {
    for(let i = 1; i <= 3; i++) {
        const el = document.getElementById(`generator-step-${i}`);
        if(el) el.style.display = i === step ? 'block' : 'none';
    }
}

function selectFrequency(days) {
    planData.frequency = days;
    event.target.classList.add('active');
    setTimeout(() => showGenStep(2), 300);
}

function selectGoal(goal) {
    planData.goal = goal;
    event.target.classList.add('active');
    
    // Generate plan based on holistic focus
    const schedules = {
        3: {0:'rest',1:'push',2:'rest',3:'pull',4:'rest',5:'legs',6:'rest'},
        4: {0:'rest',1:'push',2:'pull',3:'rest',4:'legs',5:'nimble',6:'rest'},
        5: {0:'rest',1:'push',2:'cardio',3:'pull',4:'rest',5:'legs',6:'nimble'},
        6: {0:'cardio',1:'push',2:'pull',3:'cardio',4:'legs',5:'nimble',6:'rest'}
    };
    
    // Goal descriptions for 40+ men
    const goalNames = {
        balanced: 'Balanced Performance',
        vitality: 'Health & Vitality',
        functional: 'Functional Fitness'
    };
    
    appState.activePlan = {
        name: `${planData.frequency}-Day ${goalNames[planData.goal] || 'Training'}`,
        frequency: planData.frequency,
        schedule: schedules[planData.frequency],
        week: 1,
        phase: 'Foundation' // Better than 'volume' for 40+
    };
    
    // Show preview
    const preview = document.getElementById('plan-preview');
    const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    let html = '<div style="margin:15px 0;">';
    dayNames.forEach((name, idx) => {
        const type = appState.activePlan.schedule[idx];
        const icon = {push:'üí™',pull:'üèãÔ∏è',legs:'ü¶µ',cardio:'üö¥',nimble:'üßò',rest:'üò¥'}[type];
        html += `<div style="padding:8px; background:#2c2c2c; margin:5px 0; border-radius:6px;">
            ${icon} <strong>${name}:</strong> ${type}
        </div>`;
    });
    html += '</div>';
    preview.innerHTML = html;
    
    setTimeout(() => showGenStep(3), 300);
}

function acceptPlan() {
    saveAppState();
    closePlanGenerator();
    renderPlanCalendar();
    speak('Plan activated!');
}

function regeneratePlan() {
    showGenStep(1);
}

// ========================================
// TODAY'S BANNER
// ========================================
function updateTodaysBanner() {
    const banner = document.getElementById('todays-banner');
    if(!banner) return;
    
    const plan = appState.activePlan;
    const today = new Date();
    const dayIdx = today.getDay();
    const type = plan.schedule[dayIdx];
    
    if(type === 'rest' || isDayCompleted(dayIdx)) {
        banner.style.display = 'none';
        return;
    }
    
    document.getElementById('today-date').textContent = 
        today.toLocaleDateString('en-US', {weekday:'long', month:'short', day:'numeric'});
    
    const icon = {push:'üí™',pull:'üèãÔ∏è',legs:'ü¶µ',cardio:'üö¥',nimble:'üßò'}[type];
    document.getElementById('today-workout').textContent = `${icon} ${type.toUpperCase()}`;
    
    banner.style.display = 'block';
}

function startTodaysWorkout() {
    const dayIdx = new Date().getDay();
    const type = appState.activePlan.schedule[dayIdx];
    quickStartWorkout(type);
}

// ========================================
// CARDIO TRACKING
// ========================================
function logCardioSession() {
    const type = document.getElementById('cardio-type').value;
    const duration = parseInt(document.getElementById('cardio-duration').value);
    const distance = parseFloat(document.getElementById('cardio-distance').value) || null;
    
    const session = {
        type: type,
        duration: duration,
        distance: distance,
        date: new Date().toISOString()
    };
    
    let history = JSON.parse(localStorage.getItem('cardioHistory')) || [];
    history.push(session);
    localStorage.setItem('cardioHistory', JSON.stringify(history));
    
    // Mark day completed
    markDayCompleted(new Date().getDay());
    
    alert('Cardio logged! üö¥');
    speak('Cardio session logged');
    loadCardioHistory();
}

function loadCardioHistory() {
    const container = document.getElementById('cardio-history');
    if(!container) return;
    
    const history = JSON.parse(localStorage.getItem('cardioHistory')) || [];
    
    if(history.length === 0) {
        container.innerHTML = '<p class="text-muted">No cardio sessions yet</p>';
        return;
    }
    
    container.innerHTML = '';
    history.slice(-10).reverse().forEach(session => {
        const div = document.createElement('div');
        div.style.padding = '10px';
        div.style.borderBottom = '1px solid #333';
        
        const date = new Date(session.date).toLocaleDateString();
        const icon = {run:'üèÉ',bike:'üö¥',swim:'üèä',walk:'üö∂',row:'üö£'}[session.type];
        
        div.innerHTML = `
            <strong>${icon} ${session.type}</strong><br>
            <small class="text-muted">
                ${date} ‚Ä¢ ${session.duration} min${session.distance ? ` ‚Ä¢ ${session.distance} km` : ''}
            </small>
        `;
        
        container.appendChild(div);
    });
}

// ========================================
// EQUIPMENT SETTINGS
// ========================================
function renderEquipmentPresets() {
    const container = document.getElementById('equipment-presets');
    if(!container) return;
    
    const presets = [
        {key:'home', name:'üè† Home Gym', desc:'Cables, Dumbbells, Bench'},
        {key:'hotel', name:'üè® Hotel/Travel', desc:'Bodyweight & Bands'},
        {key:'gym', name:'üí™ Full Gym', desc:'All Equipment'}
    ];
    
    container.innerHTML = '';
    presets.forEach(preset => {
        const div = document.createElement('div');
        div.className = 'preset-card';
        div.setAttribute('data-preset', preset.key);
        if(appState.equipment === preset.key) div.classList.add('active');
        
        div.innerHTML = `
            <strong>${preset.name}</strong><br>
            <small class="text-muted">${preset.desc}</small>
        `;
        
        div.onclick = () => activatePreset(preset.key);
        container.appendChild(div);
    });
}

function activatePreset(key) {
    appState.equipment = key;
    saveAppState();
    
    document.querySelectorAll('.preset-card').forEach(c => c.classList.remove('active'));
    document.querySelector(`[data-preset="${key}"]`).classList.add('active');
    
    speak(`Switched to ${key} equipment`);
}

function updateSettingsUI() {
    if(document.getElementById('voice-enabled')) {
        document.getElementById('voice-enabled').checked = appState.voiceEnabled;
        document.getElementById('voice-level').value = appState.voiceLevel;
    }
    
    // Update exercise count slider
    if(document.getElementById('exercise-count-slider')) {
        const count = appState.exerciseCount || 6;
        document.getElementById('exercise-count-slider').value = count;
        document.getElementById('exercise-count-display').textContent = count;
    }
}

// ========================================
// VOICE SYSTEM
// ========================================
function speak(message) {
    if(!appState.voiceEnabled || appState.voiceLevel === 'silent') return;
    if(!window.speechSynthesis) return;
    
    const utterance = new SpeechSynthesisUtterance(message);
    window.speechSynthesis.speak(utterance);
}

function saveVoiceSettings() {
    appState.voiceEnabled = document.getElementById('voice-enabled').checked;
    appState.voiceLevel = document.getElementById('voice-level').value;
    saveAppState();
}

function testVoice() {
    speak('Voice test. Five, four, three, two, one. Well done!');
}

// ========================================
// IMAGE BACKUP & RESTORE
// ========================================
function exportImages() {
    // Collect all exercise images from localStorage
    const images = {};
    let count = 0;
    
    Object.keys(localStorage).forEach(key => {
        if(key.startsWith('gif_')) {
            images[key] = localStorage.getItem(key);
            count++;
        }
    });
    
    if(count === 0) {
        alert('No images to export. Add some exercise images first!');
        return;
    }
    
    // Create JSON file
    const dataStr = JSON.stringify(images, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    // Create download link
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `nimble-exercise-images-${new Date().toISOString().split('T')[0]}.json`;
    
    // Trigger download
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    speak(`Exported ${count} exercise images`);
    alert(`‚úÖ Exported ${count} exercise images!\n\nSave this file in your GitHub repo or safe location.`);
}

function importImages(event) {
    const file = event.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const images = JSON.parse(e.target.result);
            let count = 0;
            
            // Import all images
            Object.keys(images).forEach(key => {
                if(key.startsWith('gif_')) {
                    localStorage.setItem(key, images[key]);
                    count++;
                }
            });
            
            speak(`Imported ${count} exercise images`);
            alert(`‚úÖ Imported ${count} exercise images!\n\nYour images have been restored.`);
            
            // Clear file input
            event.target.value = '';
            
        } catch(err) {
            alert('‚ùå Error importing file. Make sure it\'s a valid backup file.');
            console.error('Import error:', err);
        }
    };
    
    reader.readAsText(file);
}

// ========================================
// SIMPLE GOOGLE IMAGE SEARCH
// ========================================
function openGifSearch(exerciseName) {
    // Build Google Images search URL for animated GIF showing form and muscles
    const searchQuery = `${exerciseName} exercise animated GIF male form muscles worked`;
    const googleImagesUrl = `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}&tbm=isch&tbs=itp:animated`;
    
    // Open in new tab
    window.open(googleImagesUrl, '_blank');
    
    // Optional: Show a quick tip
    speak(`Opening Google Images for ${exerciseName}`);
}

function removeExerciseGif(exerciseName) {
    if(confirm(`Remove image for ${exerciseName}?`)) {
        localStorage.removeItem(`gif_${exerciseName}`);
        speak('Image removed');
        viewExerciseDetails(exerciseName);
    }
}

function pasteImageUrl(exerciseName) {
    // Get the input field ID (sanitized exercise name)
    const inputId = `paste-url-${exerciseName.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const input = document.getElementById(inputId);
    
    if(!input) {
        alert('Error: Could not find input field');
        return;
    }
    
    const imageUrl = input.value.trim();
    
    // Validate URL
    if(!imageUrl) {
        alert('Please paste an image URL first');
        return;
    }
    
    // Basic URL validation
    if(!imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
        alert('Please enter a valid URL starting with http:// or https://');
        return;
    }
    
    // Save to localStorage
    localStorage.setItem(`gif_${exerciseName}`, imageUrl);
    
    // Clear input and refresh view
    input.value = '';
    speak(`Image URL saved for ${exerciseName}`);
    viewExerciseDetails(exerciseName);
}

// ========================================
// GPS TRACKING FEATURE
// ========================================
let gpsWatchId = null;
let gpsRoute = [];
let gpsStartTime = null;
let gpsInterval = null;
let gpsTotalDistance = 0;

function startGpsTracking() {
    if(!navigator.geolocation) {
        alert('GPS not supported on this device');
        return;
    }
    
    const activityType = document.getElementById('gps-activity-type').value;
    
    gpsRoute = [];
    gpsTotalDistance = 0;
    gpsStartTime = Date.now();
    
    document.getElementById('gps-tracking-modal').classList.add('active');
    document.getElementById('gps-distance').textContent = '0.00';
    document.getElementById('gps-pace').textContent = '0:00';
    document.getElementById('gps-duration').textContent = '00:00';
    
    gpsWatchId = navigator.geolocation.watchPosition(
        updateGpsPosition,
        (error) => {
            console.error('GPS error:', error);
            alert('Unable to access GPS. Please enable location services.');
            stopGpsTracking();
        },
        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
    );
    
    gpsInterval = setInterval(updateGpsDuration, 1000);
    speak(`GPS tracking started for ${activityType}`);
}

function updateGpsPosition(position) {
    const newPoint = {
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        timestamp: Date.now()
    };
    
    if(gpsRoute.length > 0) {
        const lastPoint = gpsRoute[gpsRoute.length - 1];
        const distance = calculateDistance(lastPoint.lat, lastPoint.lng, newPoint.lat, newPoint.lng);
        gpsTotalDistance += distance;
        
        document.getElementById('gps-distance').textContent = gpsTotalDistance.toFixed(2);
        
        const durationMinutes = (Date.now() - gpsStartTime) / 60000;
        if(gpsTotalDistance > 0) {
            const pace = durationMinutes / gpsTotalDistance;
            const paceMin = Math.floor(pace);
            const paceSec = Math.floor((pace - paceMin) * 60);
            document.getElementById('gps-pace').textContent = `${paceMin}:${paceSec.toString().padStart(2, '0')}`;
        }
    }
    
    gpsRoute.push(newPoint);
    drawGpsRoute();
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Earth radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function updateGpsDuration() {
    const duration = Date.now() - gpsStartTime;
    const minutes = Math.floor(duration / 60000);
    const seconds = Math.floor((duration % 60000) / 1000);
    document.getElementById('gps-duration').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function drawGpsRoute() {
    const canvas = document.getElementById('gps-map-canvas');
    const ctx = canvas.getContext('2d');
    
    if(gpsRoute.length < 2) return;
    
    // Clear canvas
    ctx.fillStyle = '#2c2c2c';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Find bounds
    const lats = gpsRoute.map(p => p.lat);
    const lngs = gpsRoute.map(p => p.lng);
    const minLat = Math.min(...lats);
    const maxLat = Math.max(...lats);
    const minLng = Math.min(...lngs);
    const maxLng = Math.max(...lngs);
    
    const latRange = maxLat - minLat || 0.001;
    const lngRange = maxLng - minLng || 0.001;
    
    // Draw route
    ctx.strokeStyle = '#03DAC6';
    ctx.lineWidth = 3;
    ctx.beginPath();
    
    gpsRoute.forEach((point, i) => {
        const x = ((point.lng - minLng) / lngRange) * (canvas.width - 40) + 20;
        const y = canvas.height - (((point.lat - minLat) / latRange) * (canvas.height - 40) + 20);
        
        if(i === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });
    
    ctx.stroke();
    
    // Draw start point
    const startX = ((gpsRoute[0].lng - minLng) / lngRange) * (canvas.width - 40) + 20;
    const startY = canvas.height - (((gpsRoute[0].lat - minLat) / latRange) * (canvas.height - 40) + 20);
    ctx.fillStyle = '#00C853';
    ctx.beginPath();
    ctx.arc(startX, startY, 6, 0, 2 * Math.PI);
    ctx.fill();
    
    // Draw end point
    const lastPoint = gpsRoute[gpsRoute.length - 1];
    const endX = ((lastPoint.lng - minLng) / lngRange) * (canvas.width - 40) + 20;
    const endY = canvas.height - (((lastPoint.lat - minLat) / latRange) * (canvas.height - 40) + 20);
    ctx.fillStyle = '#CF6679';
    ctx.beginPath();
    ctx.arc(endX, endY, 6, 0, 2 * Math.PI);
    ctx.fill();
}

function stopGpsTracking() {
    if(gpsWatchId) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
    }
    if(gpsInterval) {
        clearInterval(gpsInterval);
        gpsInterval = null;
    }
    document.getElementById('gps-tracking-modal').classList.remove('active');
}

function saveGpsRoute() {
    if(gpsRoute.length < 2) {
        alert('Not enough GPS data to save');
        return;
    }
    
    const activityType = document.getElementById('gps-activity-type').value;
    const duration = (Date.now() - gpsStartTime) / 60000;
    
    const routeData = {
        type: activityType,
        date: new Date().toISOString(),
        distance: parseFloat(gpsTotalDistance.toFixed(2)),
        duration: Math.floor(duration),
        route: gpsRoute,
        pace: duration / gpsTotalDistance
    };
    
    // Save to cardio history
    let cardioHistory = JSON.parse(localStorage.getItem('cardioHistory') || '[]');
    cardioHistory.unshift(routeData);
    localStorage.setItem('cardioHistory', JSON.stringify(cardioHistory));
    
    speak(`${activityType} saved: ${gpsTotalDistance.toFixed(2)} kilometers`);
    stopGpsTracking();
    renderCardioHistory();
}

// ========================================
// WARMUP SEQUENCES FEATURE
// ========================================
const warmupSequences = {
    push: [
        { name: 'Arm Circles', duration: 60, desc: 'Large circles forward and backward' },
        { name: 'Shoulder CARs', duration: 60, desc: 'Controlled articular rotations' },
        { name: 'Band Pull-Aparts', duration: 45, desc: 'Light resistance band' },
        { name: 'Push-up Plus', duration: 45, desc: 'Scapular protraction focus' },
        { name: 'Chest Openers', duration: 45, desc: 'Dynamic stretching' },
        { name: 'Wrist Rolls', duration: 30, desc: 'Both directions' }
    ],
    pull: [
        { name: 'Dead Hangs', duration: 45, desc: 'Active shoulder engagement' },
        { name: 'Scapular Shrugs', duration: 60, desc: 'On bar or rings' },
        { name: 'Band Face Pulls', duration: 45, desc: 'Light resistance' },
        { name: 'Cat-Cow Stretch', duration: 60, desc: 'Spine mobility' },
        { name: 'Thoracic Rotations', duration: 45, desc: 'Both sides' },
        { name: 'Wrist Flexion/Extension', duration: 30, desc: 'Gentle stretches' }
    ],
    legs: [
        { name: 'Leg Swings', duration: 60, desc: 'Front to back, side to side' },
        { name: 'Hip CARs', duration: 60, desc: 'Controlled hip circles' },
        { name: 'Bodyweight Squats', duration: 45, desc: 'Full range of motion' },
        { name: 'Walking Lunges', duration: 45, desc: 'Dynamic stretching' },
        { name: 'Ankle Rolls', duration: 30, desc: 'Both directions' },
        { name: 'Glute Bridges', duration: 45, desc: 'Activation focus' }
    ]
};

let warmupTimer = null;
let warmupCurrentIndex = 0;
let warmupTimeLeft = 0;
let warmupWorkoutType = '';

function startWarmup(workoutType) {
    const type = workoutType.toLowerCase();
    if(!warmupSequences[type]) {
        // Skip warmup for workout types without sequences
        continueToWorkout();
        return;
    }
    
    warmupWorkoutType = type;
    warmupCurrentIndex = 0;
    document.getElementById('warmup-modal').classList.add('active');
    showWarmupExercise(0);
}

function showWarmupExercise(index) {
    const sequence = warmupSequences[warmupWorkoutType];
    if(index >= sequence.length) {
        completeWarmup();
        return;
    }
    
    const exercise = sequence[index];
    warmupCurrentIndex = index;
    warmupTimeLeft = exercise.duration;
    
    document.getElementById('warmup-exercise-name').textContent = exercise.name;
    document.getElementById('warmup-exercise-desc').textContent = exercise.desc;
    document.getElementById('warmup-timer').textContent = warmupTimeLeft;
    document.getElementById('warmup-progress').textContent = `${index + 1}/${sequence.length}`;
    
    speak(`${exercise.name}. ${exercise.duration} seconds`);
    
    if(warmupTimer) clearInterval(warmupTimer);
    warmupTimer = setInterval(() => {
        warmupTimeLeft--;
        document.getElementById('warmup-timer').textContent = warmupTimeLeft;
        
        if(warmupTimeLeft <= 3 && warmupTimeLeft > 0) {
            speak(warmupTimeLeft.toString());
        }
        
        if(warmupTimeLeft <= 0) {
            clearInterval(warmupTimer);
            nextWarmupExercise();
        }
    }, 1000);
}

function nextWarmupExercise() {
    if(warmupTimer) clearInterval(warmupTimer);
    showWarmupExercise(warmupCurrentIndex + 1);
}

function skipWarmup() {
    if(warmupTimer) clearInterval(warmupTimer);
    document.getElementById('warmup-modal').classList.remove('active');
    continueToWorkout();
}

function completeWarmup() {
    if(warmupTimer) clearInterval(warmupTimer);
    document.getElementById('warmup-modal').classList.remove('active');
    speak('Warmup complete! Ready to train');
    continueToWorkout();
}

function continueToWorkout() {
    // The workout is already loaded, just make sure it's visible
    document.getElementById('workout-interface').style.display = 'block';
}

// ========================================
// AI COACH ANALYTICS
// ========================================
function updateAiCoach() {
    const container = document.getElementById('ai-coach-suggestions');
    if(!container) return;
    
    const completedWorkouts = JSON.parse(localStorage.getItem('completedWorkouts') || '{}');
    const plan = JSON.parse(localStorage.getItem('currentPlan') || '[]');
    
    // Calculate this week's data
    const today = new Date();
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay());
    
    let workoutsThisWeek = 0;
    let plannedThisWeek = 0;
    let consecutiveDays = 0;
    let lastWorkoutDate = null;
    
    for(let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        
        if(completedWorkouts[dateStr]) {
            workoutsThisWeek++;
            if(!lastWorkoutDate || (date - lastWorkoutDate) / (1000*60*60*24) === 1) {
                consecutiveDays++;
            }
            lastWorkoutDate = date;
        }
        
        if(plan[i] && plan[i] !== 'rest') {
            plannedThisWeek++;
        }
    }
    
    const adherenceRate = plannedThisWeek > 0 ? (workoutsThisWeek / plannedThisWeek) * 100 : 0;
    
    let html = '';
    
    // Generate AI coach message
    if(adherenceRate >= 80) {
        html += `
            <div class="ai-coach-card success">
                <h3>üéØ Excellent Progress!</h3>
                <p>Adherence: <strong>${adherenceRate.toFixed(0)}%</strong> (${workoutsThisWeek}/${plannedThisWeek} workouts)</p>
                <p style="margin-top:10px;">You're crushing it! Your consistency is outstanding. Keep up this momentum!</p>
            </div>
        `;
    } else if(adherenceRate >= 50) {
        html += `
            <div class="ai-coach-card">
                <h3>üí™ Good Work!</h3>
                <p>Adherence: <strong>${adherenceRate.toFixed(0)}%</strong> (${workoutsThisWeek}/${plannedThisWeek} workouts)</p>
                <p style="margin-top:10px;">You're making solid progress. Try to hit all planned workouts for maximum results!</p>
            </div>
        `;
    } else if(plannedThisWeek > 0) {
        html += `
            <div class="ai-coach-card warning">
                <h3>‚ö†Ô∏è Need More Consistency</h3>
                <p>Adherence: <strong>${adherenceRate.toFixed(0)}%</strong> (${workoutsThisWeek}/${plannedThisWeek} workouts)</p>
                <p style="margin-top:10px;">You've missed several workouts this week. Remember: consistency beats intensity!</p>
            </div>
        `;
    }
    
    // Overtraining detection
    if(workoutsThisWeek >= 6 && consecutiveDays >= 6) {
        html += `
            <div class="ai-coach-card warning">
                <h3>üõë Recovery Check</h3>
                <p>You've trained ${consecutiveDays} days in a row.</p>
                <p style="margin-top:10px;">Consider taking a rest day soon to prevent overtraining and optimize recovery.</p>
            </div>
        `;
    }
    
    // Streak tracking
    if(consecutiveDays >= 3) {
        html += `
            <div class="ai-coach-card success">
                <h3>üî• ${consecutiveDays} Day Streak!</h3>
                <p>Amazing consistency! Remember to balance intensity with recovery.</p>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// ========================================
// UTILITY FUNCTIONS
// ========================================
function capitalizeFirst(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

// ========================================
// GARMIN CSV UPLOAD & AI ANALYSIS
// ========================================
let uploadedGarminFiles = [];
let garminData = {};

// Initialize Garmin upload handlers
function initGarminUpload() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    
    if (!dropZone || !fileInput) return;
    
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleGarminFiles(e.dataTransfer.files);
    });
    
    fileInput.addEventListener('change', (e) => {
        handleGarminFiles(e.target.files);
    });
    
    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', analyzeGarminData);
    }
}

function handleGarminFiles(files) {
    uploadedGarminFiles = Array.from(files).filter(f => f.name.endsWith('.csv'));
    
    if (uploadedGarminFiles.length === 0) {
        alert('Please upload CSV files only');
        return;
    }
    
    displayGarminFileList();
    document.getElementById('analyzeBtn').style.display = 'block';
}

function displayGarminFileList() {
    const fileList = document.getElementById('fileList');
    fileList.innerHTML = '<h4 style="margin-bottom: 10px; color: #00ff9d;">Files Ready:</h4>';
    
    uploadedGarminFiles.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <span class="file-name">üìÑ ${file.name}</span>
            <span class="file-size">${(file.size / 1024).toFixed(1)} KB</span>
        `;
        fileList.appendChild(fileItem);
    });
}

async function analyzeGarminData() {
    const analyzeBtn = document.getElementById('analyzeBtn');
    analyzeBtn.innerHTML = '<span class="loading"></span> Analyzing with Claude AI...';
    analyzeBtn.disabled = true;
    
    try {
        // Read all CSV files
        const fileContents = await Promise.all(
            uploadedGarminFiles.map(file => readFileAsText(file))
        );
        
        // Prepare data
        let dataText = '';
        uploadedGarminFiles.forEach((file, i) => {
            dataText += `\n\n=== ${file.name} ===\n${fileContents[i]}`;
        });
        
        // Send to Claude for analysis via backend proxy
        const response = await fetch(`${BACKEND_URL}/api/drive`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                action: 'gemini',
                system: 'You are an elite AI fitness coach analyzing Garmin health data.',
                messages: [{
                    role: "user",
                    content: `You are an elite AI fitness coach analyzing Garmin health data for a 40+ year old male athlete. Be specific, actionable, and direct.

MY GARMIN DATA (CSV files exported from Garmin Connect):
${dataText}

CONTEXT:
- I'm a 40+ male focused on sustainable fitness and longevity
- I use a Push/Pull/Legs training split
- I have access to cable machines (Torque F9), dumbbells, and barbells
- Recovery and injury prevention are priorities

ANALYSIS REQUIRED:

1. RECOVERY SCORE (0-100)
Calculate based on available data:
- Sleep Score, Duration, Quality (from Sleep.csv)
- Resting Heart Rate trends
- Body Battery levels
- HRV Status (if available)
- Recent activity frequency and intensity
- Training load vs rest balance

2. KEY METRICS
Extract what's available:
- Average sleep duration (last 7 days with data)
- Sleep quality trend (improving/declining/stable)
- Latest resting heart rate + trend
- HRV status (if available)
- Recent training load/frequency
- Rest days taken
- Body Battery average

3. TODAY'S WORKOUT RECOMMENDATION
Based on recovery, tell me:
- GREEN LIGHT: Train hard at planned intensity
- YELLOW LIGHT: Train with modifications (be specific)
- RED LIGHT: Rest or very light mobility work only

If YELLOW, provide SPECIFIC modifications:
- "Reduce weight by 15%"
- "Cut working sets from 4 to 3"
- "Skip heavy compounds, do accessories only"
- "Do mobility work instead"

4. INSIGHTS & PATTERNS
Look for:
- Sleep debt or consistent poor sleep
- Resting HR elevation (sign of overtraining)
- HRV trends
- Training frequency concerns
- Recovery recommendations
- Age-appropriate advice for 40+ athletes

IMPORTANT FORMATTING:
Return ONLY valid JSON, no markdown. Use this exact structure:

{
  "recoveryScore": 75,
  "recoveryStatus": "Good - Ready to Train",
  "metrics": {
    "avgSleep": "7.2 hours",
    "sleepTrend": "improving",
    "restingHR": "52 bpm",
    "hrTrend": "stable",
    "hrv": "36-38",
    "hrvStatus": "balanced",
    "bodyBattery": "55 avg",
    "trainingLoad": "moderate - 7 activities",
    "restDays": "adequate"
  },
  "recommendation": {
    "status": "green",
    "title": "Full Training Recommended",
    "details": "Your recovery metrics look excellent. Sleep quality is good, resting HR is stable, and HRV is in healthy range. You can train at full intensity today.",
    "modifications": null
  },
  "insights": [
    "Sleep quality averaging 'Good' this week - excellent for recovery",
    "Resting HR stable at 52 bpm - well-adapted cardiovascular system",
    "HRV in 36-38 range showing good autonomic balance",
    "Training frequency appropriate with adequate rest days"
  ],
  "warnings": []
}

If metrics show concerning patterns (sleep score <70, elevated RHR, low HRV, high training frequency):
- Adjust recoveryScore lower
- Set status to "yellow" or "red"
- Add specific warnings
- Provide actionable modifications`
                }]
            })
        });
        
        const result = await response.json();
        
        // Check for API errors
        if (result.error) {
            console.error('Claude API error:', result.error);
            throw new Error(`API Error: ${result.error.message || 'Unknown error'}`);
        }
        
        if (!result.content || !result.content[0]) {
            console.error('Unexpected API response:', result);
            throw new Error('No content in API response');
        }
        
        const aiResponse = result.content[0].text;
        console.log('Raw AI response:', aiResponse);
        
        // Parse JSON response
        let analysis;
        try {
            const cleanJson = aiResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            analysis = JSON.parse(cleanJson);
        } catch (e) {
            console.error('Failed to parse AI response as JSON:', aiResponse);
            console.error('Parse error:', e);
            throw new Error('AI response was not valid JSON - check console for details');
        }
        
        displayGarminResults(analysis);
        
        // Save to cloud
        if (CLOUD_SYNC_ENABLED) {
            const fileData = uploadedGarminFiles.map((f, i) => ({
                name: f.name,
                content: fileContents[i]
            }));
            await saveGarminToCloud(
                uploadedGarminFiles.map(f => f.name).join(', '),
                JSON.stringify(fileData),
                analysis
            );
        }
        
    } catch (error) {
        console.error('Analysis failed:', error);
        alert(`Failed to analyze data:\n${error.message}\n\nCheck browser console (F12) for full details.`);
        analyzeBtn.innerHTML = 'ü§ñ Analyze with AI Coach';
        analyzeBtn.disabled = false;
    }
}

function readFileAsText(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsText(file);
    });
}

function displayGarminResults(analysis) {
    // Hide upload section
    const uploadCard = document.querySelector('#view-garmin .card:first-child');
    if (uploadCard) uploadCard.style.display = 'none';
    
    // Show results
    document.getElementById('recoveryResults').style.display = 'block';
    
    // Recovery Score
    const score = analysis.recoveryScore || 0;
    document.getElementById('recoveryScore').textContent = score;
    document.getElementById('recoveryStatus').textContent = analysis.recoveryStatus || 'Unknown';
    
    // Animate meter
    setTimeout(() => {
        document.getElementById('recoveryMeterFill').style.width = score + '%';
    }, 100);
    
    // Metrics Grid
    const metricsGrid = document.getElementById('metricsGrid');
    metricsGrid.innerHTML = '';
    
    if (analysis.metrics) {
        Object.entries(analysis.metrics).forEach(([key, value]) => {
            const metricCard = document.createElement('div');
            metricCard.className = 'metric-card';
            metricCard.innerHTML = `
                <div class="metric-label">${formatMetricLabel(key)}</div>
                <div class="metric-value">${value}</div>
            `;
            metricsGrid.appendChild(metricCard);
        });
    }
    
    // AI Recommendations
    const recDiv = document.getElementById('aiRecommendations');
    recDiv.innerHTML = '';
    
    if (analysis.recommendation) {
        const rec = analysis.recommendation;
        const statusColor = rec.status === 'green' ? '#00C853' : 
                          rec.status === 'yellow' ? '#FF9800' : '#CF6679';
        
        recDiv.innerHTML = `
            <div class="ai-recommendation">
                <h3 style="color: ${statusColor};">${rec.title}</h3>
                <p>${rec.details}</p>
                ${rec.modifications ? `
                    <div class="workout-adjustment">
                        <strong>Workout Adjustments:</strong><br>
                        ${rec.modifications}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // Insights
    if (analysis.insights && analysis.insights.length > 0) {
        recDiv.innerHTML += `
            <div style="margin-top: 20px;">
                <h4 style="color: #00d4ff; margin-bottom: 10px;">üí° Key Insights</h4>
                ${analysis.insights.map(insight => `
                    <p style="padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; margin: 5px 0;">
                        ‚Üí ${insight}
                    </p>
                `).join('')}
            </div>
        `;
    }
    
    // Warnings
    if (analysis.warnings && analysis.warnings.length > 0) {
        recDiv.innerHTML += `
            <div style="margin-top: 20px;">
                <h4 style="color: #CF6679; margin-bottom: 10px;">‚ö†Ô∏è Warnings</h4>
                ${analysis.warnings.map(warning => `
                    <p style="padding: 10px; background: rgba(207,102,121,0.1); border-radius: 8px; margin: 5px 0; border-left: 3px solid #CF6679;">
                        ${warning}
                    </p>
                `).join('')}
            </div>
        `;
    }
    
    // Raw Data
    document.getElementById('rawData').innerHTML = `<pre>${JSON.stringify(analysis, null, 2)}</pre>`;
    
    // Scroll to results
    document.getElementById('recoveryResults').scrollIntoView({ behavior: 'smooth' });
    
    speak('Recovery analysis complete');
}

function formatMetricLabel(key) {
    const labels = {
        'avgSleep': 'Avg Sleep',
        'sleepTrend': 'Sleep Trend',
        'restingHR': 'Resting HR',
        'hrTrend': 'HR Trend',
        'hrv': 'HRV',
        'hrvStatus': 'HRV Status',
        'trainingLoad': 'Training Load',
        'restDays': 'Rest Days'
    };
    return labels[key] || key;
}

function resetGarminUpload() {
    const uploadCard = document.querySelector('#view-garmin .card:first-child');
    if (uploadCard) uploadCard.style.display = 'block';
    
    document.getElementById('recoveryResults').style.display = 'none';
    document.getElementById('fileList').innerHTML = '';
    document.getElementById('analyzeBtn').style.display = 'none';
    document.getElementById('fileInput').value = '';
    uploadedGarminFiles = [];
    
    document.querySelector('#view-garmin').scrollIntoView({ behavior: 'smooth' });
}

// ==========================================================================
// 1. UI & NOTIFICATION CORE (Defined first to prevent ReferenceErrors)
// ==========================================================================

function updateCloudSyncUI() {
    const statusText = document.getElementById('cloud-status-text');
    const deviceIdText = document.getElementById('device-id-text');
    const lastSyncText = document.getElementById('last-sync-time');
    
    if (statusText) {
        statusText.textContent = CLOUD_SYNC_ENABLED ? '‚úÖ Connected' : '‚ùå Offline';
        statusText.style.color = CLOUD_SYNC_ENABLED ? 'var(--success)' : 'var(--danger)';
    }
    if (deviceIdText) deviceIdText.textContent = USER_ID ? USER_ID.substr(0, 20) + '...' : 'Not set';
    if (lastSyncText && LAST_SYNC_TIME) lastSyncText.textContent = new Date(LAST_SYNC_TIME).toLocaleString();
}

function updateGarminConnectionUI(connected, lastSync = null) {
    const statusEl = document.getElementById('garmin-connection-status');
    const connectBtn = document.getElementById('garmin-connect-btn');
    const disconnectBtn = document.getElementById('garmin-disconnect-btn');
    const syncBtn = document.getElementById('garmin-sync-btn');
    const lastSyncEl = document.getElementById('garmin-last-sync');
    
    if (statusEl) {
        if (connected) {
            statusEl.innerHTML = '‚úÖ Connected';
            statusEl.style.color = 'var(--success)';
        } else {
            statusEl.innerHTML = '‚ùå Not Connected';
            statusEl.style.color = 'var(--danger)';
        }
    }
    
    if (connectBtn) connectBtn.style.display = connected ? 'none' : 'inline-block';
    if (disconnectBtn) disconnectBtn.style.display = connected ? 'inline-block' : 'none';
    if (syncBtn) syncBtn.style.display = connected ? 'inline-block' : 'none';
    
    if (lastSyncEl && lastSync) {
        const date = new Date(lastSync);
        lastSyncEl.textContent = `Last sync: ${date.toLocaleString()}`;
        lastSyncEl.style.display = 'block';
    } else if (lastSyncEl) {
        lastSyncEl.style.display = 'none';
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `<span>${message}</span><button onclick="this.parentElement.remove()">‚úï</button>`;
    notification.style.cssText = `position:fixed; top:20px; right:20px; background:var(--card); color:var(--text); padding:15px 20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.3); border-left:4px solid ${type === 'success' ? 'var(--success)' : type === 'info' ? 'var(--sec)' : 'var(--danger)'}; z-index:10000; max-width:400px; animation:slideIn 0.3s ease-out;`;
    document.body.appendChild(notification);
    setTimeout(() => { if (notification.parentElement) { notification.style.opacity = '0'; notification.style.transform = 'translateX(100px)'; setTimeout(() => notification.remove(), 300); } }, 5000);
}

// ==========================================================================
// 2. GARMIN INTEGRATION (Fixed 404 URL Paths)
// ==========================================================================

async function checkGarminConnection() {
    if (!CLOUD_SYNC_ENABLED || !USER_ID) return;
    try {
        // FIXED: Uses hyphen to match your file 'garmin-status.js'
        const response = await fetch(`${BACKEND_URL}/api/garmin-status?user_id=${USER_ID}`);
        const data = await response.json();
        updateGarminConnectionUI(data.connected, data.lastSync);
    } catch (error) {
        console.error('Error checking Garmin connection:', error);
        updateGarminConnectionUI(false);
    }
}

async function connectGarmin() {
    if (!CLOUD_SYNC_ENABLED || !USER_ID) {
        showNotification('‚ùå Cloud sync must be enabled first', 'error');
        return;
    }
    try {
        showNotification('üîÑ Connecting to Garmin...', 'info');
        // FIXED: Uses hyphen to match 'garmin-auth.js'
        const response = await fetch(`${BACKEND_URL}/api/garmin-auth?user_id=${USER_ID}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        const width = 600, height = 700;
        const left = (screen.width - width) / 2, top = (screen.height - height) / 2;
        window.open(data.authUrl, 'garmin-oauth', `width=${width},height=${height},left=${left},top=${top}`);
        
        window.addEventListener('message', function onMessage(event) {
            if (event.data.type === 'garmin_connected') {
                window.removeEventListener('message', onMessage);
                showNotification('‚úÖ Garmin connected successfully!', 'success');
                checkGarminConnection();
                syncGarminNow();
            }
        });
    } catch (error) {
        console.error('Garmin connect error:', error);
        showNotification(`‚ùå ${error.message}`, 'error');
    }
}

async function syncGarminNow() {
    if (!CLOUD_SYNC_ENABLED || !USER_ID) return;
    try {
        showNotification('üîÑ Syncing Garmin activities...', 'info');
        // FIXED: Uses hyphen to match 'garmin-sync.js'
        const response = await fetch(`${BACKEND_URL}/api/garmin-sync?user_id=${USER_ID}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        showNotification(`‚úÖ Synced ${data.activitiesCount} activities`, 'success');
        updateGarminConnectionUI(true, new Date().toISOString());
        checkGarminFiles(); 
    } catch (error) {
        console.error('Sync error:', error);
        showNotification(`‚ùå ${error.message}`, 'error');
    }
}

async function disconnectGarmin() {
    if (!confirm('Disconnect Garmin? You can reconnect anytime.')) return;
    try {
        // FIXED: Uses hyphen to match 'garmin-disconnect.js'
        const response = await fetch(`${BACKEND_URL}/api/garmin-disconnect?user_id=${USER_ID}`);
        const data = await response.json();
        if (data.success) {
            showNotification('‚úÖ Garmin disconnected', 'success');
            updateGarminConnectionUI(false);
        }
    } catch (error) {
        console.error('Disconnect error:', error);
        showNotification('‚ùå Failed to disconnect', 'error');
    }
}

// ==========================================================================
// 3. SUPABASE CLOUD SYNC SYSTEM (Full Database Logic)
// ==========================================================================

async function initSupabase() {
    try {
        console.log('üîÑ Initializing Supabase v51 (Backend Proxy)...');
        let attempts = 0;
        while (typeof window.supabase?.createClient !== 'function' && attempts < 100) {
            await new Promise(res => setTimeout(res, 100));
            attempts++;
        }
        if (typeof window.supabase?.createClient !== 'function') throw new Error('Supabase failed to load');

        supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        
        USER_ID = localStorage.getItem('nimble_user_id');
        if (!USER_ID) {
            USER_ID = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('nimble_user_id', USER_ID);
        }
        console.log('üÜî User ID:', USER_ID);

        CLOUD_SYNC_ENABLED = true;
        updateCloudSyncUI(); 
        await loadFromCloud();
        checkGarminConnection(); 
        console.log('‚úÖ Supabase initialized successfully! v51');
    } catch (error) {
        console.error('‚ùå Supabase init error:', error);
        CLOUD_SYNC_ENABLED = false;
        updateCloudSyncUI();
    }
}

async function saveWorkoutToCloud(workout) {
    if (!CLOUD_SYNC_ENABLED || !supabaseClient) return false;
    try {
        const { error } = await supabaseClient.from('workouts').insert({
            user_id: USER_ID, date: workout.date, type: workout.type, exercises: workout.exercises,
            duration: workout.duration || 0, notes: workout.notes || '', created_at: new Date().toISOString()
        });
        if (error) throw error;
        LAST_SYNC_TIME = new Date().toISOString();
        updateCloudSyncUI();
        console.log('‚úÖ Workout saved to cloud');
        return true;
    } catch (error) { console.error('Error saving workout:', error); return false; }
}

async function loadWorkoutsFromCloud() {
    if (!CLOUD_SYNC_ENABLED || !supabaseClient) return [];
    try {
        const { data, error } = await supabaseClient.from('workouts').select('*').eq('user_id', USER_ID).order('date', { ascending: false });
        if (error) throw error;
        console.log(`üì• Loaded ${data.length} workouts from cloud`);
        return data || [];
    } catch (error) { console.error('Error loading workouts:', error); return []; }
}

async function savePlanToCloud(plan) {
    if (!CLOUD_SYNC_ENABLED || !supabaseClient) return false;
    try {
        await supabaseClient.from('training_plans').delete().eq('user_id', USER_ID).eq('active', true);
        const { error } = await supabaseClient.from('training_plans').insert({
            user_id: USER_ID, name: plan.name || 'My Training Plan', plan_data: plan, active: true, created_at: new Date().toISOString()
        });
        if (error) throw error;
        LAST_SYNC_TIME = new Date().toISOString();
        updateCloudSyncUI();
        console.log('‚úÖ Training plan saved to cloud');
        return true;
    } catch (error) { console.error('Error saving plan:', error); return false; }
}

async function loadPlanFromCloud() {
    if (!CLOUD_SYNC_ENABLED || !supabaseClient) return null;
    try {
    const { data, error } = await supabaseClient.from('training_plans').select('*').eq('user_id', USER_ID).eq('active', true).maybeSingle();
        if (error && error.code !== 'PGRST116') throw error;
        console.log('üì• Loaded training plan from cloud');
        return data?.plan_data || null;
    } catch (error) { console.error('Error loading plan:', error); return null; }
}

async function saveGarminToCloud(filename, fileData, analysis) {
    if (!CLOUD_SYNC_ENABLED || !supabaseClient) return false;
    try {
        const { error } = await supabaseClient.from('garmin_files').insert({
            user_id: USER_ID, filename: filename, file_data: fileData, analysis: analysis || null, uploaded_at: new Date().toISOString()
        });
        if (error) throw error;
        LAST_SYNC_TIME = new Date().toISOString();
        updateCloudSyncUI();
        console.log('‚úÖ Garmin file saved to cloud');
        return true;
    } catch (error) { console.error('Error saving Garmin file:', error); return false; }
}

async function loadGarminFromCloud() {
    if (!CLOUD_SYNC_ENABLED || !supabaseClient) return [];
    try {
        const { data, error } = await supabaseClient.from('garmin_files').select('*').eq('user_id', USER_ID).order('uploaded_at', { ascending: false }).limit(10);
        if (error) throw error;
        console.log(`üì• Loaded ${data.length} Garmin files from cloud`);
        return data || [];
    } catch (error) { console.error('Error loading Garmin files:', error); return []; }
}

async function loadFromCloud() {
    if (!CLOUD_SYNC_ENABLED) return;
    try {
        console.log('üì• Loading data from cloud...');
        const cloudWorkouts = await loadWorkoutsFromCloud();
        const localWorkouts = JSON.parse(localStorage.getItem('workouts') || '[]');
        const workoutMap = new Map();
        localWorkouts.forEach(w => workoutMap.set(w.date, w));
        cloudWorkouts.forEach(w => workoutMap.set(w.date, w));
        localStorage.setItem('workouts', JSON.stringify(Array.from(workoutMap.values())));
        
        const cloudPlan = await loadPlanFromCloud();
        if (cloudPlan) localStorage.setItem('training_plan', JSON.stringify(cloudPlan));
        
        LAST_SYNC_TIME = new Date().toISOString();
        updateCloudSyncUI();
        console.log('‚úÖ Cloud data loaded successfully');
    } catch (error) { console.error('Error loading from cloud:', error); }
}

async function syncNow() {
    if (!CLOUD_SYNC_ENABLED) { showNotification('‚ùå Cloud sync not available', 'error'); return; }
    showNotification('üîÑ Syncing...', 'info');
    try {
        const workouts = JSON.parse(localStorage.getItem('workouts') || '[]');
        for (const workout of workouts) { await saveWorkoutToCloud(workout); }
        const plan = JSON.parse(localStorage.getItem('training_plan') || 'null');
        if (plan) { await savePlanToCloud(plan); }
        await loadFromCloud();
        showNotification('‚úÖ Sync complete!', 'success');
    } catch (error) { console.error('Sync error:', error); showNotification('‚ùå Sync failed', 'error'); }
}

function showSyncLog() { alert(`Last Sync: ${LAST_SYNC_TIME ? new Date(LAST_SYNC_TIME).toLocaleString() : 'Never'}\nUser ID: ${USER_ID}\nStatus: ${CLOUD_SYNC_ENABLED ? 'Connected' : 'Offline'}`); }

async function checkGarminFiles() {
    if (!CLOUD_SYNC_ENABLED) return;
    try {
        const garminFiles = await loadGarminFromCloud();
        const lastCheck = localStorage.getItem('last_garmin_check');
        if (!lastCheck && garminFiles.length > 0) {
            showNotification(`üìä ${garminFiles.length} Garmin file(s) available in cloud`, 'info');
            localStorage.setItem('last_garmin_check', new Date().toISOString());
        } else if (lastCheck) {
            const newFiles = garminFiles.filter(f => new Date(f.uploaded_at) > new Date(lastCheck));
            if (newFiles.length > 0) {
                showNotification(`üèÉ ${newFiles.length} new Garmin file(s) detected!`, 'info');
                localStorage.setItem('last_garmin_check', new Date().toISOString());
            }
        }
    } catch (error) { console.error('Garmin check error:', error); }
}

// ==========================================================================
// 4. AI PLAN GENERATOR (Full Feature Preserved)
// ==========================================================================

let aiWizardStep = 0;
let userProfile = {};

function startAIPlanWizard() {
    wizardProfile = {};
    wizardChatHistory = [];
    wizardQuestionIndex = 0;
    document.getElementById('ai-wizard-modal').classList.add('active');
    document.getElementById('wizard-chat-messages').innerHTML = '';
    document.getElementById('wizard-chips').innerHTML = '';
    document.getElementById('wizard-actions').style.display = 'none';
    document.getElementById('wizard-chat-input').value = '';
    askWizardQuestion();
}

var wizardProfile = {};
var wizardChatHistory = [];
var wizardQuestionIndex = 0;

var wizardQuestions = [
    {
        key: 'goal',
        text: "Hey! Let's build your perfect training plan. üí™ What's your primary goal?",
        chips: ['Build Strength', 'Build Muscle', 'Health & Longevity', 'Athletic Performance', 'Fat Loss', 'Flexibility & Mobility']
    },
    {
        key: 'experience',
        text: "Great choice! How would you describe your training experience?",
        chips: ['Beginner (< 1 year)', 'Intermediate (1-3 years)', 'Advanced (3+ years)']
    },
    {
        key: 'daysPerWeek',
        text: "How many days per week can you realistically commit to training?",
        chips: ['3 days', '4 days', '5 days', '6 days']
    },
    {
        key: 'planDuration',
        text: "How long do you want this plan to run?",
        chips: ['1 week', '4 weeks', '8 weeks', '12 weeks', '16 weeks']
    },
    {
        key: 'sessionLength',
        text: "How long do you want each session to be?",
        chips: ['30-40 mins', '45-60 mins', '60-90 mins']
    },
    {
        key: 'equipment',
        text: "What equipment do you have access to?",
        chips: ['Full gym', 'Home gym (dumbbells + bench)', 'Bodyweight only', 'Torque F9 + dumbbells']
    },
    {
        key: 'injuries',
        text: "Any injuries, limitations, or areas you want to be careful with? (Type 'none' if all good)",
        chips: ['None', 'Shoulder issues', 'Back pain', 'Knee problems']
    },
    {
        key: 'preferences',
        text: "Any preferences or things you want to include/avoid? For example: 'I love deadlifts', 'no running', 'include yoga'. Feel free to type anything or skip!",
        chips: ['No preferences - surprise me!', 'Include cardio days', 'Prefer compound movements', 'Include mobility work']
    }
];

function addWizardMessage(text, role) {
    const container = document.getElementById('wizard-chat-messages');
    const div = document.createElement('div');
    div.style.cssText = `margin-bottom:12px; display:flex; ${role === 'user' ? 'justify-content:flex-end' : 'justify-content:flex-start'}`;
    div.innerHTML = `<div style="max-width:85%; padding:10px 14px; border-radius:12px; ${role === 'user' ? 'background:var(--primary); color:#000;' : 'background:#2a2a2a; color:#fff;'} font-size:0.95em; line-height:1.4;">${text}</div>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    wizardChatHistory.push({ role, text });
}

function showWizardChips(chips) {
    const container = document.getElementById('wizard-chips');
    if (!chips || chips.length === 0) { container.innerHTML = ''; return; }
    container.innerHTML = '<div class="chip-container" style="padding:4px 0;">' + chips.map(c => `<span class="chip" onclick="selectWizardChip('${c.replace(/'/g, "\\'")}')" style="cursor:pointer; white-space:nowrap; font-size:0.8em; padding:6px 12px;">${c}</span>`).join('') + '</div>';
}

function selectWizardChip(value) {
    const q = wizardQuestions[wizardQuestionIndex];
    if (q) wizardProfile[q.key] = value;
    addWizardMessage(value, 'user');
    document.getElementById('wizard-chips').innerHTML = '';
    wizardQuestionIndex++;
    setTimeout(() => askWizardQuestion(), 400);
}

function sendWizardMessage() {
    const input = document.getElementById('wizard-chat-input');
    const text = input.value.trim();
    if (!text) return;
    input.value = '';
    
    const q = wizardQuestions[wizardQuestionIndex];
    if (q) wizardProfile[q.key] = text;
    
    addWizardMessage(text, 'user');
    document.getElementById('wizard-chips').innerHTML = '';
    wizardQuestionIndex++;
    setTimeout(() => askWizardQuestion(), 400);
}

function askWizardQuestion() {
    if (wizardQuestionIndex < wizardQuestions.length) {
        const q = wizardQuestions[wizardQuestionIndex];
        addWizardMessage(q.text, 'assistant');
        showWizardChips(q.chips);
    } else {
        // All questions asked - show summary and allow chat
        const summary = `Here's what I've got:\n‚Ä¢ Goal: ${wizardProfile.goal || 'Not set'}\n‚Ä¢ Experience: ${wizardProfile.experience || 'Not set'}\n‚Ä¢ Training days: ${wizardProfile.daysPerWeek || 'Not set'}\n‚Ä¢ Plan duration: ${wizardProfile.planDuration || 'Not set'}\n‚Ä¢ Session length: ${wizardProfile.sessionLength || 'Not set'}\n‚Ä¢ Equipment: ${wizardProfile.equipment || 'Not set'}\n‚Ä¢ Injuries: ${wizardProfile.injuries || 'None'}\n‚Ä¢ Preferences: ${wizardProfile.preferences || 'None'}\n\nLook good? Hit "Generate My Plan" below, or type any changes/extra details you'd like to add!`.replace(/\n/g, '<br>');
        addWizardMessage(summary, 'assistant');
        document.getElementById('wizard-actions').style.display = 'block';
        
        // Override send to allow follow-up chat
        document.getElementById('wizard-chat-input').placeholder = 'Add details, ask questions, or adjust anything...';
        wizardQuestionIndex = 999; // past all questions
    }
}

async function generateFromChat() {
    const actionsDiv = document.getElementById('wizard-actions');
    actionsDiv.innerHTML = '<div style="text-align:center; padding:15px;"><div class="loading" style="width:40px; height:40px; margin:0 auto 10px;"></div><p style="color:#888;">Generating your personalized plan...</p></div>';
    
    // Build a rich prompt from all gathered info
    const extraMessages = wizardChatHistory.filter(m => m.role === 'user').map(m => m.text).join('. ');
    
    const prompt = `Generate a personalized training plan based on this profile:
- Goal: ${wizardProfile.goal || 'general fitness'}
- Experience: ${wizardProfile.experience || 'intermediate'}
- Days per week: ${wizardProfile.daysPerWeek || '5'}
- Plan duration: ${wizardProfile.planDuration || '8 weeks'}
- Session length: ${wizardProfile.sessionLength || '45-60 mins'}
- Equipment: ${wizardProfile.equipment || 'full gym'}
- Injuries/limitations: ${wizardProfile.injuries || 'none'}
- Preferences: ${wizardProfile.preferences || 'none'}
- Additional context from conversation: ${extraMessages}

Return ONLY valid JSON with these fields:
{
  "name": "Plan name",
  "duration": number_of_weeks,
  "phases": [{"name":"Phase name","weeks":"1-4","focus":"description"}],
  "weekSchedule": {"monday":"push/pull/legs/cardio/rest/nimble","tuesday":"...","wednesday":"...","thursday":"...","friday":"...","saturday":"...","sunday":"..."},
  "guidance": "Brief overview of the plan approach"
}

The plan MUST be exactly ${wizardProfile.planDuration || '8 weeks'} long. Split into appropriate phases.
Use workout types: push, pull, legs, cardio, nimble, rest. Match the number of training days to ${wizardProfile.daysPerWeek || '5'}.`;

    try {
        const response = await fetch(`${BACKEND_URL}/api/drive`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: 'gemini', system: 'You are an expert fitness coach who creates detailed, periodized training plans. Always return valid JSON only, no markdown formatting.', messages: [{ role: "user", content: prompt }] })
        });
        
        if (!response.ok) {
            throw new Error(`API returned ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        // Handle different response formats
        let rawText = '';
        if (result.content && Array.isArray(result.content)) {
            rawText = result.content.map(c => c.text || '').join('');
        } else if (result.content && typeof result.content === 'string') {
            rawText = result.content;
        } else if (result.text) {
            rawText = result.text;
        } else if (result.response) {
            rawText = result.response;
        } else {
            rawText = JSON.stringify(result);
        }
        
        // Clean and parse JSON
        rawText = rawText.replace(/```json\n?/g, '').replace(/```/g, '').trim();
        const plan = JSON.parse(rawText);
        
        localStorage.setItem('currentPlan', JSON.stringify(plan));
        if (CLOUD_SYNC_ENABLED) { await savePlanToCloud(plan); }
        
        addWizardMessage(`‚úÖ <strong>${plan.name}</strong> is ready!<br><br><strong>Duration:</strong> ${plan.duration} weeks<br>${plan.guidance}`, 'assistant');
        actionsDiv.innerHTML = '<button class="btn btn-success" onclick="acceptPlan()" style="width:100%;">üéØ Start This Plan!</button><button class="btn btn-action" onclick="generateFromChat()" style="width:100%; margin-top:8px;">üîÑ Regenerate</button>';
    } catch (error) {
        console.error('Plan generation error:', error);
        addWizardMessage(`‚ùå Error: ${error.message}. Please try again.`, 'assistant');
        actionsDiv.innerHTML = '<button class="btn btn-action" onclick="generateFromChat()" style="width:100%;">üîÑ Try Again</button>';
    }
}

function renderWizardStep() {
    // Legacy compatibility - redirect to new chat wizard
    askWizardQuestion();
}

function acceptPlan() { document.getElementById('ai-wizard-modal').classList.remove('active'); switchTab('plan'); renderPlanCalendar(); showNotification('üéØ New training plan activated!', 'success'); }
function closeAIWizard() { document.getElementById('ai-wizard-modal').classList.remove('active'); }

// ==========================================================================
// 5. DAILY AI UPDATES (Elite Coach Recovery Logic)
// ==========================================================================

async function checkDailyUpdates() {
    const today = new Date().toDateString();
    if (localStorage.getItem('last_daily_update') === today) return;
    const hour = new Date().getHours();
    if (hour >= 6 && hour < 23) { await performDailyUpdate(); localStorage.setItem('last_daily_update', today); }
}

async function performDailyUpdate() {
    try {
        let garminData = null;
        if (CLOUD_SYNC_ENABLED) { const files = await loadGarminFromCloud(); if (files.length > 0) { garminData = files[0].analysis; } }
        if (!garminData) { const stored = localStorage.getItem('garmin_latest_data'); if (stored) garminData = JSON.parse(stored); }
        if (!garminData) return;
        const recommendation = await getAIDailyRecommendation(garminData);
        if (recommendation && recommendation.adjustments) { showDailyNotification(recommendation); logAIDecision(recommendation); }
    } catch (error) { console.error('Daily update error:', error); }
}

async function getAIDailyRecommendation(garminData) {
    try {
        const response = await fetch(`${BACKEND_URL}/api/drive`, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: 'gemini', system: 'AI fitness coach.', messages: [{ role: "user", content: `Analyze recovery: ${JSON.stringify(garminData)}. Return JSON with recoveryScore, adjustments (array), and reasoning.` }] })
        });
        const result = await response.json();
        const text = result.content[0].text.replace(/```json\n?/g, '').replace(/```/g, '').trim();
        return text === 'null' ? null : JSON.parse(text);
    } catch (error) { return null; }
}

function showDailyNotification(rec) {
    const div = document.createElement('div');
    div.className = 'daily-notification';
    div.innerHTML = `<div class="notification-header"><strong>ü§ñ AI Daily Update</strong><button onclick="this.parentElement.parentElement.remove()">‚úï</button></div><div class="notification-body"><p><strong>Recovery:</strong> ${rec.recoveryScore}/100</p><p>${rec.reasoning}</p></div><div class="notification-actions"><button class="btn-small btn-success" onclick="acceptAdjustments(${JSON.stringify(rec).replace(/"/g, '&quot;')})">Accept</button></div>`;
    document.body.appendChild(div);
    setTimeout(() => { if (div.parentElement) div.remove(); }, 8000);
}

function acceptAdjustments(rec) {
    const history = JSON.parse(localStorage.getItem('ai_adjustments') || '[]');
    history.unshift({ date: new Date().toISOString(), ...rec });
    localStorage.setItem('ai_adjustments', JSON.stringify(history.slice(0, 30)));
    showNotification('‚úÖ Adjustments applied', 'success');
}

function logAIDecision(decision) {
    const log = JSON.parse(localStorage.getItem('ai_decision_log') || '[]');
    log.unshift({ timestamp: Date.now(), type: 'daily_update', decision: decision });
    localStorage.setItem('ai_decision_log', JSON.stringify(log.slice(0, 100)));
}

// ==========================================================================
// 6. EXPORT SYSTEM (Full Feature Preserved)
// ==========================================================================

function exportAllData() {
    const data = { workouts: localStorage.getItem('completedWorkouts'), plan: localStorage.getItem('currentPlan'), exportDate: new Date().toISOString() };
    downloadBlob(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }), `nimble-shred-backup.json`);
    showNotification('‚úÖ Backup downloaded', 'success');
}

function exportWorkoutHistory() {
    const history = localStorage.getItem('completedWorkouts') || '[]';
    downloadBlob(new Blob([history], { type: 'application/json' }), `workout-history.json`);
    showNotification('‚úÖ History downloaded', 'success');
}

function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}

// ==========================================================================
// 7. GLOBAL INITIALIZATION (Final Fixed Order)
// ==========================================================================

document.addEventListener('DOMContentLoaded', () => {
    setTimeout(initGarminUpload, 500);
    initSupabase(); // Now safely runs after all UI/Logic functions are defined
    checkDailyUpdates();
});
function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function saveChatSettings() {
    const settings = {
        historyDays: parseInt(document.getElementById('chat-history-days')?.value || 7),
        contextAware: document.getElementById('context-aware')?.checked || true,
        quickActions: document.getElementById('quick-actions-enabled')?.checked !== false,
        mobileFullscreen: document.getElementById('mobile-fullscreen')?.checked || false
    };
    
    // Update global chat settings
    chatSettings = { ...chatSettings, ...settings };
    
    // Save to localStorage
    localStorage.setItem('chat_settings', JSON.stringify(settings));
    
    // Apply mobile fullscreen setting immediately
    const panel = document.getElementById('ai-chat-panel');
    if (panel) {
        if (settings.mobileFullscreen && window.innerWidth <= 768) {
            panel.classList.add('mobile-fullscreen');
        } else {
            panel.classList.remove('mobile-fullscreen');
        }
    }
    
    // Show/hide quick actions
    const quickActions = document.getElementById('quick-actions');
    if (quickActions) {
        quickActions.style.display = settings.quickActions ? 'flex' : 'none';
    }
    
    // Prune messages if history duration changed
    pruneOldMessages();
    
    showNotification('Chat settings saved', 'success');
}

// ==========================================
// AI CHAT SYSTEM
// ==========================================

let chatHistory = [];
let chatSettings = {
    historyDays: 7,
    contextAware: true,
    mobileFullscreen: false,
    quickActions: true
};

// Initialize chat system on page load
function initChatSystem() {
    loadChatSettings();
    loadChatHistory();
    renderChatMessages();
    pruneOldMessages();
}

// Load chat settings from localStorage or Drive
function loadChatSettings() {
    try {
        const stored = localStorage.getItem('chat_settings');
        if (stored) {
            chatSettings = { ...chatSettings, ...JSON.parse(stored) };
        }
        
        // Apply settings to UI elements
        const historySelect = document.getElementById('chat-history-days');
        if (historySelect) {
            historySelect.value = chatSettings.historyDays || 7;
        }
        
        const contextCheckbox = document.getElementById('context-aware');
        if (contextCheckbox) {
            contextCheckbox.checked = chatSettings.contextAware !== false;
        }
        
        const quickActionsCheckbox = document.getElementById('quick-actions-enabled');
        if (quickActionsCheckbox) {
            quickActionsCheckbox.checked = chatSettings.quickActions !== false;
        }
        
        const mobileCheckbox = document.getElementById('mobile-fullscreen');
        if (mobileCheckbox) {
            mobileCheckbox.checked = chatSettings.mobileFullscreen || false;
        }
        
        // Apply mobile fullscreen setting
        const panel = document.getElementById('ai-chat-panel');
        if (panel && chatSettings.mobileFullscreen && window.innerWidth <= 768) {
            panel.classList.add('mobile-fullscreen');
        }
        
        // Show/hide quick actions
        const quickActions = document.getElementById('quick-actions');
        if (quickActions) {
            quickActions.style.display = (chatSettings.quickActions !== false) ? 'flex' : 'none';
        }
    } catch (e) {
        console.error('Error loading chat settings:', e);
    }
}

// Load chat history from localStorage or Drive
function loadChatHistory() {
    try {
        const stored = localStorage.getItem('chat_history');
        if (stored) {
            chatHistory = JSON.parse(stored);
        }
    } catch (e) {
        console.error('Error loading chat history:', e);
        chatHistory = [];
    }
}

// Save chat history to localStorage
async function saveChatHistory() {
    try {
        localStorage.setItem('chat_history', JSON.stringify(chatHistory));
        // Note: Chat history could be synced to cloud if needed in future
    } catch (e) {
        console.error('Error saving chat history:', e);
    }
}

// Prune messages older than set days
function pruneOldMessages() {
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - chatSettings.historyDays);
    
    const originalLength = chatHistory.length;
    chatHistory = chatHistory.filter(msg => {
        const msgDate = new Date(msg.timestamp);
        return msgDate >= cutoffDate;
    });
    
    if (chatHistory.length < originalLength) {
        saveChatHistory();
        console.log(`Pruned ${originalLength - chatHistory.length} old messages`);
    }
}

// Toggle chat panel
function toggleChatPanel() {
    const panel = document.getElementById('ai-chat-panel');
    const button = document.getElementById('ai-chat-button');
    
    if (panel.classList.contains('open')) {
        panel.classList.remove('open');
        button.style.display = 'flex';
    } else {
        panel.classList.add('open');
        button.style.display = 'none';
        scrollChatToBottom();
        
        // Mark as read
        button.classList.remove('has-unread');
    }
}

// Get current context (what page user is on)
function getCurrentContext() {
    const activePage = document.querySelector('.container.active');
    if (!activePage) return 'Home';
    
    const pageId = activePage.id;
    const contextMap = {
        'view-coach': 'Workout Coach page',
        'view-plan': 'Training Plan page',
        'view-library': 'Exercise Library page',
        'view-recovery': 'Recovery & Analytics page',
        'view-settings': 'Settings page'
    };
    
    return contextMap[pageId] || 'App';
}

// Get contextual data for AI
function getContextualData() {
    const context = getCurrentContext();
    const data = {
        currentPage: context,
        hasActivePlan: !!localStorage.getItem('currentPlan'),
        workoutCount: (JSON.parse(localStorage.getItem('completedWorkouts') || '[]')).length,
        cloudSyncEnabled: CLOUD_SYNC_ENABLED
    };
    
    // Add page-specific context
    if (context.includes('Plan')) {
        const plan = JSON.parse(localStorage.getItem('currentPlan') || '{}');
        data.currentWeek = plan.currentWeek || 1;
    }
    
    if (context.includes('Recovery')) {
        const lastAnalysis = localStorage.getItem('last_recovery_analysis');
        if (lastAnalysis) {
            data.lastRecoveryScore = JSON.parse(lastAnalysis).recoveryScore;
        }
    }
    
    return data;
}

// Send message to AI
async function sendChatMessage(message = null) {
    const input = document.getElementById('chat-input');
    const text = message || input.value.trim();
    
    if (!text) return;
    
    // Clear input
    if (!message) input.value = '';
    
    // Add user message
    const userMessage = {
        role: 'user',
        content: text,
        timestamp: new Date().toISOString(),
        context: chatSettings.contextAware ? getCurrentContext() : null
    };
    
    chatHistory.push(userMessage);
    renderChatMessages();
    scrollChatToBottom();
    
    // Show typing indicator
    showTypingIndicator();
    
    try {
        // Prepare context for AI
        const contextData = chatSettings.contextAware ? getContextualData() : null;
        const systemPrompt = buildSystemPrompt(contextData);
        
        // Call Claude API through backend proxy
        // API key is stored securely in backend environment variables
        const response = await fetch(`${BACKEND_URL}/api/drive`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'gemini',
                system: systemPrompt,
                messages: formatChatHistory()
            })
        });
        
      if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `API Error: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Debug: log the response structure
        console.log('Backend response:', data);
        
        // Check if response has the expected structure
        if (!data || !data.content || !data.content[0] || !data.content[0].text) {
            console.error('Unexpected response structure:', data);
            throw new Error('Invalid response format from backend');
        }
        
        const assistantMessage = {
            role: 'assistant',
            content: data.content[0].text,
            timestamp: new Date().toISOString()
        };
        
        chatHistory.push(assistantMessage);
        hideTypingIndicator();
        renderChatMessages();
        scrollChatToBottom();
        saveChatHistory();
        
} catch (error) {
        console.error('Chat error:', error);
        hideTypingIndicator();
        
        // Use ONE declaration only to prevent SyntaxError
        const errorContent = `Sorry, I encountered an error: ${error.message}. 

Please check:
- Your Gemini API Key is saved in Vercel
- You have redeployed in Vercel without build cache
- Your internet connection is stable`;
        
        const errorMessage = {
            role: 'assistant',
            content: errorContent,
            timestamp: new Date().toISOString(),
            isError: true
        };
        chatHistory.push(errorMessage);
        renderChatMessages();
        scrollChatToBottom();
    }
} // <-- This second bracket is CRITICAL to close the function
// Build system prompt with context
function buildSystemPrompt(contextData) {
    let prompt = `You are an AI fitness coach assistant for Nimble Shred, a comprehensive workout tracking app. 
You help users with their training, provide exercise advice, and assist with workout planning.

Be concise, friendly, and action-oriented. Keep responses under 150 words unless asked for detailed explanations.`;
    
    if (contextData) {
        prompt += `\n\nCurrent context:
- User is on: ${contextData.currentPage}
- Has active training plan: ${contextData.hasActivePlan ? 'Yes' : 'No'}
- Total workouts completed: ${contextData.workoutCount}
- Cloud sync enabled: ${contextData.cloudSyncEnabled ? 'Yes' : 'No'}`;
        
        if (contextData.currentWeek) {
            prompt += `\n- Currently on week ${contextData.currentWeek} of their plan`;
        }
        if (contextData.lastRecoveryScore) {
            prompt += `\n- Latest recovery score: ${contextData.lastRecoveryScore}%`;
        }
    }
    
    return prompt;
}

// Format chat history for API (last 10 messages only)
function formatChatHistory() {
    return chatHistory
        .filter(msg => msg.role !== 'system' && !msg.isError)
        .slice(-10)
        .map(msg => ({
            role: msg.role,
            content: msg.content
        }));
}

// Render all messages
function renderChatMessages() {
    const container = document.getElementById('chat-messages');
    const emptyState = container.querySelector('.chat-empty-state');
    
    if (chatHistory.length === 0) {
        if (!emptyState) {
            container.innerHTML = `
                <div class="chat-empty-state">
                    <div class="emoji">üí¨</div>
                    <h3>Chat with AI Coach</h3>
                    <p>Ask me anything about your training, exercises, or recovery!</p>
                </div>
            `;
        }
        return;
    }
    
    // Remove empty state
    if (emptyState) emptyState.remove();
    
    // Clear and render messages
    container.innerHTML = '';
    chatHistory.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${msg.role}`;
        
        let contextBadge = '';
        if (msg.context && chatSettings.contextAware) {
            contextBadge = `<div class="message-context">üìç ${msg.context}</div>`;
        }
        
        const timestamp = new Date(msg.timestamp).toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit'
        });
        
        messageDiv.innerHTML = `
            ${contextBadge}
            <div class="message-bubble">${escapeHtml(msg.content)}</div>
            <div class="message-timestamp">${timestamp}</div>
        `;
        
        container.appendChild(messageDiv);
    });
}

// Show typing indicator
function showTypingIndicator() {
    const container = document.getElementById('chat-messages');
    const indicator = document.createElement('div');
    indicator.className = 'chat-message assistant';
    indicator.id = 'typing-indicator';
    indicator.innerHTML = `
        <div class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;
    container.appendChild(indicator);
    scrollChatToBottom();
}

// Hide typing indicator
function hideTypingIndicator() {
    document.getElementById('typing-indicator')?.remove();
}

// Scroll chat to bottom
function scrollChatToBottom() {
    const container = document.getElementById('chat-messages');
    setTimeout(() => {
        container.scrollTop = container.scrollHeight;
    }, 100);
}

// Quick action handlers
function quickActionModifyWorkout() {
    sendChatMessage("I'd like to modify today's workout based on how I'm feeling");
}

function quickActionExplainChanges() {
    sendChatMessage("Can you explain the recent changes to my training plan?");
}

function quickActionAdjustPlan() {
    sendChatMessage("I need to adjust my training plan. Can you help?");
}

// Handle Enter key in chat input
document.addEventListener('DOMContentLoaded', () => {
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        // Enter key handler
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });
        
        // Auto-resize textarea as user types
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });
    }
    
    // Initialize chat system
    initChatSystem();
    
    // Check for window resize to handle mobile/desktop transitions
    window.addEventListener('resize', () => {
        const panel = document.getElementById('ai-chat-panel');
        if (panel && chatSettings.mobileFullscreen) {
            if (window.innerWidth <= 768) {
                panel.classList.add('mobile-fullscreen');
            } else {
                panel.classList.remove('mobile-fullscreen');
            }
        }
    });
});

// Clear chat history
function clearChatHistory() {
    if (confirm('Clear all chat history? This cannot be undone.')) {
        chatHistory = [];
        saveChatHistory();
        renderChatMessages();
        showNotification('Chat history cleared', 'success');
    }
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Add AI message to chat (called by other systems like daily updates)
function addAIMessageToChat(message, context = null) {
    const aiMessage = {
        role: 'assistant',
        content: message,
        timestamp: new Date().toISOString(),
        context: context,
        automated: true
    };
    
    chatHistory.push(aiMessage);
    saveChatHistory();
    
    // Show unread indicator if chat is closed
    const panel = document.getElementById('ai-chat-panel');
    const button = document.getElementById('ai-chat-button');
    
    if (!panel?.classList.contains('open')) {
        button?.classList.add('has-unread');
    }
    
    // If chat is open, render the new message
    if (panel?.classList.contains('open')) {
        renderChatMessages();
        scrollChatToBottom();
    }
}

// Integration helper for daily AI updates
function notifyUserOfAIUpdate(updateType, changes) {
    let message = '';
    
    switch (updateType) {
        case 'workout_modified':
            message = `I've modified today's workout based on your recovery data:\n\n${changes.join('\n')}`;
            break;
        case 'rest_recommended':
            message = `Based on your recovery metrics, I recommend taking a rest day today. Your body needs time to recover.`;
            break;
        case 'intensity_adjusted':
            message = `I've adjusted your workout intensity:\n\n${changes.join('\n')}`;
            break;
        default:
            message = changes.join('\n');
    }
    
    addAIMessageToChat(message, 'Daily Recovery Update');
}

</script>

<!-- AI CHAT INTERFACE -->
<button id="ai-chat-button" onclick="toggleChatPanel()" title="Chat with AI Coach">
    ü§ñ
</button>

<div id="ai-chat-panel">
    <div class="chat-header">
        <h3>
            <span>ü§ñ</span>
            <span>AI Coach</span>
        </h3>
        <button class="chat-minimize" onclick="toggleChatPanel()" title="Minimize">‚àí</button>
    </div>
    
    <div class="chat-quick-actions" id="quick-actions">
        <button class="quick-action-btn" onclick="quickActionModifyWorkout()">
            ‚ö° Modify Workout
        </button>
        <button class="quick-action-btn" onclick="quickActionExplainChanges()">
            üìä Explain Changes
        </button>
        <button class="quick-action-btn" onclick="quickActionAdjustPlan()">
            üìÖ Adjust Plan
        </button>
    </div>
    
    <div class="chat-messages" id="chat-messages">
        <div class="chat-empty-state">
            <div class="emoji">üí¨</div>
            <h3>Chat with AI Coach</h3>
            <p>Ask me anything about your training, exercises, or recovery!</p>
        </div>
    </div>
    
    <div class="chat-input-area">
        <textarea 
            id="chat-input" 
            class="chat-input" 
            placeholder="Ask me anything..."
            rows="1"
        ></textarea>
        <button class="chat-send-btn" onclick="sendChatMessage()" title="Send message">
            ‚û§
        </button>
    </div>
</div>

</body>
</html>
