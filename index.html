<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Nimble Shred v19.0 (Food DB)</title>
    
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiTmltYmxlIFNocmVkIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxMjEyMTIiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzFlMWUxZSIsImljb25zIjpbeyJzcmMiOiJodHRwczovL2ltZy5pY29uczguY29tL2ZsdWVuY3kvOTYvbnVsbC9kdW1iYmVsbC5wbmciLCJzaXplcyI6Ijk2eDk2IiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/null/dumbbell.png">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg-color: #121212; --card-bg: #1e1e1e; --primary: #BB86FC; --secondary: #03DAC6; --text: #ffffff; --gold: #FFD700; --danger: #CF6679; --success: #00C853; --work-mode: #76FF03; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text); margin: 0; padding: 20px; padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3 { text-align: center; margin-bottom: 10px; margin-top: 5px; }
        .container { max-width: 600px; margin: 0 auto; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .unit-toggle { background: #333; color: #aaa; border: 1px solid #555; padding: 5px 10px; border-radius: 15px; font-size: 0.8em; cursor: pointer; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; display: flex; justify-content: space-around; padding: 12px 10px; border-top: 1px solid #333; z-index: 999; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        .nav-btn { background: none; color: #777; border: none; font-size: 0.75em; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-btn.active { color: var(--secondary); }
        .nav-icon { font-size: 1.4em; }
        .card { background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .slider-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; }
        input[type=range] { width: 100%; accent-color: var(--primary); }
        .btn { display: block; width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; color: #000; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-generate { background-color: var(--secondary); }
        .btn-log { background-color: var(--primary); }
        .btn-calc { background-color: #444; color: #fff; margin-top: 5px; }
        .btn-timer { background-color: var(--primary); margin-top: 5px; font-size: 0.9em; padding: 10px; }
        .btn-work { background-color: var(--work-mode); color: #000; margin-top: 5px; font-size: 0.9em; padding: 10px; font-weight: 800; }
        .btn-finish { background-color: #333; color: #fff; margin-top: 20px; border: 1px solid var(--secondary); }
        .btn-save-routine { background-color: #333; color: var(--gold); border: 1px solid var(--gold); font-size: 0.9em; padding: 8px; width: auto; display: inline-block; }
        .btn-save-gif { background-color: #444; color: #fff; border: 1px solid #666; font-size: 0.8em; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-top: 5px; }
        .btn-build { background-color: #444; color: #fff; border: 1px solid #666; margin-top: 10px; }
        .btn-add-ex { background-color: var(--secondary); color: #000; width: auto; display: block; margin: 20px auto; padding: 10px 30px; }
        .action-row { display: flex; gap: 10px; align-items: center; }
        .btn-action { display: inline-block; background: #333; color: #aaa; text-decoration: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; margin-top: 5px; border: 1px solid #444; cursor: pointer; }
        .btn-action.has-gif { border-color: var(--secondary); color: var(--secondary); }
        .btn-icon-only { background: none; border: none; font-size: 1.2em; cursor: pointer; padding: 0 5px; }
        .exercise-card { background: var(--card-bg); padding: 15px; margin-bottom: 15px; border-radius: 10px; border-left: 5px solid var(--primary); position: relative; }
        .exercise-card.mobility { border-left-color: var(--secondary); }
        .exercise-card.strength { border-left-color: var(--danger); }
        .exercise-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .exercise-title { font-size: 1.1em; font-weight: bold; display: block; }
        .exercise-meta { font-size: 0.8em; color: #aaa; margin-bottom: 5px; }
        .ghost-stats { font-size: 0.85em; color: var(--gold); margin-bottom: 10px; font-style: italic; display: flex; align-items: center; gap: 5px; }
        .instruction-box { background: #252525; padding: 10px; border-radius: 5px; margin-top: 10px; margin-bottom: 10px; font-size: 0.9em; color: #ddd; border-left: 2px solid #777; display: none; line-height: 1.4; }
        .instruction-box.visible { display: block; }
        .gif-input-container { margin-top: 10px; border-top: 1px solid #444; padding-top: 10px; }
        .gif-input { width: 100%; padding: 5px; background: #111; border: 1px solid #444; color: #fff; border-radius: 4px; margin-bottom: 5px; }
        .log-inputs { display: flex; gap: 10px; margin-top: 10px; align-items: flex-end; }
        .input-group { flex: 1; }
        .input-group label { display: block; font-size: 0.8em; color: #aaa; margin-bottom: 2px;}
        .input-group input, .input-group select { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #444; background: #2c2c2c; color: #fff; text-align: center; font-size: 1.1em; }
        .garmin-section { border-top: 1px solid #333; margin-top: 20px; padding-top: 20px; text-align: center; }
        .garmin-input { width: 50%; padding: 10px; font-size: 1.2em; text-align: center; background: #2c2c2c; border: 1px solid var(--secondary); border-radius: 8px; color: #fff; margin-top: 10px; }
        #timer-overlay { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.95); height: 0; overflow: hidden; transition: height 0.3s; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        #timer-display { font-size: 4em; font-weight: bold; font-variant-numeric: tabular-nums; color: var(--primary); }
        .timer-controls { display: flex; gap: 20px; margin-top: 20px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #333; display: inline-block; margin-right: 5px; }
        .status-dot.online { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .hidden { display: none; }
        .split-select { background: #333; color: #fff; padding: 10px; border-radius: 5px; width: 100%; border: 1px solid #555; margin-bottom: 15px; font-size: 1.1em; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 1500; }
        .modal-content { background: var(--card-bg); padding: 20px; border-radius: 10px; width: 95%; max-width: 500px; text-align: center; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-modal { position: absolute; top: 10px; right: 15px; color: #fff; font-size: 24px; cursor: pointer; }
        .plate-vis { display: flex; justify-content: center; align-items: center; gap: 2px; margin: 15px 0; overflow-x: auto; }
        .plate { height: 40px; background: #444; border: 1px solid #777; color: #fff; font-size: 0.7em; display: flex; align-items: center; justify-content: center; width: 10px; }
        .plate-45 { width: 15px; background: #2196F3; height: 50px; } .plate-25 { width: 12px; background: #4CAF50; height: 40px; } .plate-10 { width: 10px; background: #fff; color: #000; height: 30px; }
        .bar { height: 10px; width: 60px; background: #777; }
        #gif-player { width: 100%; height: auto; border-radius: 8px; margin-top: 10px; min-height: 200px; background: #000; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        #builder-list { max-height: 300px; overflow-y: auto; text-align: left; margin-top: 10px; border: 1px solid #333; border-radius: 5px; }
        .builder-item { padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .builder-item:last-child { border-bottom: none; }
        .builder-add-btn { background: var(--secondary); color: #000; border: none; border-radius: 50%; width: 25px; height: 25px; font-weight: bold; cursor: pointer; }
        .builder-search { width: 100%; box-sizing: border-box; padding: 10px; margin-bottom: 5px; background: #333; border: 1px solid #555; color: #fff; border-radius: 5px; }
        .selected-count { background: var(--primary); color: #000; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 10px; }
        .food-item-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #333; font-size: 0.9em; }
        .remove-food { color: var(--danger); cursor: pointer; font-weight: bold; margin-left: 10px; }
        
        /* New Food DB Styles */
        #custom-food-form { margin-top: 15px; border-top: 1px solid #444; padding-top: 10px; display: none; }
        .toggle-link { color: var(--secondary); text-decoration: underline; cursor: pointer; font-size: 0.9em; display: block; margin-top: 10px; text-align: right; }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div class="container" id="view-readiness">
    <div class="top-bar">
        <h1 style="margin:0; font-size:1.2em; color:#777;">Nimble Shred</h1>
        <button class="unit-toggle" onclick="toggleUnit()">WEIGHT: <span id="unit-disp-1">LBS</span></button>
    </div>
    <div class="card" style="text-align:center; padding:30px;">
        <h1 style="font-size:2em; color:var(--text);">Start Day</h1>
        <div class="score-circle" id="score-val">--</div>
        <div class="score-msg" id="score-text">Check-in to calibrate</div>
    </div>

    <div id="readiness-form">
        <div class="card">
            <div class="slider-label"><span>Sleep Quality</span> <span id="val-sleep">5</span>/10</div>
            <input type="range" id="slider-sleep" min="1" max="10" value="5" oninput="updateReadinessUI()">
            <div class="slider-label" style="margin-top:15px;"><span>Soreness</span> <span id="val-sore">5</span>/10</div>
            <input type="range" id="slider-sore" min="1" max="10" value="5" oninput="updateReadinessUI()">
            <div class="slider-label" style="margin-top:15px;"><span>Mood/Energy</span> <span id="val-mood">5</span>/10</div>
            <input type="range" id="slider-mood" min="1" max="10" value="5" oninput="updateReadinessUI()">
            <div class="garmin-section">
                <div style="color:#888; margin-bottom:10px; font-size:0.8em;">OR SYNC MANUALLY</div>
                <input type="number" id="inp-garmin" class="garmin-input" placeholder="Garmin Score (0-100)">
            </div>
        </div>
        <button class="btn btn-generate" onclick="calcReadiness()">CALCULATE & START</button>
    </div>
</div>

<div class="container hidden" id="view-coach">
    
    <div id="setup-panel">
        <div class="top-bar">
            <h2>Workout Strategy</h2>
            <button class="unit-toggle" onclick="toggleUnit()"><span id="unit-disp-2">LBS</span></button>
        </div>
        
        <div class="card">
            <label style="color:#aaa; font-size:0.9em; display:block; margin-bottom:5px;">Saved Routines</label>
            <select id="saved-routines" class="split-select" onchange="loadRoutine(this.value)">
                <option value="">-- Load Saved --</option>
            </select>

            <hr style="border:0; border-top:1px solid #333; margin:15px 0;">

            <label style="color:#aaa; font-size:0.9em; display:block; margin-bottom:5px;">Or Generate New Split</label>
            <select id="split-selector" class="split-select">
                <option value="full">Full Body</option>
                <option value="bodyweight">BODYWEIGHT ONLY</option>
                <option value="push">PUSH (Chest/Shoulders/Tri)</option>
                <option value="pull">PULL (Back/Biceps/Traps)</option>
                <option value="legs">LEGS (Quads/Hams/Glutes)</option>
                <option value="core">CORE & RECOVERY</option>
            </select>

            <div class="slider-label"><span>Strength</span> <span id="val-strength">3</span></div>
            <input type="range" id="slider-strength" min="0" max="5" value="3" oninput="updateSliders()">
            <div class="slider-label"><span>Shred</span> <span id="val-shred">3</span></div>
            <input type="range" id="slider-shred" min="0" max="5" value="3" oninput="updateSliders()">
            <div class="slider-label"><span>Mobility</span> <span id="val-mobility">3</span></div>
            <input type="range" id="slider-mobility" min="0" max="5" value="3" oninput="updateSliders()">
        </div>
        <button class="btn btn-generate" onclick="generateWorkout()">üé≤ GENERATE RANDOM</button>
        <button class="btn btn-build" onclick="openBuilder()">üõ†Ô∏è BUILD CUSTOM</button>
    </div>

    <div id="builder-panel" class="hidden">
        <div class="top-bar">
            <h2>Build Custom</h2>
            <button class="btn-icon-only" onclick="closeBuilder()">‚ùå</button>
        </div>
        <div class="card">
            <input type="text" id="builder-search" class="builder-search" placeholder="Search exercises..." onkeyup="filterBuilderList()">
            <div style="display:flex; gap:5px;">
                <select id="builder-cat-filter" class="input-group" onchange="filterBuilderList()">
                    <option value="all">All Categories</option>
                </select>
                <select id="builder-type-filter" class="input-group" onchange="filterBuilderList()">
                    <option value="all">All Types</option>
                    <option value="Strength">Strength</option>
                    <option value="Muscle Build">Shred</option>
                    <option value="Mobility">Mobility</option>
                    <option value="Calisthenics">Calisthenics</option>
                </select>
            </div>
            <div id="builder-list"></div>
        </div>
        <div style="text-align:center; padding:10px;">
            Selected: <span id="builder-count" class="selected-count">0</span>
        </div>
        <button class="btn btn-generate" onclick="startCustomWorkout()">START CUSTOM</button>
    </div>

    <div id="active-workout" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <button class="btn-save-routine" onclick="saveCurrentRoutine()">‚≠ê Save Routine</button>
            <button onclick="cancelWorkout()" style="background:none; border:none; color:#aaa; text-decoration:underline;">Cancel</button>
        </div>
        <div id="workout-list"></div>
        <button class="btn btn-add-ex" onclick="openBuilder(true)">‚ûï Add Exercise</button>
        <button class="btn btn-finish" onclick="finishSession()">üíæ FINISH & UPLOAD</button>
    </div>
</div>

<div class="container hidden" id="view-tools">
    <h1>Tools & Fuel</h1>
    
    <div class="card">
        <h3>Fuel Log</h3>
        <div class="daily-total">Total: <span id="total-cals">0</span> kcal / <span id="total-prot">0</span>g Pro</div>
        
        <div id="food-search-container">
            <div class="search-row">
                <input list="food-list" id="food-search" class="input-group" placeholder="Search Food (e.g. Chicken)">
                <datalist id="food-list"></datalist>
                <input type="number" id="food-qty" class="input-group" placeholder="Qty">
            </div>
            <button class="btn btn-calc" onclick="calcFood()">‚¨áÔ∏è Fill</button>
            
            <div class="toggle-link" onclick="toggleCustomFood()">+ Create New Food</div>
            <div id="custom-food-form">
                <input type="text" id="new-food-name" class="input-group" placeholder="Name" style="width:100%; margin-bottom:5px;">
                <div style="display:flex; gap:5px;">
                    <input type="number" id="new-food-cal" class="input-group" placeholder="Cals (100g)">
                    <input type="number" id="new-food-pro" class="input-group" placeholder="Prot (100g)">
                </div>
                <button class="btn btn-save-gif" style="width:100%;" onclick="saveNewFood()">Save to My Pantry</button>
            </div>
        </div>

        <div class="log-inputs">
            <div class="input-group"><label>Cals</label><input type="number" id="inp-cals"></div>
            <div class="input-group"><label>Prot (g)</label><input type="number" id="inp-prot"></div>
        </div>
        <button class="btn btn-log" style="margin-top:10px;" onclick="logNutrition()">‚ûï Log</button>
        
        <div id="todays-food-list" style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">
            </div>
    </div>

    <div class="card">
        <h3>1-Rep Max Estimator</h3>
        <div class="log-inputs"><div class="input-group"><label>Weight</label><input type="number" id="rm-weight" placeholder="0"></div><div class="input-group"><label>Reps</label><input type="number" id="rm-reps" placeholder="0"></div></div>
        <div id="rm-result" style="text-align:center; margin-top:10px; font-weight:bold; color:var(--primary); font-size:1.2em;">--</div>
        <button class="btn btn-calc" onclick="calc1RM()">Calculate</button>
    </div>
</div>

<div class="container hidden" id="view-progress">
    <h1>Stats</h1>
    <div class="cal-header">Cloud: <span id="cloud-status" class="status-dot"></span></div>
    <div id="calendar-heatmap" class="calendar-grid"></div>
    <h3 style="margin-top:30px;">Progress</h3>
    <select id="exercise-select" onchange="renderChart()"><option value="">-- Choose Exercise --</option></select>
    <div id="chart-container"><canvas id="progressChart"></canvas></div>
</div>

<div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('readiness')" id="nav-readiness"><span class="nav-icon">üîã</span>Check-In</button>
    <button class="nav-btn" onclick="switchTab('coach')" id="nav-coach"><span class="nav-icon">üèãÔ∏è</span>Workout</button>
    <button class="nav-btn" onclick="switchTab('tools')" id="nav-tools"><span class="nav-icon">üßÆ</span>Tools</button>
    <button class="nav-btn" onclick="switchTab('progress')" id="nav-progress"><span class="nav-icon">üìà</span>Stats</button>
</div>

<div id="plate-modal" class="modal" onclick="closeModal('plate-modal')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="closeModal('plate-modal')">&times;</span>
        <h3>Plate Calculator</h3>
        <input type="number" id="plate-weight-input" class="garmin-input" placeholder="Weight" oninput="calcPlates()">
        <div id="plate-visuals" class="plate-vis"></div>
        <div id="plate-text" style="color:#aaa; margin-top:10px;"></div>
    </div>
</div>
<div id="gif-modal" class="modal" onclick="closeModal('gif-modal')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="closeModal('gif-modal')">&times;</span>
        <h3 id="gif-modal-title">Technique</h3>
        <img id="gif-player" src="" alt="Exercise Demo">
        <button class="btn btn-finish" style="margin-top:20px;" onclick="closeModal('gif-modal')">Close</button>
    </div>
</div>

<div id="timer-overlay">
    <div id="timer-display">00:00</div>
    <div class="timer-controls">
        <button class="btn" style="background:#444; color:#fff; width:100px;" onclick="addTime(10)">+10s</button>
        <button class="btn" style="background:var(--danger); color:#fff; width:100px;" onclick="closeTimer()">Stop</button>
    </div>
</div>

<script>
    // --- CONFIG ---
    const GOOGLE_SCRIPT_URL = "https://script.google.com/a/macros/tjkcivil.com.au/s/AKfycbwG0PbAwqkX3EbWki7vjewgP-FIwCt11_ybFsFJrYmmgq6_QpfKrbPfRxeSEJGu7Ovg/exec"; 

    // --- DATA ---
    const allExercises = [
  {"name": "Low Cable Chest Fly", "categories": ["Chest", "Shoulders"], "type": "Muscle Build", "desc": "Set pulleys low. Step forward. Scoop hands up and in."},
  {"name": "High Cable Chest Fly", "categories": ["Chest"], "type": "Muscle Build", "desc": "Set pulleys high. Press hands down and together."},
  {"name": "Cable Lateral Raise", "categories": ["Shoulders"], "type": "Muscle Build", "desc": "Raise arm to side. Control drop."},
  {"name": "Face Pulls", "categories": ["Shoulders", "Back"], "type": "Mobility", "desc": "Pull to forehead. Drive elbows OUT and BACK."},
  {"name": "Lat Pulldown", "categories": ["Back", "Biceps"], "type": "Strength", "desc": "Drive elbows down to back pockets."},
  {"name": "Seated Row", "categories": ["Back", "Biceps"], "type": "Strength", "desc": "Pull to stomach. Squeeze shoulder blades."},
  {"name": "Tricep Pushdown", "categories": ["Triceps"], "type": "Muscle Build", "desc": "Elbows pinned to ribs. Extend fully."},
  {"name": "Bicep Cable Curl", "categories": ["Biceps"], "type": "Muscle Build", "desc": "Elbows pinned. Curl to chin."},
  {"name": "Cable Crunch", "categories": ["Abs", "Core"], "type": "Muscle Build", "desc": "Kneel. Curl elbows to thighs using abs."},
  {"name": "Cable Pull-through", "categories": ["Glutes", "Hamstrings"], "type": "Muscle Build", "desc": "Face away. Hinge hips back. Snap forward."},
  {"name": "Cable Kickbacks", "categories": ["Glutes"], "type": "Muscle Build", "desc": "Kick leg back and up. Squeeze glute."},
  {"name": "Single Arm Lat Pulldown", "categories": ["Back", "Biceps"], "type": "Muscle Build", "desc": "Pull elbow to hip. Rotate palm."},
  {"name": "Woodchopper", "categories": ["Core", "Shoulders"], "type": "Mobility", "desc": "Rotate torso. Pull diagonally."},
  {"name": "Cable Shrugs", "categories": ["Traps", "Shoulders"], "type": "Muscle Build", "desc": "Shrug shoulders to ears. Pause."},
  {"name": "Cable Upright Row", "categories": ["Shoulders", "Traps"], "type": "Muscle Build", "desc": "Pull elbows high and wide to ears."},
  {"name": "Cable Rear Delt Fly", "categories": ["Shoulders", "Back"], "type": "Muscle Build", "desc": "Cross cables. Pull arms back like a T."},
  {"name": "Incline Cable Press", "categories": ["Chest", "Shoulders"], "type": "Muscle Build", "desc": "Press up and in. Squeeze upper chest."},
  {"name": "Cable Overhead Tricep Extension", "categories": ["Triceps"], "type": "Muscle Build", "desc": "Extend arms overhead. Elbows tight."},
  {"name": "Cable Pec Deck", "categories": ["Chest"], "type": "Muscle Build", "desc": "Elbows high. Squeeze chest hard."},
  {"name": "Cable Internal Rotation", "categories": ["Shoulders", "Mobility"], "type": "Mobility", "desc": "Elbow at side. Pull hand IN."},
  {"name": "Cable External Rotation", "categories": ["Shoulders", "Mobility"], "type": "Mobility", "desc": "Elbow at side. Pull hand OUT."},
  {"name": "Dumbbell Chest Press", "categories": ["Chest", "Triceps"], "type": "Strength", "desc": "Press weights over chest. Elbows 45 deg."},
  {"name": "Dumbbell Shoulder Press", "categories": ["Shoulders", "Triceps"], "type": "Strength", "desc": "Press overhead. Core tight."},
  {"name": "Goblet Squat", "categories": ["Legs", "Glutes", "Core"], "type": "Strength", "desc": "Hold weight at chest. Squat deep."},
  {"name": "Romanian Deadlift (Dumbbell)", "categories": ["Hamstrings", "Glutes", "Back"], "type": "Strength", "desc": "Hinge hips back. Slight knee bend."},
  {"name": "Dumbbell Rows", "categories": ["Back", "Biceps"], "type": "Strength", "desc": "Back flat. Pull to hip pocket."},
  {"name": "Lateral Raises (Dumbbell)", "categories": ["Shoulders"], "type": "Muscle Build", "desc": "Lift to side. Lead with elbows."},
  {"name": "Dumbbell Lunges", "categories": ["Legs", "Glutes"], "type": "Strength", "desc": "Step forward. Drop back knee."},
  {"name": "Bicep Curls (Dumbbell)", "categories": ["Biceps"], "type": "Muscle Build", "desc": "Curl to shoulder. Squeeze."},
  {"name": "Tricep Kickbacks", "categories": ["Triceps"], "type": "Muscle Build", "desc": "Bend over. Extend arm back."},
  {"name": "Hammer Curls", "categories": ["Biceps", "Forearms"], "type": "Muscle Build", "desc": "Neutral grip. Curl up."},
  {"name": "Arnold Press", "categories": ["Shoulders", "Triceps"], "type": "Strength", "desc": "Rotate palms out as you press up."},
  {"name": "Dumbbell Shrugs", "categories": ["Traps"], "type": "Muscle Build", "desc": "Shoulders to ears. Hold."},
  {"name": "Bulgarian Split Squat", "categories": ["Legs", "Glutes"], "type": "Strength", "desc": "Back foot on bench. Drive up."},
  {"name": "Dumbbell Flys", "categories": ["Chest"], "type": "Muscle Build", "desc": "Open arms wide. Squeeze center."},
  {"name": "Step-ups", "categories": ["Legs", "Glutes"], "type": "Strength", "desc": "Drive through heel to stand tall."},
  {"name": "Farmers Walk", "categories": ["Core", "Traps", "Forearms"], "type": "Strength", "desc": "Heavy weights. Walk tall.", "isTimed": true, "duration": 60},
  {"name": "Renegade Row", "categories": ["Core", "Back", "Shoulders"], "type": "Strength", "desc": "Plank row. Don't twist hips."},
  {"name": "Skull Crushers (Dumbbell)", "categories": ["Triceps"], "type": "Muscle Build", "desc": "Weights to ears. Extend up."},
  {"name": "Front Raises (Dumbbell)", "categories": ["Shoulders"], "type": "Muscle Build", "desc": "Lift straight front. No swing."},
  {"name": "Push-ups", "categories": ["Chest", "Triceps", "Core"], "type": "Calisthenics", "desc": "Chest to floor. Plank body."},
  {"name": "Pull-ups", "categories": ["Back", "Biceps"], "type": "Calisthenics", "desc": "Chin over bar. Dead hang."},
  {"name": "Dips", "categories": ["Chest", "Triceps", "Shoulders"], "type": "Calisthenics", "desc": "Shoulders below elbows. Press."},
  {"name": "Bodyweight Squats", "categories": ["Legs"], "type": "Calisthenics", "desc": "Hips back/down. Chest up."},
  {"name": "Lunges", "categories": ["Legs"], "type": "Calisthenics", "desc": "Step forward. Drop knee."},
  {"name": "Planks", "categories": ["Core", "Abs"], "type": "Calisthenics", "desc": "Elbows under shoulders. Tight.", "isTimed": true, "duration": 60},
  {"name": "Burpees", "categories": ["Full Body", "Cardio"], "type": "Calisthenics", "desc": "Chest to floor. Jump up."},
  {"name": "Mountain Climbers", "categories": ["Core", "Cardio"], "type": "Calisthenics", "desc": "Knees to chest rapidly.", "isTimed": true, "duration": 45},
  {"name": "Chin-ups", "categories": ["Back", "Biceps"], "type": "Calisthenics", "desc": "Palms facing you. Pull up."},
  {"name": "Leg Raises", "categories": ["Core", "Abs"], "type": "Calisthenics", "desc": "Lift legs to 90. Control down."},
  {"name": "Bench Dips", "categories": ["Triceps"], "type": "Calisthenics", "desc": "Hands behind. Lower hips."},
  {"name": "Box Jumps", "categories": ["Legs", "Cardio"], "type": "Calisthenics", "desc": "Explode up. Soft landing."},
  {"name": "Glute Bridge", "categories": ["Glutes"], "type": "Calisthenics", "desc": "Hips to ceiling. Squeeze."},
  {"name": "Superman", "categories": ["Lower Back", "Core"], "type": "Mobility", "desc": "Lift limbs. Hold.", "isTimed": true, "duration": 30},
  {"name": "Inverted Row", "categories": ["Back", "Biceps"], "type": "Calisthenics", "desc": "Pull chest to bar. Body straight."},
  {"name": "Pistol Squats", "categories": ["Legs", "Mobility"], "type": "Mobility", "desc": "One leg squat. Balance."},
  {"name": "Bear Crawl", "categories": ["Full Body", "Core"], "type": "Mobility", "desc": "Crawl on all fours. Knees low.", "isTimed": true, "duration": 45},
  {"name": "Hollow Body Hold", "categories": ["Core", "Abs"], "type": "Calisthenics", "desc": "Low back on floor. Hold.", "isTimed": true, "duration": 30},
  {"name": "Cat-Cow", "categories": ["Core", "Mobility"], "type": "Mobility", "desc": "Arch and sink spine."},
  {"name": "World's Greatest Stretch", "categories": ["Full Body", "Mobility"], "type": "Mobility", "desc": "Lunge + Rotate.", "isTimed": true, "duration": 45},
  {"name": "Barbell Back Squat", "categories": ["Legs", "Glutes", "Core"], "type": "Strength", "desc": "Bar on traps. Hips back."},
  {"name": "Barbell Bench Press", "categories": ["Chest", "Triceps", "Shoulders"], "type": "Strength", "desc": "Bar to mid chest. Press."},
  {"name": "Barbell Deadlift", "categories": ["Back", "Hamstrings", "Glutes"], "type": "Strength", "desc": "Lift from floor. Lock hips."},
  {"name": "Barbell Overhead Press", "categories": ["Shoulders", "Triceps"], "type": "Strength", "desc": "Press bar overhead. Core tight."},
  {"name": "Barbell Row", "categories": ["Back", "Biceps"], "type": "Strength", "desc": "Bent over. Pull to stomach."},
  {"name": "Walking Lunges", "categories": ["Legs", "Cardio"], "type": "Calisthenics", "desc": "Lunge forward continuously."},
  {"name": "Side Plank", "categories": ["Core", "Obliques"], "type": "Calisthenics", "desc": "Hips high. Hold.", "isTimed": true, "duration": 45},
  {"name": "Bird Dog", "categories": ["Core", "Lower Back"], "type": "Mobility", "desc": "Opposite arm/leg extend.", "isTimed": true, "duration": 30},
  {"name": "Dead Bug", "categories": ["Core", "Abs"], "type": "Mobility", "desc": "Opposite arm/leg lower. Back flat.", "isTimed": true, "duration": 45},
  {"name": "Glute Bridge March", "categories": ["Glutes", "Core"], "type": "Mobility", "desc": "Bridge. March legs."},
  {"name": "Scapular Pull-ups", "categories": ["Back", "Shoulders"], "type": "Mobility", "desc": "Shrug down and back on bar."},
  {"name": "Wall Slides", "categories": ["Shoulders", "Mobility"], "type": "Mobility", "desc": "Arms slide up wall in W shape."},
  {"name": "90/90 Hip Switches", "categories": ["Hips", "Mobility"], "type": "Mobility", "desc": "Rotate hips seated.", "isTimed": true, "duration": 60},
  {"name": "Cossack Squats", "categories": ["Legs", "Mobility"], "type": "Mobility", "desc": "Deep side lunge."},
  {"name": "Archer Push-ups", "categories": ["Chest", "Triceps"], "type": "Calisthenics", "desc": "One arm straight. One arm press."},
  {"name": "L-Sit Hold", "categories": ["Core", "Abs"], "type": "Calisthenics", "desc": "Legs straight out. Hold.", "isTimed": true, "duration": 20},
  {"name": "Hanging Knee Raises", "categories": ["Core", "Abs"], "type": "Calisthenics", "desc": "Knees to chest hanging."},
  {"name": "Negative Pull-ups", "categories": ["Back", "Biceps"], "type": "Calisthenics", "desc": "Jump up. Lower slowly."},
  {"name": "Bulgarian Split Squat (BW)", "categories": ["Legs"], "type": "Calisthenics", "desc": "Back foot up. Squat."},
  {"name": "Single Leg RDL", "categories": ["Hamstrings", "Balance"], "type": "Mobility", "desc": "Hinge on one leg. T shape."},
  {"name": "Incline Push-ups", "categories": ["Chest"], "type": "Calisthenics", "desc": "Hands on bench. Press."},
  {"name": "Decline Push-ups", "categories": ["Chest", "Shoulders"], "type": "Calisthenics", "desc": "Feet on bench. Press."},
  {"name": "Diamond Push-ups", "categories": ["Triceps", "Chest"], "type": "Muscle Build", "desc": "Hands close. Elbows tight."},
  {"name": "Close Grip DB Press", "categories": ["Triceps", "Chest"], "type": "Muscle Build", "desc": "DBs touching. Press."},
  {"name": "Dumbbell Pullover", "categories": ["Back", "Chest"], "type": "Muscle Build", "desc": "DB over head. Stretch lats."},
  {"name": "Concentration Curls", "categories": ["Biceps"], "type": "Muscle Build", "desc": "Elbow on thigh. Curl."},
  {"name": "Reverse DB Flys", "categories": ["Shoulders", "Back"], "type": "Muscle Build", "desc": "Bent over. Fly arms out."},
  {"name": "Standing Calf Raises", "categories": ["Legs", "Calves"], "type": "Muscle Build", "desc": "Heels down. Drive up."},
  {"name": "Tibialis Raise", "categories": ["Legs", "Mobility"], "type": "Mobility", "desc": "Lift toes to shins."},
  {"name": "Couch Stretch", "categories": ["Hips", "Mobility"], "type": "Mobility", "desc": "Shin on wall. Squeeze glute.", "isTimed": true, "duration": 60},
  {"name": "Pigeon Pose", "categories": ["Hips", "Mobility"], "type": "Mobility", "desc": "Leg across. Sink hips.", "isTimed": true, "duration": 60},
  {"name": "Child's Pose", "categories": ["Back", "Mobility"], "type": "Mobility", "desc": "Sit on heels. Reach forward.", "isTimed": true, "duration": 60},
  {"name": "Deep Squat Hold", "categories": ["Hips", "Mobility"], "type": "Mobility", "desc": "Sit in squat. Chest up.", "isTimed": true, "duration": 120},
  {"name": "Prone Y-W-T Raises", "categories": ["Back", "Shoulders"], "type": "Mobility", "desc": "Lye down. Arm shapes."},
  {"name": "Kettlebell Swing", "categories": ["Glutes", "Hamstrings", "Full Body"], "type": "Strength", "desc": "Hinge snap. Glute squeeze."},
  {"name": "Turkish Get-up", "categories": ["Full Body", "Shoulders", "Core"], "type": "Mobility", "desc": "Stand up with weight overhead.", "isTimed": true, "duration": 120},
  {"name": "Suitcase Carry", "categories": ["Core"], "type": "Strength", "desc": "Walk with one weight.", "isTimed": true, "duration": 60},
  {"name": "Pallof Press", "categories": ["Core"], "type": "Strength", "desc": "Anti-rotation press.", "isTimed": true, "duration": 30},
  {"name": "Face Away Cable Curl", "categories": ["Biceps"], "type": "Muscle Build", "desc": "Arms behind. Curl forward."},
  {"name": "Cable Pullover", "categories": ["Back", "Lats"], "type": "Muscle Build", "desc": "Arms straight. Push down."},
  {"name": "Air Squats", "categories": ["Legs"], "type": "Calisthenics", "desc": "Bodyweight squat."},
  {"name": "Jump Squats", "categories": ["Legs", "Cardio"], "type": "Calisthenics", "desc": "Squat jump. Soft land."},
  {"name": "Lunges (Forward)", "categories": ["Legs"], "type": "Calisthenics", "desc": "Step forward."},
  {"name": "Lunges (Reverse)", "categories": ["Legs"], "type": "Calisthenics", "desc": "Step back."},
  {"name": "Curtsy Lunges", "categories": ["Legs", "Glutes"], "type": "Calisthenics", "desc": "Step back and across."},
  {"name": "Lateral Lunges", "categories": ["Legs"], "type": "Calisthenics", "desc": "Step wide side."},
  {"name": "Step-Ups (Chair)", "categories": ["Legs"], "type": "Calisthenics", "desc": "Step up on box."},
  {"name": "Calf Raises", "categories": ["Calves", "Legs"], "type": "Calisthenics", "desc": "Raise heels."},
  {"name": "Single Leg Calf Raises", "categories": ["Calves"], "type": "Calisthenics", "desc": "One leg raise."},
  {"name": "Wall Sit", "categories": ["Legs"], "type": "Calisthenics", "desc": "Sit against wall. Hold.", "isTimed": true, "duration": 60},
  {"name": "Glute Bridges (Single Leg)", "categories": ["Glutes"], "type": "Calisthenics", "desc": "One leg bridge."},
  {"name": "Donkey Kicks", "categories": ["Glutes"], "type": "Calisthenics", "desc": "Kick heel to ceiling."},
  {"name": "Fire Hydrants", "categories": ["Glutes"], "type": "Calisthenics", "desc": "Lift knee to side."},
  {"name": "Nordic Hamstring Curl", "categories": ["Hamstrings"], "type": "Calisthenics", "desc": "Lower forward slowly."},
  {"name": "Push-ups (Wide)", "categories": ["Chest"], "type": "Calisthenics", "desc": "Hands wide."},
  {"name": "Push-ups (Diamond)", "categories": ["Triceps"], "type": "Calisthenics", "desc": "Hands touch."},
  {"name": "Push-ups (Decline)", "categories": ["Chest", "Shoulders"], "type": "Calisthenics", "desc": "Feet elevated."},
  {"name": "Push-ups (Incline)", "categories": ["Chest"], "type": "Calisthenics", "desc": "Hands elevated."},
  {"name": "Pike Push-ups", "categories": ["Shoulders"], "type": "Calisthenics", "desc": "Hips high V shape."},
  {"name": "Handstand Hold", "categories": ["Shoulders", "Core"], "type": "Calisthenics", "desc": "Hold against wall.", "isTimed": true, "duration": 45},
  {"name": "Tricep Dips", "categories": ["Triceps"], "type": "Calisthenics", "desc": "Dip on chair."},
  {"name": "Plank (Forearm)", "categories": ["Core"], "type": "Calisthenics", "desc": "Low plank.", "isTimed": true, "duration": 60},
  {"name": "Plank (High)", "categories": ["Core"], "type": "Calisthenics", "desc": "Pushup hold.", "isTimed": true, "duration": 60},
  {"name": "Side Plank (Left)", "categories": ["Core", "Obliques"], "type": "Calisthenics", "desc": "Left side.", "isTimed": true, "duration": 45},
  {"name": "Side Plank (Right)", "categories": ["Core", "Obliques"], "type": "Calisthenics", "desc": "Right side.", "isTimed": true, "duration": 45},
  {"name": "Plank Jacks", "categories": ["Core", "Cardio"], "type": "Calisthenics", "desc": "Jump feet in plank."},
  {"name": "Mountain Climbers (Twisting)", "categories": ["Core"], "type": "Calisthenics", "desc": "Knee to opposite elbow.", "isTimed": true, "duration": 45},
  {"name": "Bicycle Crunches", "categories": ["Core", "Abs"], "type": "Calisthenics", "desc": "Elbow to knee cycling."},
  {"name": "Leg Raises (Lying)", "categories": ["Core", "Abs"], "type": "Calisthenics", "desc": "Lye back. Lift legs."},
  {"name": "Flutter Kicks", "categories": ["Core", "Abs"], "type": "Calisthenics", "desc": "Small kicks low.", "isTimed": true, "duration": 45},
  {"name": "Russian Twists", "categories": ["Core", "Obliques"], "type": "Calisthenics", "desc": "Twist torso seated."},
  {"name": "V-Ups", "categories": ["Core", "Abs"], "type": "Calisthenics", "desc": "Touch toes V shape."},
  {"name": "Superman Hold", "categories": ["Lower Back"], "type": "Calisthenics", "desc": "Hold superman.", "isTimed": true, "duration": 45},
  {"name": "Pull-ups (Wide)", "categories": ["Back", "Lats"], "type": "Calisthenics", "desc": "Wide grip pullup."},
  {"name": "Chin-ups", "categories": ["Back", "Biceps"], "type": "Calisthenics", "desc": "Underhand pullup."},
  {"name": "Inverted Row (Under table)", "categories": ["Back"], "type": "Calisthenics", "desc": "Row under table."},
  {"name": "Doorframe Row", "categories": ["Back"], "type": "Calisthenics", "desc": "Pull on doorframe."},
  {"name": "Scapular Push-ups", "categories": ["Back", "Shoulders"], "type": "Calisthenics", "desc": "Squeeze blades in plank."},
  {"name": "Burpees (No Push-up)", "categories": ["Cardio", "Full Body"], "type": "Calisthenics", "desc": "Burpee speed."},
  {"name": "Jumping Jacks", "categories": ["Cardio"], "type": "Calisthenics", "desc": "Jacks.", "isTimed": true, "duration": 60},
  {"name": "High Knees", "categories": ["Cardio", "Legs"], "type": "Calisthenics", "desc": "Run place knees high.", "isTimed": true, "duration": 45},
  {"name": "Bear Crawl (Reverse)", "categories": ["Full Body"], "type": "Calisthenics", "desc": "Crawl back.", "isTimed": true, "duration": 45},
  {"name": "Crab Walk", "categories": ["Full Body"], "type": "Calisthenics", "desc": "Walk belly up.", "isTimed": true, "duration": 45},
  {"name": "Inchworms", "categories": ["Mobility", "Hamstrings"], "type": "Calisthenics", "desc": "Walk out to plank."},
  {"name": "Cossack Squats", "categories": ["Mobility", "Legs"], "type": "Calisthenics", "desc": "Side lunge deep."},
  {"name": "Hindu Push-ups", "categories": ["Shoulders", "Chest"], "type": "Calisthenics", "desc": "Swoop pushup."},
  {"name": "Box Jumps (Step down)", "categories": ["Legs"], "type": "Calisthenics", "desc": "Jump up step down."},
  {"name": "Broad Jumps", "categories": ["Legs"], "type": "Calisthenics", "desc": "Jump forward."},
  {"name": "Skater Hops", "categories": ["Legs", "Cardio"], "type": "Calisthenics", "desc": "Jump side to side."},
  {"name": "Hollow Body Rock", "categories": ["Core"], "type": "Calisthenics", "desc": "Rock in hollow."}
];
    
    // --- INTERNAL DB (EXTENDED V19) ---
    const baseFoods = [
        {name: "Chicken Breast (Cooked)", cal: 165, pro: 31}, {name: "Chicken Thigh (Cooked)", cal: 209, pro: 26}, {name: "Ground Beef (90/10)", cal: 217, pro: 26}, {name: "Steak (Sirloin)", cal: 250, pro: 26}, {name: "Salmon (Cooked)", cal: 208, pro: 20}, {name: "Tuna (Canned)", cal: 116, pro: 26}, {name: "Egg (Large)", cal: 72, pro: 6, unit: "unit"}, {name: "Egg Whites (100g)", cal: 52, pro: 11}, {name: "Whey Scoop (30g)", cal: 120, pro: 24, unit: "unit"}, {name: "Greek Yogurt (Non-fat)", cal: 59, pro: 10}, {name: "Cottage Cheese", cal: 81, pro: 11}, {name: "Tofu (Firm)", cal: 144, pro: 17}, {name: "Rice (White Cooked)", cal: 130, pro: 2.7}, {name: "Rice (Brown Cooked)", cal: 111, pro: 2.6}, {name: "Pasta (Cooked)", cal: 131, pro: 5}, {name: "Potato (Boiled)", cal: 87, pro: 1.9}, {name: "Sweet Potato", cal: 90, pro: 2}, {name: "Oats (Raw)", cal: 389, pro: 16.9}, {name: "Bread (Slice)", cal: 80, pro: 3, unit: "unit"}, {name: "Banana", cal: 105, pro: 1.3, unit: "unit"}, {name: "Apple", cal: 95, pro: 0.5, unit: "unit"}, {name: "Almonds", cal: 579, pro: 21}, {name: "Peanut Butter", cal: 588, pro: 25}, {name: "Avocado", cal: 160, pro: 2}, {name: "Olive Oil (tbsp)", cal: 119, pro: 0, unit: "unit"}, {name: "Broccoli", cal: 34, pro: 2.8}, {name: "Spinach", cal: 23, pro: 2.9}, {name: "Carrots", cal: 41, pro: 0.9}, {name: "Milk (Whole)", cal: 61, pro: 3.2}, {name: "Almond Milk", cal: 15, pro: 0.5}, {name: "Protein Bar", cal: 200, pro: 20, unit: "unit"}, {name: "Pizza (Slice)", cal: 285, pro: 12, unit: "unit"}, {name: "Burger (Patty)", cal: 250, pro: 20, unit: "unit"}, {name: "Beer", cal: 150, pro: 1, unit: "unit"},
        // EXPANSION
        {name: "Turkey Breast", cal: 135, pro: 30}, {name: "Pork Chop", cal: 231, pro: 24}, {name: "Shrimp", cal: 99, pro: 24}, {name: "Cod", cal: 82, pro: 18}, {name: "Tilapia", cal: 96, pro: 20}, {name: "Bacon (Slice)", cal: 43, pro: 3, unit: "unit"}, {name: "Sausage (Link)", cal: 230, pro: 12, unit: "unit"}, {name: "Lentils (Cooked)", cal: 116, pro: 9}, {name: "Chickpeas", cal: 164, pro: 8.9}, {name: "Black Beans", cal: 132, pro: 8.9}, {name: "Edamame", cal: 121, pro: 11.9}, {name: "Quinoa (Cooked)", cal: 120, pro: 4.4}, {name: "Couscous", cal: 112, pro: 3.8}, {name: "Bagel", cal: 245, pro: 10, unit: "unit"}, {name: "Tortilla (Flour)", cal: 140, pro: 4, unit: "unit"}, {name: "Granola", cal: 471, pro: 10}, {name: "Cheerios (Cup)", cal: 100, pro: 3, unit: "unit"}, {name: "Blueberries", cal: 57, pro: 0.7}, {name: "Strawberries", cal: 32, pro: 0.7}, {name: "Orange", cal: 62, pro: 1.2, unit: "unit"}, {name: "Grapes", cal: 69, pro: 0.7}, {name: "Watermelon", cal: 30, pro: 0.6}, {name: "Pineapple", cal: 50, pro: 0.5}, {name: "Mango", cal: 60, pro: 0.8}, {name: "Cashews", cal: 553, pro: 18}, {name: "Walnuts", cal: 654, pro: 15}, {name: "Pistachios", cal: 562, pro: 20}, {name: "Chia Seeds", cal: 486, pro: 17}, {name: "Flax Seeds", cal: 534, pro: 18}, {name: "Butter (tbsp)", cal: 102, pro: 0.1, unit: "unit"}, {name: "Coconut Oil (tbsp)", cal: 117, pro: 0, unit: "unit"}, {name: "Mayonnaise (tbsp)", cal: 94, pro: 0.1, unit: "unit"}, {name: "Ketchup (tbsp)", cal: 19, pro: 0.2, unit: "unit"}, {name: "BBQ Sauce (tbsp)", cal: 29, pro: 0.1, unit: "unit"}, {name: "Honey (tbsp)", cal: 64, pro: 0.1, unit: "unit"}, {name: "Maple Syrup (tbsp)", cal: 52, pro: 0, unit: "unit"}, {name: "Asparagus", cal: 20, pro: 2.2}, {name: "Green Beans", cal: 31, pro: 1.8}, {name: "Zucchini", cal: 17, pro: 1.2}, {name: "Cucumber", cal: 15, pro: 0.7}, {name: "Tomato", cal: 18, pro: 0.9}, {name: "Onion", cal: 40, pro: 1.1}, {name: "Mushrooms", cal: 22, pro: 3.1}, {name: "Bell Pepper", cal: 20, pro: 0.9}, {name: "Kale", cal: 49, pro: 4.3}, {name: "Lettuce", cal: 15, pro: 1.4}, {name: "Cheddar Cheese", cal: 402, pro: 25}, {name: "Mozzarella", cal: 280, pro: 28}, {name: "Parmesan", cal: 431, pro: 38}, {name: "Cream Cheese (tbsp)", cal: 51, pro: 1, unit: "unit"}, {name: "Sour Cream (tbsp)", cal: 23, pro: 0.3, unit: "unit"}, {name: "Ice Cream (Scoop)", cal: 137, pro: 2.3, unit: "unit"}, {name: "Chocolate (Bar)", cal: 546, pro: 4.9}, {name: "Chips (Small Bag)", cal: 160, pro: 2, unit: "unit"}, {name: "Cookie", cal: 50, pro: 0.6, unit: "unit"}, {name: "Donut", cal: 250, pro: 3, unit: "unit"}, {name: "Fries (Medium)", cal: 365, pro: 4, unit: "unit"}, {name: "Soda (Can)", cal: 140, pro: 0, unit: "unit"}, {name: "Wine (Glass)", cal: 123, pro: 0.1, unit: "unit"}, {name: "Whiskey (Shot)", cal: 105, pro: 0, unit: "unit"}
    ];

    // --- STATE ---
    let myChart = null, nutChart = null, audioCtx = null, currentScore = 0;
    let currentUnit = localStorage.getItem('nimbleUnit') || 'lbs';
    let activeRoutine = [];
    let gifOverrides = JSON.parse(localStorage.getItem('nimbleGifOverrides')) || {};
    let customSelection = [];
    let customFoods = JSON.parse(localStorage.getItem('nimbleCustomFoods')) || [];
    let todaysFood = [];

    window.onload = function() {
        checkDailyScore();
        renderNutritionChart();
        updateUnitDisplay();
        populateFoodList();
        updateSavedRoutinesDropdown();
        populateBuilderFilters();
    };

    function sendToCloud(type, data) {
        if (!GOOGLE_SCRIPT_URL) return;
        fetch(GOOGLE_SCRIPT_URL, {
            method: "POST", mode: "no-cors", 
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ type: type, data: data })
        }).then(() => {
            document.getElementById('cloud-status').classList.add('online');
            setTimeout(() => document.getElementById('cloud-status').classList.remove('online'), 2000);
        });
    }

    // --- FOOD DB ---
    function getAllFoods() { return [...baseFoods, ...customFoods].sort((a,b)=>a.name.localeCompare(b.name)); }

    function populateFoodList() {
        const datalist = document.getElementById('food-list');
        datalist.innerHTML = "";
        getAllFoods().forEach(f => {
            let opt = document.createElement('option');
            opt.value = f.name;
            datalist.appendChild(opt);
        });
    }

    function toggleCustomFood() {
        const form = document.getElementById('custom-food-form');
        form.style.display = form.style.display === "block" ? "none" : "block";
    }

    function saveNewFood() {
        const name = document.getElementById('new-food-name').value;
        const cal = parseFloat(document.getElementById('new-food-cal').value);
        const pro = parseFloat(document.getElementById('new-food-pro').value);
        
        if(!name || isNaN(cal) || isNaN(pro)) return alert("Please fill all fields");
        
        customFoods.push({name: name, cal: cal, pro: pro}); // Assumes 100g base for custom unless specified (keeping simple)
        localStorage.setItem('nimbleCustomFoods', JSON.stringify(customFoods));
        populateFoodList();
        
        alert("Food Saved!");
        document.getElementById('new-food-name').value = "";
        document.getElementById('new-food-cal').value = "";
        document.getElementById('new-food-pro').value = "";
        toggleCustomFood();
    }

    function calcFood() { 
        const n = document.getElementById('food-search').value; const q = parseFloat(document.getElementById('food-qty').value)||0;
        const f = getAllFoods().find(x=>x.name===n); if(!f || q<=0) return;
        let fac = f.unit==="unit"?q:(q/100);
        const c = Math.round(f.cal*fac); const p = Math.round(f.pro*fac);
        
        // Add to temporary visual list
        todaysFood.push({name: n, qty: q, cals: c, pro: p});
        renderTodaysFood();

        // Update inputs
        document.getElementById('inp-cals').value = (parseFloat(document.getElementById('inp-cals').value)||0)+c;
        document.getElementById('inp-prot').value = (parseFloat(document.getElementById('inp-prot').value)||0)+p;
        document.getElementById('food-search').value = "";
        document.getElementById('food-qty').value = "";
    }

    function renderTodaysFood() {
        const list = document.getElementById('todays-food-list');
        list.innerHTML = "";
        todaysFood.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'food-item-row';
            div.innerHTML = `<span>${item.name} (${item.qty})</span> <span>${item.cals}kcal / ${item.pro}g <span class="remove-food" onclick="removeFood(${index})">x</span></span>`;
            list.appendChild(div);
        });
    }

    function removeFood(index) {
        const item = todaysFood[index];
        // Subtract
        const currCals = parseFloat(document.getElementById('inp-cals').value)||0;
        const currPro = parseFloat(document.getElementById('inp-prot').value)||0;
        document.getElementById('inp-cals').value = Math.max(0, currCals - item.cals);
        document.getElementById('inp-prot').value = Math.max(0, currPro - item.pro);
        
        todaysFood.splice(index, 1);
        renderTodaysFood();
    }

    // --- CUSTOM GIFS ---
    function saveGifOverride(name, inputId) {
        const url = document.getElementById(inputId).value;
        if(!url) return alert("Please paste a URL");
        gifOverrides[name] = url;
        localStorage.setItem('nimbleGifOverrides', JSON.stringify(gifOverrides));
        renderWorkout(activeRoutine);
        alert("GIF Saved!");
    }

    function showGif(name) {
        const url = gifOverrides[name];
        if(url) {
            document.getElementById('gif-player').src = url;
            document.getElementById('gif-modal-title').innerText = name;
            document.getElementById('gif-modal').style.display = 'flex';
        }
    }

    // --- SAVE/LOAD ROUTINES ---
    function saveCurrentRoutine() {
        const name = prompt("Name this routine (e.g. Chest Day):");
        if(!name) return;
        let saved = JSON.parse(localStorage.getItem('nimbleRoutines')) || {};
        if(activeRoutine.length === 0) return alert("No active workout to save.");
        saved[name] = activeRoutine;
        localStorage.setItem('nimbleRoutines', JSON.stringify(saved));
        updateSavedRoutinesDropdown();
        alert("Routine Saved!");
    }

    function loadRoutine(name) {
        if(!name) return;
        const saved = JSON.parse(localStorage.getItem('nimbleRoutines'));
        if(saved && saved[name]) {
            activeRoutine = saved[name];
            renderWorkout(activeRoutine);
            document.getElementById('setup-panel').classList.add('hidden');
            document.getElementById('active-workout').classList.remove('hidden');
        }
    }

    function updateSavedRoutinesDropdown() {
        const select = document.getElementById('saved-routines');
        select.innerHTML = '<option value="">-- Load Saved --</option>';
        const saved = JSON.parse(localStorage.getItem('nimbleRoutines')) || {};
        for(let key in saved) {
            let opt = document.createElement('option');
            opt.value = key;
            opt.innerText = key;
            select.appendChild(opt);
        }
    }

    // --- BUILDER LOGIC ---
    function openBuilder(isAddMode = false) {
        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('active-workout').classList.add('hidden');
        document.getElementById('builder-panel').classList.remove('hidden');
        if(!isAddMode) { customSelection = []; updateBuilderCount(); }
        document.getElementById('builder-panel').dataset.mode = isAddMode ? "add" : "new";
        document.querySelector('#builder-panel .btn-generate').innerText = isAddMode ? "ADD TO WORKOUT" : "START CUSTOM";
        filterBuilderList();
    }

    function closeBuilder() {
        document.getElementById('builder-panel').classList.add('hidden');
        if(document.getElementById('builder-panel').dataset.mode === "add") {
            document.getElementById('active-workout').classList.remove('hidden');
        } else {
            document.getElementById('setup-panel').classList.remove('hidden');
        }
    }

    function populateBuilderFilters() {
        const catSelect = document.getElementById('builder-cat-filter');
        let categories = new Set();
        allExercises.forEach(e => {
            if(e.categories) e.categories.forEach(c => categories.add(c));
        });
        [...categories].sort().forEach(c => {
            let opt = document.createElement('option');
            opt.value = c; opt.innerText = c;
            catSelect.appendChild(opt);
        });
    }

    function filterBuilderList() {
        const search = document.getElementById('builder-search').value.toLowerCase();
        const cat = document.getElementById('builder-cat-filter').value;
        const type = document.getElementById('builder-type-filter').value;
        
        const filtered = allExercises.filter(e => {
            const matchesSearch = e.name.toLowerCase().includes(search);
            const matchesCat = cat === 'all' || (e.categories && e.categories.includes(cat));
            const matchesType = type === 'all' || e.type === type;
            return matchesSearch && matchesCat && matchesType;
        });
        
        const list = document.getElementById('builder-list');
        list.innerHTML = '';
        
        filtered.forEach(e => {
            const div = document.createElement('div');
            div.className = 'builder-item';
            div.innerHTML = `<span>${e.name} <small style="color:#666">(${e.categories ? e.categories[0] : ''})</small></span><button class="builder-add-btn" onclick="addToCustom('${e.name}')">+</button>`;
            list.appendChild(div);
        });
    }

    function addToCustom(name) {
        const ex = allExercises.find(e => e.name === name);
        if(ex) {
            customSelection.push(ex);
            updateBuilderCount();
        }
    }

    function updateBuilderCount() { document.getElementById('builder-count').innerText = customSelection.length; }

    function startCustomWorkout() {
        if(customSelection.length === 0) return alert("Select at least one exercise.");
        const mode = document.getElementById('builder-panel').dataset.mode;
        if(mode === "add") { activeRoutine = [...activeRoutine, ...customSelection]; } 
        else { activeRoutine = [...customSelection]; }
        renderWorkout(activeRoutine);
        closeBuilder();
        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('active-workout').classList.remove('hidden');
    }

    // --- GENERATOR ---
    function generateWorkout() {
        const sCount = parseInt(document.getElementById('slider-strength').value);
        const mCount = parseInt(document.getElementById('slider-shred').value);
        const mobCount = parseInt(document.getElementById('slider-mobility').value);
        const split = document.getElementById('split-selector').value;

        // NEW MULTI-CATEGORY FILTERING LOGIC
        let pool = allExercises;
        if(split === 'push') pool = allExercises.filter(e => e.categories.some(c => ['Chest','Shoulders','Triceps'].includes(c)));
        if(split === 'pull') pool = allExercises.filter(e => e.categories.some(c => ['Back','Biceps','Traps','Lats'].includes(c)));
        if(split === 'legs') pool = allExercises.filter(e => e.categories.some(c => ['Legs','Hamstrings','Glutes','Hips','Calves'].includes(c)));
        if(split === 'core') pool = allExercises.filter(e => e.categories.some(c => ['Core','Abs','Lower Back','Obliques'].includes(c)));
        if(split === 'bodyweight') pool = allExercises.filter(e => e.type === "Calisthenics" || e.categories.includes("Mobility"));

        const strengthList = pool.filter(e => e.type === "Strength" || (split === 'bodyweight' && e.type === "Calisthenics"));
        const shredList = pool.filter(e => e.type === "Muscle Build" || e.type === "Calisthenics");
        const mobilityList = pool.filter(e => e.type === "Mobility");
        
        activeRoutine = [
            ...getRandom(strengthList, sCount),
            ...getRandom(shredList, mCount),
            ...getRandom(mobilityList, mobCount)
        ];
        
        renderWorkout(activeRoutine);
        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('active-workout').classList.remove('hidden');
    }

    function renderWorkout(exercises) {
        const container = document.getElementById('workout-list');
        container.innerHTML = '';
        const history = JSON.parse(localStorage.getItem('nimbleHistory')) || [];
        
        if(exercises.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:30px; color:#666;">No exercises found.</div>';
            return;
        }

        exercises.forEach((ex, idx) => {
            const div = document.createElement('div');
            let typeClass = ex.type === 'Mobility' ? 'mobility' : (ex.type === 'Strength' ? 'strength' : '');
            const isTimed = ex.isTimed || false;
            const target = isTimed ? (ex.duration || 60) : 0;
            const label = isTimed ? "Secs" : "Reps";
            const placeholder = isTimed ? target : "0";
            
            let actionButton = isTimed ? 
                `<div class="input-group"><label>Do It</label><button class="btn btn-work" onclick="startTimer(${target}, true)">‚ñ∂Ô∏è GO</button></div>` :
                `<div class="input-group"><label>Rest</label><button class="btn btn-timer" onclick="startTimer(${ex.type === 'Strength' ? 180 : (ex.type === 'Mobility' ? 45 : 90)}, false)">‚è±Ô∏è</button></div>`;

            // PR Check
            const pastLogs = history.filter(h => h.name === ex.name).sort((a,b) => b.weight - a.weight);
            let ghostText = "";
            if(pastLogs.length > 0) { 
                const pr = pastLogs[0].weight;
                ghostText = `üëª PR: ${pr} ${pastLogs[0].unit || 'lbs'}`;
            }

            // GIF Logic
            const hasGif = gifOverrides[ex.name];
            const searchUrl = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(ex.name + ' exercise form gif')}`;
            const uniqueId = `desc-${idx}`;
            
            let demoBtn = `<a href="${searchUrl}" target="_blank" class="btn-action">üé• Find GIF</a>`;
            if(hasGif) {
                demoBtn = `<span class="btn-action has-gif" onclick="showGif('${ex.name}')">üé• Watch</span>`;
            }

            div.className = `exercise-card ${typeClass}`;
            div.dataset.name = ex.name;
            div.innerHTML = `
                <div class="exercise-header">
                    <div><span class="exercise-title">${ex.name}</span><small>${ex.categories.join(', ')}</small></div>
                    <div class="action-row">
                        <button class="btn-icon-only" onclick="openPlateModal()">üßÆ</button>
                        <span class="btn-action" onclick="toggleDesc('${uniqueId}')">üìù Guide</span>
                        ${demoBtn}
                    </div>
                </div>
                <div class="exercise-meta">${ex.type}</div>
                
                <div id="${uniqueId}" class="instruction-box">
                    ${ex.desc}
                    <div class="gif-input-container">
                        <label style="font-size:0.8em; color:#aaa;">Custom GIF URL:</label>
                        <input type="text" id="gif-input-${idx}" class="gif-input" placeholder="Paste image link here..." value="${hasGif || ''}">
                        <button class="btn-save-gif" onclick="saveGifOverride('${ex.name}', 'gif-input-${idx}')">Save GIF</button>
                    </div>
                </div>

                ${ghostText ? `<div class="ghost-stats">${ghostText}</div>` : ''}
                <div class="log-inputs">
                    <div class="input-group"><label>Weight</label><input type="number" class="input-weight" placeholder="${currentUnit}"></div>
                    <div class="input-group"><label>${label}</label><input type="number" class="input-reps" placeholder="${placeholder}" value="${isTimed ? target : ''}"></div>
                    ${actionButton}
                </div>
            `;
            container.appendChild(div);
        });
    }

    // --- TOOLS ---
    function calc1RM() {
        const w = parseFloat(document.getElementById('rm-weight').value);
        const r = parseFloat(document.getElementById('rm-reps').value);
        if(!w || !r) return;
        const rm = Math.round(w * (1 + r/30));
        document.getElementById('rm-result').innerText = `Est. 1RM: ${rm} ${currentUnit}`;
    }

    function openPlateModal() { document.getElementById('plate-modal').style.display = 'flex'; }
    function closePlateModal() { document.getElementById('plate-modal').style.display = 'none'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    function calcPlates() {
        const weight = parseFloat(document.getElementById('plate-weight-input').value);
        if(!weight) return;
        const bar = currentUnit === 'lbs' ? 45 : 20;
        let remaining = (weight - bar) / 2;
        if(remaining < 0) return;
        const platesLbs = [45, 35, 25, 10, 5, 2.5];
        const platesKg = [20, 15, 10, 5, 2.5, 1.25];
        const plates = currentUnit === 'lbs' ? platesLbs : platesKg;
        let html = "<div class='bar'></div>";
        let result = [];
        plates.forEach(p => {
            while(remaining >= p) {
                result.push(p); remaining -= p;
                let h = p >= 45 || p >= 20 ? 50 : (p >= 25 || p >= 10 ? 40 : 30);
                let color = p >= 45 || p >= 20 ? '#2196F3' : (p >= 25 || p >= 10 ? '#4CAF50' : '#fff');
                let txtColor = p < 25 && currentUnit === 'lbs' ? '#000' : '#fff'; 
                if(currentUnit === 'kg' && p < 10) txtColor = '#000';
                html += `<div class="plate" style="height:${h}px; background:${color}; color:${txtColor}">${p}</div>`;
            }
        });
        document.getElementById('plate-visuals').innerHTML = html;
        document.getElementById('plate-text').innerText = `Per Side: ${result.join(', ')}`;
    }

    // --- CONFETTI ---
    function fireConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const pieces = [];
        for(let i=0; i<100; i++) {
            pieces.push({x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height, color: `hsl(${Math.random()*360}, 100%, 50%)`, size: Math.random()*10+5, speed: Math.random()*5+2});
        }
        function draw() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            let active = false;
            pieces.forEach(p => { p.y += p.speed; if(p.y < canvas.height) active = true; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size); });
            if(active) requestAnimationFrame(draw); else ctx.clearRect(0,0,canvas.width,canvas.height);
        }
        draw();
    }

    function checkPR(name, weight) {
        const history = JSON.parse(localStorage.getItem('nimbleHistory')) || [];
        const max = Math.max(...history.filter(h => h.name === name).map(h => h.weight), 0);
        if(weight > max) { fireConfetti(); alert(`üéâ NEW PR! ${weight} ${currentUnit} on ${name}!`); }
    }

    // --- CORE FUNC MAPPINGS ---
    function toggleUnit() { currentUnit = currentUnit === 'lbs' ? 'kg' : 'lbs'; localStorage.setItem('nimbleUnit', currentUnit); updateUnitDisplay(); }
    function updateUnitDisplay() { document.getElementById('unit-disp-1').innerText = currentUnit.toUpperCase(); document.getElementById('unit-disp-2').innerText = currentUnit.toUpperCase(); }
    function switchTab(t) { document.querySelectorAll('.container').forEach(d=>d.classList.add('hidden')); document.getElementById('view-'+t).classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.getElementById('nav-'+t).classList.add('active'); if(t==='progress'){populateHistoryDropdown();renderCalendar();} if(t==='food'){renderNutritionChart();} }
    function updateReadinessUI() { document.getElementById('val-sleep').innerText = document.getElementById('slider-sleep').value; document.getElementById('val-sore').innerText = document.getElementById('slider-sore').value; document.getElementById('val-mood').innerText = document.getElementById('slider-mood').value; }
    function calcReadiness() { 
        const g = document.getElementById('inp-garmin').value; 
        let score = 0;
        if(g) score = parseInt(g); 
        else score = Math.round(((parseInt(document.getElementById('slider-sleep').value)*10) + (parseInt(document.getElementById('slider-mood').value)*10) + ((10-parseInt(document.getElementById('slider-sore').value))*10))/3);
        currentScore = score; saveDailyScore(score); showScoreDisplay(score);
    }
    function saveDailyScore(s) { const d = new Date().toDateString(); localStorage.setItem('nimbleReadiness', JSON.stringify({date:d, score:s})); sendToCloud("readiness", {date:d, score:s}); }
    function checkDailyScore() { const s = JSON.parse(localStorage.getItem('nimbleReadiness')); if(s && s.date === new Date().toDateString()) showScoreDisplay(s.score); }
    function showScoreDisplay(s) { 
        const c = document.getElementById('score-val'); document.getElementById('readiness-form').classList.add('hidden'); document.getElementById('readiness-display').classList.remove('hidden'); c.innerText = s+'%';
        if(s>=80) {c.style.borderColor="var(--success)"; c.style.color="var(--success)"; document.getElementById('score-text').innerText="Go Hard!";}
        else if(s>=50) {c.style.borderColor="var(--warning)"; c.style.color="var(--warning)"; document.getElementById('score-text').innerText="Maintain.";}
        else {c.style.borderColor="var(--danger)"; c.style.color="var(--danger)"; document.getElementById('score-text').innerText="Recovery.";}
    }
    function resetDaily() { document.getElementById('readiness-display').classList.add('hidden'); document.getElementById('readiness-form').classList.remove('hidden'); }
    function updateSliders() { document.getElementById('val-strength').innerText = document.getElementById('slider-strength').value; document.getElementById('val-shred').innerText = document.getElementById('slider-shred').value; document.getElementById('val-mobility').innerText = document.getElementById('slider-mobility').value; }
    function getRandom(a,n) { if(!a)return[]; return [...a].sort(()=>0.5-Math.random()).slice(0,n); }
    function toggleDesc(id) { const e = document.getElementById(id); e.style.display = e.style.display==="block"?"none":"block"; }
    function cancelWorkout() { if(confirm("Discard?")) { document.getElementById('active-workout').classList.add('hidden'); document.getElementById('setup-panel').classList.remove('hidden'); } }
    function finishSession() {
        if(!confirm("Finish?")) return;
        const cards = document.querySelectorAll('.exercise-card');
        const ts = new Date().toISOString(); const d = new Date().toLocaleDateString();
        let newLog = [];
        cards.forEach(c => {
            const name = c.dataset.name; const w = parseFloat(c.querySelector('.input-weight').value); const r = parseFloat(c.querySelector('.input-reps').value);
            if(r>0) {
                const entry = {date:d, timestamp:ts, name:name, weight:w||0, reps:r, unit:currentUnit};
                newLog.push(entry);
                if(w) checkPR(name, w); 
                sendToCloud("workout", entry);
            }
        });
        let h = JSON.parse(localStorage.getItem('nimbleHistory'))||[]; h = h.concat(newLog); localStorage.setItem('nimbleHistory', JSON.stringify(h));
        alert("Saved!"); document.getElementById('active-workout').classList.add('hidden'); document.getElementById('setup-panel').classList.remove('hidden');
    }
    function populateFoodList() { const dl = document.getElementById('food-list'); foodDatabase.forEach(f=>{let o=document.createElement('option'); o.value=f.name; dl.appendChild(o);}); }
    function calcFood() { 
        const n = document.getElementById('food-search').value; const q = parseFloat(document.getElementById('food-qty').value)||0;
        const f = getAllFoods().find(x=>x.name===n); if(!f || q<=0) return;
        let fac = f.unit==="unit"?q:(q/100);
        const c = Math.round(f.cal*fac); const p = Math.round(f.pro*fac);
        
        todaysFood.push({name: n, qty: q, cals: c, pro: p});
        renderTodaysFood();

        document.getElementById('inp-cals').value = (parseFloat(document.getElementById('inp-cals').value)||0)+c;
        document.getElementById('inp-prot').value = (parseFloat(document.getElementById('inp-prot').value)||0)+p;
        document.getElementById('food-search').value = "";
        document.getElementById('food-qty').value = "";
    }
    function logNutrition() {
        const c = document.getElementById('inp-cals').value; const p = document.getElementById('inp-prot').value; if(!c) return;
        const e = {date:new Date().toLocaleDateString(), timestamp:new Date().toISOString(), cals:parseFloat(c), prot:parseFloat(p)};
        let n = JSON.parse(localStorage.getItem('nimbleNutrition'))||[]; n.push(e); localStorage.setItem('nimbleNutrition', JSON.stringify(n));
        sendToCloud("nutrition", e); document.getElementById('inp-cals').value=""; document.getElementById('inp-prot').value=""; 
        todaysFood = []; renderTodaysFood();
        renderNutritionChart();
    }
    function renderNutritionChart() {
        const ctx = document.getElementById('nutritionChart').getContext('2d'); const h = JSON.parse(localStorage.getItem('nimbleNutrition'))||[];
        const t = new Date().toLocaleDateString(); let tc=0, tp=0, g={};
        h.forEach(x=>{ if(!g[x.date])g[x.date]={c:0,p:0}; g[x.date].c+=x.cals; g[x.date].p+=x.prot; if(x.date===t){tc+=x.cals; tp+=x.prot;} });
        document.getElementById('total-cals').innerText = tc; document.getElementById('total-prot').innerText = tp;
        const l = Object.keys(g).slice(-7);
        if(nutChart) nutChart.destroy();
        nutChart = new Chart(ctx, { type:'bar', data:{labels:l, datasets:[{label:'Cals', data:l.map(d=>g[d].c), backgroundColor:'#03DAC6', yAxisID:'y'},{label:'Prot', data:l.map(d=>g[d].p), backgroundColor:'#BB86FC', yAxisID:'y1'}]}, options:{responsive:true, scales:{y:{type:'linear',position:'left'}, y1:{type:'linear',position:'right',grid:{drawOnChartArea:false}}}}} );
    }
    function populateHistoryDropdown() { const h = JSON.parse(localStorage.getItem('nimbleHistory'))||[]; const s = document.getElementById('exercise-select'); const n = [...new Set(h.map(i=>i.name))].sort(); s.innerHTML='<option>-- Choose --</option>'; n.forEach(x=>{let o=document.createElement('option'); o.value=x; o.innerText=x; s.appendChild(o);}); }
    function renderChart() {
        const n = document.getElementById('exercise-select').value; if(!n)return;
        const h = JSON.parse(localStorage.getItem('nimbleHistory'))||[];
        const d = h.filter(i=>i.name===n).sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
        const ctx = document.getElementById('progressChart').getContext('2d'); if(myChart) myChart.destroy();
        const isWeight = d.some(x=>x.weight > 5);
        const data = d.map(x => isWeight ? x.weight : x.reps);
        const label = isWeight ? `Weight (${currentUnit})` : `Reps/Time`;
        myChart = new Chart(ctx, {type:'line', data:{labels:d.map(x=>x.date), datasets:[{label:label, data:data, borderColor:'#BB86FC'}]}});
    }
    function renderCalendar() {
        const c = document.getElementById('calendar-heatmap'); c.innerHTML=''; const h = JSON.parse(localStorage.getItem('nimbleHistory'))||[];
        const ad = new Set(h.map(x=>new Date(x.timestamp).toDateString()));
        for(let i=27; i>=0; i--) { const d=new Date(); d.setDate(new Date().getDate()-i); const div=document.createElement('div'); div.className='cal-day'; div.innerText=d.getDate(); if(ad.has(d.toDateString())) div.classList.add('active'); c.appendChild(div); }
    }
    function exportData() {
        const d = { 
            workout: JSON.parse(localStorage.getItem('nimbleHistory')), 
            nut: JSON.parse(localStorage.getItem('nimbleNutrition')), 
            readiness: JSON.parse(localStorage.getItem('nimbleReadiness')),
            routines: JSON.parse(localStorage.getItem('nimbleRoutines')),
            gifs: JSON.parse(localStorage.getItem('nimbleGifOverrides')),
            customFoods: JSON.parse(localStorage.getItem('nimbleCustomFoods'))
        };
        const b = new Blob([JSON.stringify(d)], {type:"application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download="nimble_backup.json"; a.click();
    }
    
    // Timer
    let tInt;
    function startTimer(s, w) {
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        document.getElementById('timer-overlay').style.height='100%';
        document.getElementById('timer-display').style.color = w ? "var(--work-mode)" : "var(--primary)";
        let t = s; updateTimer(t); clearInterval(tInt);
        tInt = setInterval(()=>{ t--; updateTimer(t); if(t<=3 && t>0) playBeep(440,0.1,'sine'); if(t<=0){clearInterval(tInt); playBeep(880,0.8,'square'); closeTimer();} }, 1000);
    }
    function updateTimer(s) { document.getElementById('timer-display').innerText = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
    function closeTimer() { document.getElementById('timer-overlay').style.height='0'; clearInterval(tInt); }
    function addTime(s) { startTimer(30); }
    function playBeep(f,d,t) { const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=t; o.frequency.value=f; o.connect(g); g.connect(audioCtx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.00001,audioCtx.currentTime+d); o.stop(audioCtx.currentTime+d); }
</script>
</body>
</html>
