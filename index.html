<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Nimble Shred v25.0</title>
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiTmltYmxlIFNocmVkIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxMjEyMTIiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzFlMWUxZSIsImljb25zIjpbeyJzcmMiOiJodHRwczovL2ltZy5pY29uczguY29tL2ZsdWVuY3kvOTYvbnVsbC9kdW1iYmVsbC5wbmciLCJzaXplcyI6Ijk2eDk2IiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/null/dumbbell.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --primary: #BB86FC; --sec: #03DAC6; --text: #fff; --gold: #FFD700; --danger: #CF6679; --success: #00C853; --warn: #FF9800; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; padding-bottom: 120px; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 600px; margin: 0 auto; display: none; padding-bottom: 50px; } 
        .container.active { display: block; }
        h1, h2 { text-align: center; margin: 10px 0; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; display: flex; justify-content: space-around; padding: 15px 10px; border-top: 1px solid #333; z-index: 9999; padding-bottom: max(15px, env(safe-area-inset-bottom)); box-shadow: 0 -5px 10px rgba(0,0,0,0.5); }
        .nav-btn { background: none; color: #777; border: none; font-size: 0.75em; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .nav-btn.active { color: var(--sec); }
        .nav-icon { font-size: 1.5em; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); position: relative; }
        .btn { display: block; width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-main { background: var(--sec); color: #000; }
        .btn-action { background: var(--primary); color: #000; }
        .btn-danger { background: var(--danger); color: #fff; }
        input, select, textarea { width: 100%; padding: 10px; background: #2c2c2c; border: 1px solid #444; border-radius: 6px; color: #fff; font-size: 16px; box-sizing: border-box; }
        .row { display: flex; gap: 10px; align-items: center; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .unit-toggle { background: #333; padding: 5px 12px; border-radius: 20px; font-size: 0.8em; border: 1px solid #555; color: #aaa; cursor: pointer; }
        .exercise-card { border-left: 4px solid var(--primary); margin-bottom: 15px; }
        .exercise-card.Mobility { border-left-color: var(--sec); }
        .exercise-card.Strength { border-left-color: var(--danger); }
        .exercise-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .suggestion-text { color: var(--success); font-size: 0.85em; margin: 5px 0; font-style: italic; display: flex; align-items: center; gap: 5px; }
        .pr-highlight { animation: prGlow 2s ease-in-out; }
        @keyframes prGlow { 0%, 100% { background: var(--card); } 50% { background: rgba(0, 200, 83, 0.2); } }
        .smart-inc { background: #333; color: #fff; border: 1px solid #555; padding: 8px 12px; border-radius: 4px; font-size: 0.8em; margin-left: 5px; cursor: pointer; }
        .mic-btn { background: #333; border: 1px solid #555; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2em; cursor: pointer; }
        .mic-btn.listening { background: var(--danger); animation: pulse 1s infinite; border: none; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(207, 102, 121, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(207, 102, 121, 0); } 100% { box-shadow: 0 0 0 0 rgba(207, 102, 121, 0); } }
        .fs-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 5000; padding: 20px; overflow-y: auto; box-sizing: border-box; display: none; }
        .fs-overlay.flex-center { display: none; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.95); }
        .hidden { display: none !important; }
        .macro-bar-container { background: #333; height: 12px; border-radius: 6px; margin-top: 5px; overflow: hidden; position: relative; }
        .macro-fill { height: 100%; transition: width 0.5s; }
        .macro-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; text-align: center; font-size: 0.85em; }
        .macro-item { position: relative; }
        .macro-percent { font-size: 0.7em; color: #aaa; margin-top: 2px; }
        .water-tracker { display: flex; justify-content: center; align-items: center; gap: 20px; margin: 15px 0; }
        .water-btn { background: var(--primary); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5em; cursor: pointer; border: none; color: #000; }
        .water-display { font-size: 2em; font-weight: bold; color: var(--sec); }
        .badge-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .badge { min-width: 60px; height: 60px; background: #252525; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5em; opacity: 0.3; border: 2px solid #444; }
        .badge.unlocked { opacity: 1; border-color: var(--gold); box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        .template-tag { background: #333; padding: 8px 12px; border-radius: 8px; font-size: 0.9em; border: 1px solid #555; cursor: pointer; white-space: nowrap; }
        .template-scroll { display: flex; gap: 10px; overflow-x: auto; margin: 10px 0; padding-bottom: 5px; }
        .instruction-box { background: #252525; padding: 10px; border-radius: 5px; margin-top: 10px; margin-bottom: 10px; font-size: 0.9em; color: #ddd; border-left: 2px solid #777; display: none; line-height: 1.4; }
        .instruction-box.visible { display: block; }
        .gif-input { width: 100%; padding: 5px; background: #111; border: 1px solid #444; color: #fff; border-radius: 4px; margin-top: 5px; margin-bottom: 5px; font-size: 0.8em; }
        .btn-sm { padding: 5px 10px; font-size: 0.8em; width: auto; display: inline-block; margin-top: 5px; }
        .btn-guide { background: #333; color: #aaa; border: 1px solid #444; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; cursor: pointer; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 6000; }
        .modal-content { background: var(--card); padding: 20px; border-radius: 10px; width: 95%; max-width: 500px; text-align: center; position: relative; }
        .close-modal { position: absolute; top: 10px; right: 15px; color: #fff; font-size: 24px; cursor: pointer; }
        .goal-setter { display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
        .goal-input { flex: 1; min-width: 60px; }
        .timer-badge { position: fixed; bottom: 80px; right: 20px; background: var(--danger); color: #fff; padding: 15px; border-radius: 50%; width: 60px; height: 60px; display: none; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; box-shadow: 0 4px 8px rgba(0,0,0,0.5); z-index: 4000; cursor: pointer; }
        .timer-badge.active { display: flex; animation: timerPulse 1s infinite; }
        @keyframes timerPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    </style>
</head>
<body>

<div id="timer-badge" class="timer-badge" onclick="openTimerOverlay()"></div>

<div class="container active" id="view-readiness">
    <div class="top-bar"><h2>Daily Check-In</h2><button class="unit-toggle" onclick="toggleUnit()"><span id="unit-disp-1">LBS</span></button></div>
    <div class="card" style="display:flex; justify-content:space-between; align-items:center; background: linear-gradient(45deg, #1e1e1e, #252525);">
        <div><div style="font-size:0.8em; color:#aaa;">Current Streak</div><div style="font-size:1.5em; font-weight:bold;">üî• <span id="streak-count">0</span> Days</div></div>
        <div id="readiness-badge" style="font-size:2em;">üõ°Ô∏è</div>
    </div>
    <div class="card">
        <h3>How are you feeling?</h3>
        <div class="row" style="margin-top:10px;"><span>üò¥ Sleep</span> <input type="range" id="val-sleep" min="1" max="10" value="5" oninput="calcReadiness()"></div>
        <div class="row" style="margin-top:15px;"><span>ü§ï Pain</span> <input type="range" id="val-sore" min="1" max="10" value="5" oninput="calcReadiness()"></div>
        <div class="row" style="margin-top:15px;"><span>‚ö° Energy</span> <input type="range" id="val-mood" min="1" max="10" value="5" oninput="calcReadiness()"></div>
        <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
        <div class="row"><input type="number" id="garmin-score" placeholder="Garmin Body Battery (Optional)" oninput="calcReadiness()"></div>
        <div style="text-align:center; margin-top:15px;"><div style="font-size:2.5em; font-weight:bold; color:var(--sec);" id="score-display">--</div><div style="color:#aaa; font-style:italic;" id="score-text">Move sliders to calculate</div></div>
<button class="btn btn-main" onclick="saveReadiness()" style="margin-top:15px;">üíæ Log Today's Check-In</button>
    <div style="text-align:center; margin-top:30px; opacity:0.5;">
        <small style="color:#777;">Version 25.0 - Phase 1</small><br>
        <button class="btn-danger" style="width:auto; display:inline-block; font-size:0.8em; margin-top:5px;" onclick="factoryReset()">‚ö†Ô∏è Reset App</button>
    </div>
</div>

<div class="container" id="view-coach">
    <div id="setup-panel">
        <div class="top-bar"><h2>Workout Strategy</h2><button class="unit-toggle" onclick="toggleUnit()"><span id="unit-disp-2">LBS</span></button></div>
        <div class="card">
            <h3>Quick Templates</h3>
            <div class="template-scroll">
                <div class="template-tag" onclick="loadTemplate('push')">Push Day</div>
                <div class="template-tag" onclick="loadTemplate('pull')">Pull Day</div>
                <div class="template-tag" onclick="loadTemplate('legs')">Leg Day</div>
                <div class="template-tag" onclick="loadTemplate('full')">Full Body</div>
                <div class="template-tag" onclick="loadTemplate('bw')">Calisthenics</div>
                <div class="template-tag" onclick="loadTemplate('core')">Core/Mobility</div>
            </div>
        </div>
        <div class="card">
            <h3>Custom Generator</h3>
            <label>Split Focus</label>
            <select id="split-selector">
                <option value="full">Full Body Random</option>
                <option value="push">Push (Chest/Shoulders/Tri)</option>
                <option value="pull">Pull (Back/Bi/Traps)</option>
                <option value="legs">Legs</option>
                <option value="core">Core & Mobility</option>
            </select>
            <button class="btn btn-main" onclick="generateWorkout()">üé≤ Generate Workout</button>
            <button class="btn btn-action" onclick="openBuilder()">üõ†Ô∏è Build Custom</button>
        </div>
    </div>
    <div id="active-workout" class="hidden">
        <div class="top-bar"><h3>Active Session</h3><button class="btn-danger" style="width:auto; padding:5px 10px;" onclick="cancelWorkout()">End</button></div>
        <div id="workout-list"></div>
        <button class="btn btn-action" onclick="openBuilder(true)">‚ûï Add Exercise</button>
        <button class="btn btn-main" onclick="finishSession()">üíæ Finish & Save</button>
    </div>
</div>

<div class="container" id="view-food">
    <div class="top-bar"><h2>Fuel Log</h2><button class="unit-toggle" onclick="toggleApiSettings()">‚öôÔ∏è API</button></div>
    <div id="api-settings" class="card hidden">
        <label>USDA API Key (Optional)</label><input type="text" id="usda-key" placeholder="Paste Key Here">
        <button class="btn btn-action" onclick="saveApiKey()">Save Key</button>
        <p style="font-size:0.8em; color:#aaa; margin-top:5px;">Get key at: fdc.nal.usda.gov</p>
    </div>
    
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0;">Daily Goals</h3>
            <button class="btn-guide" onclick="toggleGoalSetter()">‚öôÔ∏è Set</button>
        </div>
        <div id="goal-setter" class="goal-setter hidden">
            <input type="number" class="goal-input" id="goal-cals" placeholder="Cals">
            <input type="number" class="goal-input" id="goal-pro" placeholder="Protein">
            <input type="number" class="goal-input" id="goal-carb" placeholder="Carbs">
            <input type="number" class="goal-input" id="goal-fat" placeholder="Fat">
            <button class="btn-action" style="width: 100%; margin-top: 5px;" onclick="saveGoals()">Save Goals</button>
        </div>
        <div class="macro-grid">
            <div class="macro-item">
                üî• <span id="disp-cals">0</span>/<span id="goal-cals-disp">2000</span>
                <div class="macro-bar-container">
                    <div id="bar-cals" class="macro-fill" style="width:0%; background:var(--sec);"></div>
                </div>
                <div class="macro-percent" id="percent-cals">0%</div>
            </div>
            <div class="macro-item">
                ü•© <span id="disp-pro">0</span>/<span id="goal-pro-disp">150</span>g
                <div class="macro-bar-container">
                    <div id="bar-pro" class="macro-fill" style="width:0%; background:var(--primary);"></div>
                </div>
                <div class="macro-percent" id="percent-pro">0%</div>
            </div>
            <div class="macro-item">
                üçö <span id="disp-carb">0</span>/<span id="goal-carb-disp">200</span>g
                <div class="macro-bar-container">
                    <div id="bar-carb" class="macro-fill" style="width:0%; background:var(--warn);"></div>
                </div>
                <div class="macro-percent" id="percent-carb">0%</div>
            </div>
            <div class="macro-item">
                ü•ë <span id="disp-fat">0</span>/<span id="goal-fat-disp">60</span>g
                <div class="macro-bar-container">
                    <div id="bar-fat" class="macro-fill" style="width:0%; background:var(--danger);"></div>
                </div>
                <div class="macro-percent" id="percent-fat">0%</div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <h3>üíß Water Intake</h3>
        <div class="water-tracker">
            <button class="water-btn" onclick="updateWater(-1)">‚ûñ</button>
            <div class="water-display"><span id="water-count">0</span> üíß</div>
            <button class="water-btn" onclick="updateWater(1)">‚ûï</button>
        </div>
        <div style="text-align: center; color: #aaa; font-size: 0.8em;">Target: 8 cups/day</div>
    </div>
    
    <div class="card">
        <div class="row"><input type="text" id="food-search" placeholder="Search USDA or Local DB..."><button class="btn-action" style="width:auto;" onclick="searchFood()">üîé</button></div>
        <div id="search-results" style="margin-top:10px; max-height:200px; overflow-y:auto;"></div>
    </div>
    <div class="card">
        <h3>Manual Quick Add</h3>
        <div class="row"><input type="number" id="inp-cals" placeholder="Cals"><input type="number" id="inp-pro" placeholder="Prot"><input type="number" id="inp-carb" placeholder="Carb"><input type="number" id="inp-fat" placeholder="Fat"></div>
        <button class="btn btn-main" onclick="logMacroManual()">‚ûï Add Log</button>
    </div>
</div>

<div class="container" id="view-wellness">
    <h2>Wellness & Recovery</h2>
    <div class="card"><h3>‚öñÔ∏è Body Stats</h3><div class="row"><input type="number" id="body-weight" placeholder="Bodyweight"><button class="btn-action" onclick="saveBodyStat()">Log</button></div></div>
    <div class="card"><h3>ü§ï Injury / Pain</h3><textarea id="pain-log" style="width:100%; background:#2c2c2c; color:#fff; border:1px solid #444; border-radius:5px;" rows="3" placeholder="Notes on pain..."></textarea><button class="btn-action" style="margin-top:5px;" onclick="savePainLog()">Save Note</button></div>
</div>

<div class="container" id="view-progress">
    <h2>Stats & Trophies</h2>
    <div class="card"><h3>üèÜ Trophy Case</h3><div class="badge-grid" id="trophy-case"></div></div>
    <div class="card"><select id="chart-select" onchange="renderChart()"><option>Select Exercise...</option></select><canvas id="progressChart"></canvas></div>
    <button class="btn btn-action" onclick="exportData()">‚¨áÔ∏è Export Data</button>
</div>

<div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('readiness')" id="nav-readiness"><span class="nav-icon">üîã</span>Daily</button>
    <button class="nav-btn" onclick="switchTab('coach')" id="nav-coach"><span class="nav-icon">üèãÔ∏è</span>Coach</button>
    <button class="nav-btn" onclick="switchTab('food')" id="nav-food"><span class="nav-icon">üçó</span>Fuel</button>
    <button class="nav-btn" onclick="switchTab('wellness')" id="nav-wellness"><span class="nav-icon">üßò</span>Wellness</button>
    <button class="nav-btn" onclick="switchTab('progress')" id="nav-progress"><span class="nav-icon">üìà</span>Stats</button>
</div>

<div id="builder-overlay" class="fs-overlay hidden">
    <div class="top-bar"><h2>Exercise Builder</h2><button class="btn-danger" style="width:auto;" onclick="closeBuilder()">Close</button></div>
    <div class="card">
        <input type="text" id="builder-search-inp" placeholder="Search..." onkeyup="filterBuilder()">
        <div id="builder-list-content" style="margin-top:10px;"></div>
    </div>
</div>

<div id="gif-modal" class="fs-overlay flex-center hidden">
    <h3 id="gif-modal-title" style="color:#fff;">Technique</h3>
    <img id="gif-player" src="" style="max-width:90%; border-radius:10px;">
    <button class="btn-danger" style="width:auto; margin-top:20px;" onclick="closeGifModal()">Close</button>
</div>

<div id="timer-overlay" class="fs-overlay flex-center hidden">
    <div id="timer-display" style="font-size:4em; font-weight:bold; color:var(--primary);">00:00</div>
    <div style="margin-top:20px;">
        <button class="btn-danger" onclick="closeTimer()">Stop</button>
        <button class="btn-action" onclick="addTime(10)">+10s</button>
        <button class="btn-action" onclick="addTime(30)">+30s</button>
    </div>
</div>
<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/a/macros/tjkcivil.com.au/s/AKfycbwG0PbAwqkX3EbWki7vjewgP-FIwCt11_ybFsFJrYmmgq6_QpfKrbPfRxeSEJGu7Ovg/exec"; 
    let state = { unit: 'lbs', history: [], food: [], wellness: [], readiness: [], goals: {cals: 2000, pro: 150, carb: 200, fat: 60} };
    let apiKey = "";
    let activeRoutine = [];
    let gifOverrides = {};
    let myChart = null;
    let timerInterval = null;
    let timerSeconds = 0;
    let autoTimerEnabled = true;

    const allExercises = [
      {"name": "Low Cable Chest Fly", "categories": ["Chest", "Shoulders"], "type": "Muscle Build", "desc": "Set pulleys low. Scoop hands up."},
      {"name": "High Cable Chest Fly", "categories": ["Chest"], "type": "Muscle Build", "desc": "Set pulleys high. Press hands down."},
      {"name": "Cable Lateral Raise", "categories": ["Shoulders"], "type": "Muscle Build", "desc": "Raise arm to side."},
      {"name": "Face Pulls", "categories": ["Shoulders", "Back", "Mobility"], "type": "Mobility", "desc": "Pull to forehead."},
      {"name": "Lat Pulldown", "categories": ["Back", "Biceps"], "type": "Strength", "desc": "Drive elbows down."},
      {"name": "Seated Row", "categories": ["Back", "Biceps"], "type": "Strength", "desc": "Pull to stomach."},
      {"name": "Tricep Pushdown", "categories": ["Triceps"], "type": "Muscle Build", "desc": "Elbows pinned. Push down."},
      {"name": "Bicep Cable Curl", "categories": ["Biceps"], "type": "Muscle Build", "desc": "Elbows pinned. Curl up."},
      {"name": "Cable Crunch", "categories": ["Abs", "Core"], "type": "Muscle Build", "desc": "Kneel. Curl down."},
      {"name": "Cable Pull-through", "categories": ["Glutes", "Hamstrings"], "type": "Muscle Build", "desc": "Face away. Hinge back."},
      {"name": "Dumbbell Chest Press", "categories": ["Chest", "Triceps"], "type": "Strength", "desc": "Press weights over chest."},
      {"name": "Dumbbell Shoulder Press", "categories": ["Shoulders", "Triceps"], "type": "Strength", "desc": "Press overhead."},
      {"name": "Goblet Squat", "categories": ["Legs", "Glutes"], "type": "Strength", "desc": "Hold weight at chest. Squat."},
      {"name": "Romanian Deadlift", "categories": ["Hamstrings", "Glutes", "Back"], "type": "Strength", "desc": "Hinge hips back."},
      {"name": "Dumbbell Rows", "categories": ["Back", "Biceps"], "type": "Strength", "desc": "Pull to hip pocket."},
      {"name": "Lateral Raises", "categories": ["Shoulders"], "type": "Muscle Build", "desc": "Lift to side."},
      {"name": "Bulgarian Split Squat", "categories": ["Legs", "Glutes"], "type": "Strength", "desc": "Back foot up. Drive up."},
      {"name": "Push-ups", "categories": ["Chest", "Triceps", "Core"], "type": "Calisthenics", "desc": "Chest to floor."},
      {"name": "Pull-ups", "categories": ["Back", "Biceps"], "type": "Calisthenics", "desc": "Chin over bar."},
      {"name": "Dips", "categories": ["Chest", "Triceps", "Shoulders"], "type": "Calisthenics", "desc": "Lower until shoulders below elbows."},
      {"name": "Bodyweight Squats", "categories": ["Legs"], "type": "Calisthenics", "desc": "Hips back and down."},
      {"name": "Planks", "categories": ["Core", "Abs"], "type": "Calisthenics", "desc": "Hold tight.", "isTimed": true, "duration": 60},
      {"name": "Burpees", "categories": ["Full Body", "Cardio"], "type": "Calisthenics", "desc": "Chest to floor, jump."},
      {"name": "Mountain Climbers", "categories": ["Core", "Cardio"], "type": "Calisthenics", "desc": "Knees to chest.", "isTimed": true, "duration": 45},
      {"name": "Barbell Squat", "categories": ["Legs", "Glutes"], "type": "Strength", "desc": "Bar on back. Squat deep."},
      {"name": "Barbell Bench Press", "categories": ["Chest", "Triceps"], "type": "Strength", "desc": "Bar to chest. Press."},
      {"name": "Barbell Deadlift", "categories": ["Back", "Hamstrings"], "type": "Strength", "desc": "Lift from floor."},
      {"name": "Overhead Press", "categories": ["Shoulders", "Triceps"], "type": "Strength", "desc": "Press bar overhead."},
      {"name": "Hanging Leg Raises", "categories": ["Core", "Abs"], "type": "Calisthenics", "desc": "Lift legs to 90."},
      {"name": "Nordic Curls", "categories": ["Hamstrings"], "type": "Calisthenics", "desc": "Lower forward slowly."},
      {"name": "Pike Push-ups", "categories": ["Shoulders"], "type": "Calisthenics", "desc": "Hips high push up."},
      {"name": "Kettlebell Swing", "categories": ["Glutes", "Hamstrings"], "type": "Strength", "desc": "Hinge snap."},
      {"name": "Farmers Walk", "categories": ["Core", "Traps"], "type": "Strength", "desc": "Walk heavy.", "isTimed": true, "duration": 60},
      {"name": "Dumbbell Lunges", "categories": ["Legs", "Glutes"], "type": "Strength", "desc": "Step forward."},
      {"name": "Bicep Curls", "categories": ["Biceps"], "type": "Muscle Build", "desc": "Curl to shoulder."},
      {"name": "Tricep Kickbacks", "categories": ["Triceps"], "type": "Muscle Build", "desc": "Kick back."},
      {"name": "Hammer Curls", "categories": ["Biceps", "Forearms"], "type": "Muscle Build", "desc": "Neutral grip."},
      {"name": "Arnold Press", "categories": ["Shoulders", "Triceps"], "type": "Strength", "desc": "Rotate palms out."},
      {"name": "Chin-ups", "categories": ["Back", "Biceps"], "type": "Calisthenics", "desc": "Palms facing you."}
    ];

    const internalFoodDB = [
        {name:"Chicken Breast", c:165, p:31, f:3.6, ch:0}, 
        {name:"Rice (Cup)", c:200, p:4, f:0.4, ch:44},
        {name:"Egg", c:70, p:6, f:5, ch:0}, 
        {name:"Whey Scoop", c:120, p:24, f:1, ch:3},
        {name:"Banana", c:105, p:1, f:0, ch:27}, 
        {name:"Oats (Cup)", c:300, p:10, f:5, ch:50},
        {name:"Avocado", c:160, p:2, f:15, ch:9}, 
        {name:"Salmon", c:208, p:20, f:13, ch:0}
    ];

    window.onload = () => {
        try {
            loadLocal();
            updateStreak();
            renderBadges();
            updateMacrosUI();
            loadGoals();
            
            state.unit = localStorage.getItem('nimbleUnit') || 'lbs';
            document.getElementById('unit-disp-1').innerText = state.unit.toUpperCase();
            document.getElementById('unit-disp-2').innerText = state.unit.toUpperCase();
            
            apiKey = localStorage.getItem('usdaKey') || "";
            gifOverrides = JSON.parse(localStorage.getItem('nimbleGifOverrides')) || {};
            
            switchTab('readiness'); 
            populateChartSelect();
        } catch (e) {
            console.error(e);
            alert("Recovering from crash...");
            factoryReset();
        }
    };

    function loadLocal() {
        state.history = safeParse('nimbleHistory') || [];
        state.food = safeParse('nimbleNutrition') || [];
        state.wellness = safeParse('nimbleWellness') || [];
        state.readiness = safeParse('nimbleReadiness') || [];
        state.goals = safeParse('nimbleGoals') || {cals: 2000, pro: 150, carb: 200, fat: 60};
    }
    
    function safeParse(key) {
        try { return JSON.parse(localStorage.getItem(key)); } 
        catch (e) { return null; }
    }

    function factoryReset() {
        if(confirm("This will fix crashes but wipe your saved data. Continue?")) {
            localStorage.clear();
            location.reload();
        }
    }

    function switchTab(id) {
        document.querySelectorAll('.container').forEach(d => {
            d.classList.remove('active');
            d.style.display = "none";
        });
        
        const target = document.getElementById('view-' + id);
        target.classList.add('active');
        target.style.display = "block";
        
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('nav-' + id).classList.add('active');
        
        if(id==='progress') renderChart();
        if(id==='food') updateMacrosUI();
    }

    function toggleUnit() {
        state.unit = state.unit === 'lbs' ? 'kg' : 'lbs';
        localStorage.setItem('nimbleUnit', state.unit);
        document.getElementById('unit-disp-1').innerText = state.unit.toUpperCase();
        document.getElementById('unit-disp-2').innerText = state.unit.toUpperCase();
    }

    function calcReadiness() {
        const g = document.getElementById('garmin-score').value;
        let score = g ? parseInt(g) : Math.round((parseInt(document.getElementById('val-sleep').value)*10 + parseInt(document.getElementById('val-mood').value)*10 + (10-parseInt(document.getElementById('val-sore').value))*10)/3);
        const el = document.getElementById('score-display');
        el.innerText = score + '%';
        el.style.color = score > 80 ? 'var(--success)' : (score > 50 ? 'var(--warn)' : 'var(--danger)');
        document.getElementById('score-text').innerText = score > 80 ? "Go for a PR!" : "Listen to your body";
        localStorage.setItem('nimbleReadiness', JSON.stringify({date: new Date().toDateString(), score: score}));
    }
    
function saveReadiness() {
    const g = document.getElementById('garmin-score').value;
    let score = g ? parseInt(g) : Math.round((parseInt(document.getElementById('val-sleep').value)*10 + parseInt(document.getElementById('val-mood').value)*10 + (10-parseInt(document.getElementById('val-sore').value))*10)/3);
    
    const entry = {
        date: new Date().toISOString(),
        score: score,
        sleep: parseInt(document.getElementById('val-sleep').value),
        pain: parseInt(document.getElementById('val-sore').value),
        energy: parseInt(document.getElementById('val-mood').value),
        garmin: g || null
    };
    
    let logs = JSON.parse(localStorage.getItem('nimbleReadiness')) || [];
    logs.push(entry);
    localStorage.setItem('nimbleReadiness', JSON.stringify(logs));
    sendToCloud('readiness', entry);
    alert('‚úÖ Check-in logged!');
}
    function updateStreak() {
        let sCount = parseInt(localStorage.getItem('streakCount')) || 0;
        document.getElementById('streak-count').innerText = sCount;
    }

    function renderBadges() {
        const container = document.getElementById('trophy-case');
        container.innerHTML = '';
        const badges = [
            {id: 'first', icon: 'ü•á', name: 'First Step', check: () => state.history.length > 0},
            {id: 'hundo', icon: 'üíØ', name: '100 Club', check: () => state.history.length > 100}
        ];
        badges.forEach(b => {
            const div = document.createElement('div');
            div.className = `badge ${b.check() ? 'unlocked' : ''}`;
            div.innerText = b.icon;
            container.appendChild(div);
        });
    }

    function toggleGoalSetter() {
        document.getElementById('goal-setter').classList.toggle('hidden');
    }

    function loadGoals() {
        const goals = state.goals;
        document.getElementById('goal-cals').value = goals.cals;
        document.getElementById('goal-pro').value = goals.pro;
        document.getElementById('goal-carb').value = goals.carb;
        document.getElementById('goal-fat').value = goals.fat;
        
        document.getElementById('goal-cals-disp').innerText = goals.cals;
        document.getElementById('goal-pro-disp').innerText = goals.pro;
        document.getElementById('goal-carb-disp').innerText = goals.carb;
        document.getElementById('goal-fat-disp').innerText = goals.fat;
    }

    function saveGoals() {
        state.goals = {
            cals: parseInt(document.getElementById('goal-cals').value) || 2000,
            pro: parseInt(document.getElementById('goal-pro').value) || 150,
            carb: parseInt(document.getElementById('goal-carb').value) || 200,
            fat: parseInt(document.getElementById('goal-fat').value) || 60
        };
        localStorage.setItem('nimbleGoals', JSON.stringify(state.goals));
        loadGoals();
        updateMacrosUI();
        toggleGoalSetter();
        alert('Goals saved!');
    }
    function toggleApiSettings() { 
        document.getElementById('api-settings').classList.toggle('hidden'); 
    }
    
    function saveApiKey() { 
        apiKey = document.getElementById('usda-key').value; 
        localStorage.setItem('usdaKey', apiKey); 
        toggleApiSettings(); 
        alert('API Key saved!');
    }

    async function searchFood() {
        const query = document.getElementById('food-search').value;
        if(!query) return;
        
        const resDiv = document.getElementById('search-results');
        resDiv.innerHTML = 'Searching...';
        let results = [...internalFoodDB.filter(f => f.name.toLowerCase().includes(query.toLowerCase()))];
        
        if (apiKey) {
            try {
                const req = await fetch(`https://api.nal.usda.gov/fdc/v1/foods/search?query=${query}&pageSize=5&api_key=${apiKey}`);
                const data = await req.json();
                if(data.foods) {
                    data.foods.forEach(f => {
                        const getNut = (nutName) => {
                            const nutrient = f.foodNutrients.find(n => n.nutrientName === nutName);
                            return nutrient ? nutrient.value : 0;
                        };
                        results.push({ 
                            name: f.description, 
                            c: Math.round(getNut('Energy')), 
                            p: Math.round(getNut('Protein')), 
                            f: Math.round(getNut('Total lipid (fat)')), 
                            ch: Math.round(getNut('Carbohydrate, by difference')) 
                        });
                    });
                }
            } catch(e) {
                console.error('USDA API Error:', e);
            }
        }
        
        resDiv.innerHTML = '';
        if(results.length === 0) {
            resDiv.innerHTML = '<div style="padding:10px; color:#aaa;">No results found</div>';
            return;
        }
        
        results.forEach(f => {
            const div = document.createElement('div');
            div.style.padding = "10px"; 
            div.style.borderBottom = "1px solid #333";
            div.style.cursor = "pointer";
            div.innerHTML = `<b>${f.name}</b> <br> <small>${f.c} cal | ${f.p}p | ${f.ch}c | ${f.f}f</small>`;
            div.onclick = () => addFoodLog(f);
            resDiv.appendChild(div);
        });
    }

    function addFoodLog(food) {
        const log = { date: new Date().toLocaleDateString(), ...food };
        let cl = JSON.parse(localStorage.getItem('nimbleNutrition')) || [];
        cl.push(log);
        localStorage.setItem('nimbleNutrition', JSON.stringify(cl));
        sendToCloud('nutrition', log);
        updateMacrosUI();
        document.getElementById('search-results').innerHTML = '<div style="color:var(--success); padding:10px;">‚úÖ Added!</div>';
        setTimeout(() => document.getElementById('search-results').innerHTML = '', 2000);
    }

    function updateMacrosUI() {
        const today = new Date().toLocaleDateString();
        const logs = JSON.parse(localStorage.getItem('nimbleNutrition')) || [];
        const t = logs.filter(l => l.date === today).reduce((acc, l) => ({ 
            c: acc.c+(l.c||0), 
            p: acc.p+(l.p||0), 
            f: acc.f+(l.f||0), 
            ch: acc.ch+(l.ch||0) 
        }), {c:0, p:0, f:0, ch:0});
        
        const goals = state.goals;
        
        document.getElementById('disp-cals').innerText = Math.round(t.c);
        document.getElementById('disp-pro').innerText = Math.round(t.p);
        document.getElementById('disp-carb').innerText = Math.round(t.ch);
        document.getElementById('disp-fat').innerText = Math.round(t.f);
        
        const calcPercent = (val, goal) => Math.round((val / goal) * 100);
        document.getElementById('percent-cals').innerText = calcPercent(t.c, goals.cals) + '%';
        document.getElementById('percent-pro').innerText = calcPercent(t.p, goals.pro) + '%';
        document.getElementById('percent-carb').innerText = calcPercent(t.ch, goals.carb) + '%';
        document.getElementById('percent-fat').innerText = calcPercent(t.f, goals.fat) + '%';
        
        document.getElementById('bar-cals').style.width = Math.min(100, calcPercent(t.c, goals.cals)) + '%';
        document.getElementById('bar-pro').style.width = Math.min(100, calcPercent(t.p, goals.pro)) + '%';
        document.getElementById('bar-carb').style.width = Math.min(100, calcPercent(t.ch, goals.carb)) + '%';
        document.getElementById('bar-fat').style.width = Math.min(100, calcPercent(t.f, goals.fat)) + '%';
        
        const waterCount = parseInt(localStorage.getItem('nimbleWater')) || 0;
        document.getElementById('water-count').innerText = waterCount;
    }

    function logMacroManual() {
        const f = { 
            name: "Manual", 
            c: parseFloat(document.getElementById('inp-cals').value)||0, 
            p: parseFloat(document.getElementById('inp-pro').value)||0, 
            ch: parseFloat(document.getElementById('inp-carb').value)||0, 
            f: parseFloat(document.getElementById('inp-fat').value)||0 
        };
        addFoodLog(f);
        document.getElementById('inp-cals').value = '';
        document.getElementById('inp-pro').value = '';
        document.getElementById('inp-carb').value = '';
        document.getElementById('inp-fat').value = '';
    }

    function updateWater(c) {
        let w = parseInt(localStorage.getItem('nimbleWater') || 0) + c;
        if(w<0) w=0;
        localStorage.setItem('nimbleWater', w);
        document.getElementById('water-count').innerText = w;
    }
    function loadTemplate(type) {
        let filter = [];
        if(type==='push') filter = ['Chest','Shoulders','Triceps'];
        if(type==='pull') filter = ['Back','Biceps'];
        if(type==='legs') filter = ['Legs'];
        if(type==='full') filter = ['Chest','Back','Legs'];
        if(type==='bw') return generateWorkoutByFilter(e => e.type === 'Calisthenics');
        if(type==='core') filter = ['Core','Mobility'];
        generateWorkoutByFilter(e => e.categories.some(c => filter.includes(c)));
    }

    function generateWorkout() {
        const split = document.getElementById('split-selector').value;
        loadTemplate(split);
    }

    function generateWorkoutByFilter(filterFn) {
        const pool = allExercises.filter(filterFn);
        activeRoutine = pool.sort(() => 0.5 - Math.random()).slice(0, 6);
        renderWorkout(activeRoutine);
        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('setup-panel').style.display = 'none';
        document.getElementById('active-workout').classList.remove('hidden');
        document.getElementById('active-workout').style.display = 'block';
    }

    function renderWorkout(exercises) {
        const list = document.getElementById('workout-list');
        list.innerHTML = '';
        const history = JSON.parse(localStorage.getItem('nimbleHistory')) || [];

        exercises.forEach((ex, i) => {
            const lastLog = history.filter(h => h.name === ex.name).sort((a,b) => new Date(b.date) - new Date(a.date))[0];
            const suggestion = lastLog ? `Beat: ${lastLog.weight}${lastLog.unit} x ${lastLog.reps}` : "New Exercise";
            const val = lastLog ? lastLog.weight : "";
            
            const hasGif = gifOverrides[ex.name];
            const searchUrl = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(ex.name + ' exercise form gif')}`;
            const uniqueId = `desc-${i}`;
            let demoBtn = `<a href="${searchUrl}" target="_blank" class="btn-guide">üé• Find GIF</a>`;
           if(hasGif) {
    const escapedName = ex.name.replace(/'/g, "\\'");
    demoBtn = `<span class="btn-guide" style="color:var(--sec); border-color:var(--sec);" onclick="showGif('${escapedName}')">üé• Watch</span>`;
}

            const div = document.createElement('div');
            div.className = `card exercise-card ${ex.type}`;
            div.id = `exercise-${i}`;
            div.innerHTML = `
                <div class="exercise-header">
                    <strong>${ex.name}</strong>
                    <div style="display:flex; gap:5px;">
                        <span class="btn-guide" onclick="document.getElementById('${uniqueId}').classList.toggle('visible')">üìù Guide</span>
                        ${demoBtn}
                        <div class="mic-btn" onclick="startVoiceLog(this, ${i})">üé§</div>
                    </div>
                </div>
                
                <div id="${uniqueId}" class="instruction-box">
                    ${ex.desc}
                    <input type="text" id="gif-input-${i}" class="gif-input" placeholder="Paste GIF URL here..." value="${hasGif || ''}">
                    <span class="btn-sm btn-guide" onclick="saveGifOverride('${ex.name}', 'gif-input-${i}')">Save GIF</span>
                </div>

                <div class="suggestion-text">üí° ${suggestion}</div>
                <div class="row" style="margin-top:10px;">
                    <div style="flex:1">
                        <div class="row" style="gap:2px;">
                            <input type="number" id="w-${i}" value="${val}" placeholder="Wt" step="0.5">
                            <button class="smart-inc" onclick="incVal('w-${i}', 2.5)">+2.5</button>
                            <button class="smart-inc" onclick="incVal('w-${i}', 5)">+5</button>
                        </div>
                    </div>
                    <div style="flex:1"><input type="number" id="r-${i}" placeholder="Reps"></div>
                </div>
                <button class="btn btn-action" style="margin-top:10px; padding:8px;" onclick="logSet('${ex.name}', ${i})">‚úÖ Log Set</button>
            `;
            list.appendChild(div);
        });
    }

    function incVal(id, amount) {
        const el = document.getElementById(id);
        el.value = (parseFloat(el.value)||0) + amount;
    }

    function logSet(name, idx) {
        const w = document.getElementById(`w-${idx}`).value;
        const r = document.getElementById(`r-${idx}`).value;
        if(!w || !r) return alert('Enter weight and reps!');
        
        const entry = { date: new Date().toISOString(), name: name, weight: parseFloat(w), reps: parseFloat(r), unit: state.unit };
        let h = JSON.parse(localStorage.getItem('nimbleHistory')) || [];
        
        const lastLog = h.filter(log => log.name === name).sort((a,b) => new Date(b.date) - new Date(a.date))[0];
        if(lastLog && parseFloat(w) > lastLog.weight) {
            const card = document.getElementById(`exercise-${idx}`);
            card.classList.add('pr-highlight');
            setTimeout(() => card.classList.remove('pr-highlight'), 2000);
        }
        
        h.push(entry);
        localStorage.setItem('nimbleHistory', JSON.stringify(h));
        sendToCloud("workout", entry);
        document.getElementById(`r-${idx}`).style.border = "2px solid var(--success)";
        
        if(autoTimerEnabled) startTimer(90);
    }

    function finishSession() {
        if(confirm("Finish & Save?")) {
            document.getElementById('active-workout').classList.add('hidden');
            document.getElementById('active-workout').style.display='none';
            document.getElementById('setup-panel').classList.remove('hidden');
            document.getElementById('setup-panel').style.display='block';
            
            let streak = parseInt(localStorage.getItem('streakCount')) || 0;
            streak++;
            localStorage.setItem('streakCount', streak);
            updateStreak();
            
            alert("üî• Workout Saved! Streak: " + streak + " days!");
        }
    }

    function cancelWorkout() {
        if(confirm("Discard Session?")) {
            document.getElementById('active-workout').classList.add('hidden');
            document.getElementById('active-workout').style.display='none';
            document.getElementById('setup-panel').classList.remove('hidden');
            document.getElementById('setup-panel').style.display='block';
        }
    }

    function startVoiceLog(btn, idx) {
        if (!('webkitSpeechRecognition' in window)) return alert("Browser not supported. Use Chrome.");
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'en-US';
        btn.classList.add('listening');
        recognition.onresult = function(event) {
            const text = event.results[0][0].transcript;
            const nums = text.match(/\d+(\.\d+)?/g);
            if (nums && nums.length >= 2) {
                document.getElementById(`w-${idx}`).value = nums[0];
                document.getElementById(`r-${idx}`).value = nums[1];
            }
            btn.classList.remove('listening');
        };
        recognition.onerror = () => btn.classList.remove('listening');
        recognition.onend = () => btn.classList.remove('listening');
        recognition.start();
    }

    function saveBodyStat() { 
        const weight = document.getElementById('body-weight').value;
        if(!weight) return;
        sendToCloud("wellness", {type:"weight", val: weight, date: new Date().toISOString()}); 
        alert("Weight logged!"); 
        document.getElementById('body-weight').value = '';
    }
    
    function savePainLog() { 
        const note = document.getElementById('pain-log').value;
        if(!note) return;
        sendToCloud("wellness", {type:"pain", note: note, date: new Date().toISOString()}); 
        alert("Pain log saved!"); 
        document.getElementById('pain-log').value = '';
    }

    function sendToCloud(type, data) {
        if (!GOOGLE_SCRIPT_URL) return;
        fetch(GOOGLE_SCRIPT_URL, { 
            method: "POST", 
            mode: "no-cors", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ type: type, data: data }) 
        }).catch(e=>console.log(e));
    }
    function saveGifOverride(name, inputId) {
        const url = document.getElementById(inputId).value;
        if(!url) return alert("Paste a URL first");
        gifOverrides[name] = url;
        localStorage.setItem('nimbleGifOverrides', JSON.stringify(gifOverrides));
        renderWorkout(activeRoutine);
        alert("GIF Saved!");
    }
    
   function showGif(name) {
    const url = gifOverrides[name];
    if(url) {
        document.getElementById('gif-player').src = url;
        document.getElementById('gif-modal-title').innerText = name;
        const modal = document.getElementById('gif-modal');
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        
        // Force image reload if it's cached
        const img = document.getElementById('gif-player');
        img.onload = function() {
            console.log('GIF loaded successfully');
        };
        img.onerror = function() {
            alert('Failed to load GIF. Check the URL is valid.');
        };
    } else {
        alert('No GIF saved for this exercise yet!');
    }
}
    
    function closeGifModal() { 
        document.getElementById('gif-modal').classList.add('hidden'); 
        document.getElementById('gif-modal').style.display = 'none'; 
    }

    function openBuilder(add) {
        document.getElementById('builder-overlay').classList.remove('hidden');
        document.getElementById('builder-overlay').style.display = 'block';
        const list = document.getElementById('builder-list-content');
        list.innerHTML = "";
        allExercises.forEach(ex => {
            const d = document.createElement('div');
            d.style.padding="10px"; 
            d.style.borderBottom="1px solid #333";
            d.style.cursor="pointer";
            d.innerHTML = `<b>${ex.name}</b><br><small style="color:#aaa;">${ex.type}</small>`;
            d.onclick = () => { 
                activeRoutine.push(ex);
                renderWorkout(activeRoutine); 
                closeBuilder(); 
            };
            list.appendChild(d);
        });
    }
    
    function closeBuilder() { 
        document.getElementById('builder-overlay').classList.add('hidden'); 
        document.getElementById('builder-overlay').style.display = 'none'; 
    }
    
    function filterBuilder() {
        const q = document.getElementById('builder-search-inp').value.toLowerCase();
        const items = document.getElementById('builder-list-content').children;
        Array.from(items).forEach(i => i.style.display = i.innerHTML.toLowerCase().includes(q) ? 'block' : 'none');
    }

    function startTimer(seconds) {
        timerSeconds = seconds;
        updateTimerDisplay();
        
        const badge = document.getElementById('timer-badge');
        badge.classList.add('active');
        
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timerSeconds--;
            updateTimerDisplay();
            if(timerSeconds <= 0) {
                stopTimer();
                alert("Rest complete! üí™");
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const mins = Math.floor(timerSeconds / 60);
        const secs = timerSeconds % 60;
        const display = `${mins}:${secs.toString().padStart(2, '0')}`;
        document.getElementById('timer-badge').innerText = display;
        document.getElementById('timer-display').innerText = display;
    }

    function stopTimer() {
        clearInterval(timerInterval);
        document.getElementById('timer-badge').classList.remove('active');
    }

    function closeTimer() { 
        stopTimer();
        document.getElementById('timer-overlay').classList.add('hidden'); 
        document.getElementById('timer-overlay').style.display = 'none';
    }

    function openTimerOverlay() {
        document.getElementById('timer-overlay').classList.remove('hidden');
        document.getElementById('timer-overlay').style.display = 'flex';
    }

    function addTime(seconds) {
        timerSeconds += seconds;
        updateTimerDisplay();
        if(!timerInterval) {
            startTimer(timerSeconds);
        }
    }

    function populateChartSelect() {
        const history = JSON.parse(localStorage.getItem('nimbleHistory')) || [];
        const exercises = [...new Set(history.map(h => h.name))];
        const select = document.getElementById('chart-select');
        select.innerHTML = '<option>Select Exercise...</option>';
        exercises.forEach(ex => {
            const opt = document.createElement('option');
            opt.value = ex;
            opt.innerText = ex;
            select.appendChild(opt);
        });
    }

    function renderChart() {
        const selected = document.getElementById('chart-select').value;
        if(selected === 'Select Exercise...') return;
        
        const history = JSON.parse(localStorage.getItem('nimbleHistory')) || [];
        const filtered = history.filter(h => h.name === selected).slice(-10);
        
        const labels = filtered.map(h => new Date(h.date).toLocaleDateString());
        const weights = filtered.map(h => h.weight);
        
        const ctx = document.getElementById('progressChart').getContext('2d');
        if(myChart) myChart.destroy();
        
        myChart = new Chart(ctx, { 
            type:'line', 
            data:{
                labels: labels, 
                datasets:[{
                    label: selected + ' Weight Progress', 
                    data: weights, 
                    borderColor:'#BB86FC',
                    backgroundColor: 'rgba(187, 134, 252, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        labels: {
                            color: '#fff'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#aaa' },
                        grid: { color: '#333' }
                    },
                    y: {
                        ticks: { color: '#aaa' },
                        grid: { color: '#333' }
                    }
                }
            }
        });
    }

    function exportData() {
        const data = {
            history: JSON.parse(localStorage.getItem('nimbleHistory')) || [],
            nutrition: JSON.parse(localStorage.getItem('nimbleNutrition')) || [],
            wellness: JSON.parse(localStorage.getItem('nimbleWellness')) || [],
            goals: state.goals,
            streak: localStorage.getItem('streakCount') || 0
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `nimble-shred-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }
</script>
</body>
</html>
